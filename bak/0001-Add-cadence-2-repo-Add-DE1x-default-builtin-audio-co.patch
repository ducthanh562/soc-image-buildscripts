From c7c4894d1be55c175f270b4cdb147f8af64e7805 Mon Sep 17 00:00:00 2001
From: Michael Brown <producer@holotronic.dk>
Date: Thu, 7 Jun 2018 23:08:44 +0200
Subject: [PATCH] Add cadence 2 repo, Add DE1x default builtin audio codec

Signed-off-by: Michael Brown <producer@holotronic.dk>
---
 SD-Image-Gen/build-all.sh                          |   16 +-
 SD-Image-Gen/functions/file_build-func.sh          |    5 +-
 SD-Image-Gen/functions/rootfs-func.sh              |   24 +-
 .../current/0001-disable-debug-package-gen.patch   |    4 +-
 ...002-Remove-gittag-from-kernel-file-name-s.patch |    4 +-
 ...d-ext4-root-fs-support-and-autofs4-module.patch |    4 +-
 .../0004-add-.dtd-files-to-kernel-image-.deb.patch |    4 +-
 ...e-boot-extlinux-extlinux.conf-and-boot-uE.patch |    4 +-
 ...s-and-fpgacfg-dts-entities-and-dynamic-dt.patch |    4 +-
 ...e-kernel-package-names-to-socfpga-rt-ltsi.patch |    4 +-
 .../current/0008-Enable-bridges-in-dtb-s.patch     |    4 +-
 ...009-add-spidev-in-dts-so-driver-is-loaded.patch |    4 +-
 .../current/0010-set-ACL-secutity.patch            |    4 +-
 .../current/0011-Enable-altvip-framebuffer.patch   |    4 +-
 ...-Nano-with-uio-with-without-framebuffer-1.patch |    4 +-
 ...ffer-ii-core-driver-based-on-Mister-and-e.patch |    4 +-
 ...nd-midi-drivers-for-holosynth-and-builtin.patch |    4 +-
 ...audio-driver-with-Phat-pcm5102-audio-outp.patch |    4 +-
 ...016-add-vipii-framebuffer-dtb-for-de1_soc.patch |    4 +-
 .../current/0017-div-codec-mods.patch              |    4 +-
 ...ange-uio-port-name-Fix-for-machinekit-use.patch |    4 +-
 ...-boards-Make-core-addresses-in-qsys-devic.patch |  289 ++++
 .../current/0020-Test-Improve-dtb.patch            |   88 ++
 ...21-Add-missing-.ops-to-synthpcm5102-codec.patch |  122 ++
 ...Devicetree-qsys-core-addresses-consistant.patch |  315 ++++
 ...-audio-codec-driver-for-DE1-DE10-SoC-wm87.patch |  752 +++++++++
 .../current/socfpga-4.9.76-ltsi-rt-changeset.patch | 1643 +++++++++++++++++++-
 .../patches/socfpga-4.9.76-ltsi-rt-changeset.patch | 1643 +++++++++++++++++++-
 28 files changed, 4846 insertions(+), 123 deletions(-)
 create mode 100644 SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0019-Terasic-dev-boards-Make-core-addresses-in-qsys-devic.patch
 create mode 100644 SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0020-Test-Improve-dtb.patch
 create mode 100644 SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0021-Add-missing-.ops-to-synthpcm5102-codec.patch
 create mode 100644 SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0022-Make-DE1x-Devicetree-qsys-core-addresses-consistant.patch
 create mode 100644 SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0023-Add-builtin-audio-codec-driver-for-DE1-DE10-SoC-wm87.patch

diff --git a/SD-Image-Gen/build-all.sh b/SD-Image-Gen/build-all.sh
index 8aaafe7..e8f4556 100755
--- a/SD-Image-Gen/build-all.sh
+++ b/SD-Image-Gen/build-all.sh
@@ -33,9 +33,9 @@ HOME_MIRR_REPO_URL=http://debian9-ws2.holotronic.lan/debian
 
 shell_cmd="/bin/bash"
 #shell_cmd="/bin/sh"
-
+ROOT_REPO_URL=http://ftp.tu-chemnitz.de/pub/linux/ubuntu-ports
 #ROOT_REPO_URL=http://ports.ubuntu.com/ubuntu-ports
-ROOT_REPO_URL=${HOME_MIRR_REPO_URL}
+#ROOT_REPO_URL=${HOME_MIRR_REPO_URL}
 #final_repo="http://ftp.dk.debian.org/debian/"
 final_repo="http://deb.debian.org//debian/"
 local_repo=${HOME_MIRR_REPO_URL}
@@ -254,6 +254,7 @@ usage()
     echo "    --gitkernel2repo   Will add kernel .debs to local repo"
     echo "    --rtkernel2repo   Will add kernel .debs to local repo"
     echo "    --mk2repo   Will add machinekit .debs to local repo"
+    echo "    --cadence2repo   Will add cadence .debs to local repo"
     echo "    --gen-base-qemu-rootfs   Will create single root partition image and generate base qemu rootfs"
     echo "    --gen-base-qemu-rootfs-desktop   Will create single root partition image and generate base qemu rootfs"
     echo "    --finalize-rootfs   Will create user and configure  rootfs for fully working out of the box experience"
@@ -355,9 +356,9 @@ gen_rootfs_image() {
 #     echo "Script_MSG: run_qt_qemu_debootstrap (${3}) function return value was --> ${output}"
 #    else
         if [ "${DESKTOP}" == "yes" ]; then
-            if [ "${3}" == "buster" ]; then
-                run_qemu_debootstrap_buster ${1} ${3} ${ROOT_REPO_URL}
-                echo "Script_MSG: run_qemu_debootstrap_buster function return value was --> ${output}"
+            if [ "${3}" == "bionic" ]; then
+                run_qemu_debootstrap_bionic ${1} ${3} ${ROOT_REPO_URL}
+                echo "Script_MSG: run_qemu_debootstrap_bionicfunction return value was --> ${output}"
             else
                 run_desktop_qemu_debootstrap ${1} ${3} ${ROOT_REPO_URL}
                 echo "Script_MSG: run_desktop_qemu_debootstrap (${3}) function return value was --> ${output}"
@@ -506,11 +507,14 @@ while [ "$1" != "" ]; do
             ;;
         --rtkernel2repo)
 #            add2repo ${distro} ${RT_KERNEL_PARENT_DIR} ${RT_KERNEL_TAG}
-            add2repo "stretch" ${RT_KERNEL_PARENT_DIR} "${RT_KERNEL_TAG}-socfpga-${KERNEL_PKG_VERSION}"
+            add2repo "stretch" ${RT_KERNEL_PARENT_DIR} "${RT_KERNEL_TAG}-socfpga-${KERNEL_PKG_VERSION} linux-libc-dev"
             ;;
         --mk2repo)
             add2repo ${distro} "/home/mib/Development/Docker" "machinekit"
             ;;
+        --cadence2repo)
+            add2repo ${distro} "/home/mib/Development/deb_comp/Cadence" "'cadence claudia catia'"
+            ;;
         --gen-base-qemu-rootfs)
             gen_rootfs_image ${ROOTFS_MNT} "${CURRENT_DIR}/${ROOTFS_IMG}" ${distro} | tee ${CURRENT_DIR}/Logs/gen-qemu-base_rootfs-log.txt
             ;;
diff --git a/SD-Image-Gen/functions/file_build-func.sh b/SD-Image-Gen/functions/file_build-func.sh
index 8cfbe5c..0fbe480 100755
--- a/SD-Image-Gen/functions/file_build-func.sh
+++ b/SD-Image-Gen/functions/file_build-func.sh
@@ -631,14 +631,14 @@ armhf_build() {
     fi
 }
 
-## parameters: 1: distro name, 2: kernel dir, 3: file filter
+## parameters: 1: distro name, 2: dir, 3: file filter
 add2repo(){
 #sudo systemctl stop apache2
 
 echo ""
 echo "Script_MSG: Repo content before -->"
 echo ""
-LIST1=`reprepro -b ${HOME_REPO_DIR} -C main -A armhf --list-format='''${package}\n''' list ${1} | { grep ${3} || true; }`
+LIST1=`reprepro -b ${HOME_REPO_DIR} -C main -A armhf --list-format='''${package}\n''' list ${1} | { grep -E "${3}" || true; }`
 echo "Got list1"
 REPO_LIST1=$"${LIST1}"
 
@@ -655,7 +655,6 @@ if [ ! -z "${REPO_LIST1}" ]; then
     echo "Script_MSG: Will remove former version from repo"
     echo ""
     reprepro -b ${HOME_REPO_DIR} -C main -A armhf remove ${1} ${REPO_LIST1}
-    reprepro -b ${HOME_REPO_DIR} -C main -A armhf remove ${1} linux-libc-dev
     reprepro -b ${HOME_REPO_DIR} export ${1}
     echo "Script_MSG: Restarting web server"
 
diff --git a/SD-Image-Gen/functions/rootfs-func.sh b/SD-Image-Gen/functions/rootfs-func.sh
index 6c1b804..8f94a1a 100755
--- a/SD-Image-Gen/functions/rootfs-func.sh
+++ b/SD-Image-Gen/functions/rootfs-func.sh
@@ -2,8 +2,9 @@
 
 # lightdm,lxqt
 # ## parameters: 1: mount dev name, 2: distro name, 3: repo url
-run_qemu_debootstrap_buster() {
-sudo qemu-debootstrap --foreign --arch=armhf --variant=buildd --include=sudo,locales,wget ${2} ${1} ${3}
+## E: Couldn't find these debs: libdirectfb-1.7-7 libssh2-1 cgroupfs-mount gnupg2 ntp leafpad avahi-discover traceroute ifupdown2
+run_qemu_debootstrap_bionic() {
+sudo qemu-debootstrap --foreign --arch=armhf --variant=buildd --include=sudo,locales,wget,nano,apt-utils,rsyslog,openssh-client,openssh-server,openssl,kmod,dbus,dbus-x11,upower,net-tools,lsof,less,accountsservice,iputils-ping,python,python3,iproute2,avahi-daemon,uuid-runtime,libnss-mdns,strace,u-boot-tools,initramfs-tools,dirmngr,git,curl,xorg,autofs,libpam-systemd,systemd-sysv,fuse,policykit-1,gtk2-engines-pixbuf,fontconfig,fontconfig-config,console-setup,fbset,x11-xserver-utils,acpid ${2} ${1} ${3}
 output=${?}
 }
 
@@ -906,7 +907,7 @@ sudo sh -c 'cat <<EOF > '${ROOTFS_MNT}'/etc/X11/xorg.conf
 Section "Device"
     Identifier      "Frame Buffer"
     Driver  "fbdev"
-    Option "Rotate" "UD"
+    Option "Rotate" "off"
 EndSection
 
 Section "ServerLayout"
@@ -924,13 +925,24 @@ xinput set-prop 'eGalax Inc. eGalaxTouch EXC7910-1026-13.00.00' 'Coordinate Tran
 #/home/holosynth/prg/HolosynthVEd -nograb -platform xcb
 EOF'
 
-        sudo mkdir -p ${ROOTFS_MNT}/home/holosynth/Desktop
-        sudo sh -c 'cat <<EOF > '${ROOTFS_MNT}'/home/holosynth/Desktop/HolosynthVEd.sh
-#xinput set-prop 'eGalax Inc. eGalaxTouch EXC7910-1026-13.00.00' 'Coordinate Transformation Matrix' -1 0 1 0 -1 1 0 0 1
+    sudo mkdir -p ${ROOTFS_MNT}/home/holosynth/Desktop
+    sudo sh -c 'cat <<EOF > '${ROOTFS_MNT}'/home/holosynth/Desktop/HolosynthVEd.sh
 /home/holosynth/prg/HolosynthVEd -nograb -platform xcb
 
 EOF'
 
+    sudo sh -c 'cat <<EOF > '${ROOTFS_MNT}'/usr/share/applications/holosynthved.desktop
+[Desktop Entry]
+Name=HolosynthVEd
+GenericName=HolosynthVEd
+Comment=Synth Editor for HolosynthV
+Exec=/home/holosynth/prg/HolosynthVEd -nograb -platform xcb
+Icon=catia
+Terminal=false
+Type=Application
+Categories=AudioVideo;AudioEditing;Qt
+EOF'
+
     fi
     sudo chmod +x ${ROOTFS_MNT}/home/holosynth/Desktop/HolosynthVEd.sh
     sudo chown -R mib:mib ${ROOTFS_MNT}/home/holosynth/Desktop
diff --git a/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0001-disable-debug-package-gen.patch b/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0001-disable-debug-package-gen.patch
index 61c531f..7001ecd 100644
--- a/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0001-disable-debug-package-gen.patch
+++ b/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0001-disable-debug-package-gen.patch
@@ -1,7 +1,7 @@
-From 753ed154e5ec9bb74e8cfbc2191e06d88edb7dfd Mon Sep 17 00:00:00 2001
+From 8436e6d11733f7722c649f5ab656422cfbc77e9d Mon Sep 17 00:00:00 2001
 From: Michael Brown <producer@holotronic.dk>
 Date: Wed, 7 Mar 2018 14:14:18 +0100
-Subject: [PATCH 01/18] disable debug package gen
+Subject: [PATCH 01/23] disable debug package gen
 
 Signed-off-by: Michael Brown <producer@holotronic.dk>
 ---
diff --git a/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0002-Remove-gittag-from-kernel-file-name-s.patch b/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0002-Remove-gittag-from-kernel-file-name-s.patch
index 6aa400e..8318aed 100644
--- a/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0002-Remove-gittag-from-kernel-file-name-s.patch
+++ b/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0002-Remove-gittag-from-kernel-file-name-s.patch
@@ -1,7 +1,7 @@
-From 72b399286411702969d7c125e80556c75be5be5a Mon Sep 17 00:00:00 2001
+From f5e04b4bf29c5c9b8ae8fe195bb31de79f57cf81 Mon Sep 17 00:00:00 2001
 From: Michael Brown <producer@holotronic.dk>
 Date: Tue, 1 May 2018 16:02:19 +0200
-Subject: [PATCH 02/18] Remove gittag from kernel (file) name(s)
+Subject: [PATCH 02/23] Remove gittag from kernel (file) name(s)
 
 Signed-off-by: Michael Brown <producer@holotronic.dk>
 ---
diff --git a/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0003-add-ext4-root-fs-support-and-autofs4-module.patch b/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0003-add-ext4-root-fs-support-and-autofs4-module.patch
index 62302c1..c8a3afe 100644
--- a/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0003-add-ext4-root-fs-support-and-autofs4-module.patch
+++ b/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0003-add-ext4-root-fs-support-and-autofs4-module.patch
@@ -1,7 +1,7 @@
-From 92122fd2c48ad2f375b5ac902a0d8dd473da33e7 Mon Sep 17 00:00:00 2001
+From 846ba91a9e0ace87e89bc3ef43a5a50276c602d8 Mon Sep 17 00:00:00 2001
 From: Michael Brown <producer@holotronic.dk>
 Date: Wed, 7 Mar 2018 14:21:56 +0100
-Subject: [PATCH 03/18] add ext4 root fs support and autofs4 module
+Subject: [PATCH 03/23] add ext4 root fs support and autofs4 module
 
 Signed-off-by: Michael Brown <producer@holotronic.dk>
 ---
diff --git a/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0004-add-.dtd-files-to-kernel-image-.deb.patch b/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0004-add-.dtd-files-to-kernel-image-.deb.patch
index e18a838..60e39f5 100644
--- a/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0004-add-.dtd-files-to-kernel-image-.deb.patch
+++ b/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0004-add-.dtd-files-to-kernel-image-.deb.patch
@@ -1,7 +1,7 @@
-From 6750877c0d2f8d926371e082a92bd0b8ddd713fe Mon Sep 17 00:00:00 2001
+From 9b9b15cf7dc4fc65305c1e83d3b21be1792f2bb8 Mon Sep 17 00:00:00 2001
 From: Michael Brown <producer@holotronic.dk>
 Date: Wed, 7 Mar 2018 14:26:50 +0100
-Subject: [PATCH 04/18] add .dtd files to kernel-image .deb
+Subject: [PATCH 04/23] add .dtd files to kernel-image .deb
 
 Signed-off-by: Michael Brown <producer@holotronic.dk>
 ---
diff --git a/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0005-add-generate-boot-extlinux-extlinux.conf-and-boot-uE.patch b/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0005-add-generate-boot-extlinux-extlinux.conf-and-boot-uE.patch
index 7c2b7ca..01d7c8d 100644
--- a/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0005-add-generate-boot-extlinux-extlinux.conf-and-boot-uE.patch
+++ b/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0005-add-generate-boot-extlinux-extlinux.conf-and-boot-uE.patch
@@ -1,7 +1,7 @@
-From 56da1f23868444b69807ed2be18c34555d34d59d Mon Sep 17 00:00:00 2001
+From 5dddb22b4ddfad71e67e9447056a3fefe9885a8f Mon Sep 17 00:00:00 2001
 From: Michael Brown <producer@holotronic.dk>
 Date: Wed, 7 Mar 2018 14:33:44 +0100
-Subject: [PATCH 05/18] add generate /boot/extlinux/extlinux.conf and
+Subject: [PATCH 05/23] add generate /boot/extlinux/extlinux.conf and
  /boot/uEnv.txt for uboot boot info
 
 Signed-off-by: Michael Brown <producer@holotronic.dk>
diff --git a/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0006-add-configfs-and-fpgacfg-dts-entities-and-dynamic-dt.patch b/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0006-add-configfs-and-fpgacfg-dts-entities-and-dynamic-dt.patch
index 82c9feb..13db105 100644
--- a/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0006-add-configfs-and-fpgacfg-dts-entities-and-dynamic-dt.patch
+++ b/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0006-add-configfs-and-fpgacfg-dts-entities-and-dynamic-dt.patch
@@ -1,7 +1,7 @@
-From 21c4c40eefc2114c91f11b4ce128a04069271d77 Mon Sep 17 00:00:00 2001
+From e5c216b26feb274bd10a4513675867cc1bee7e09 Mon Sep 17 00:00:00 2001
 From: Michael Brown <producer@holotronic.dk>
 Date: Wed, 7 Mar 2018 15:43:11 +0100
-Subject: [PATCH 06/18] add configfs and fpgacfg dts entities, and dynamic dts
+Subject: [PATCH 06/23] add configfs and fpgacfg dts entities, and dynamic dts
  overlay support
 
 Signed-off-by: Michael Brown <producer@holotronic.dk>
diff --git a/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0007-rename-kernel-package-names-to-socfpga-rt-ltsi.patch b/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0007-rename-kernel-package-names-to-socfpga-rt-ltsi.patch
index cf6ff9b..ea6b49a 100644
--- a/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0007-rename-kernel-package-names-to-socfpga-rt-ltsi.patch
+++ b/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0007-rename-kernel-package-names-to-socfpga-rt-ltsi.patch
@@ -1,7 +1,7 @@
-From 11be59d2718ea5d5c5c2a246fcbb4bdf94e39cd1 Mon Sep 17 00:00:00 2001
+From f6f71473dbf253e78020ec251a55a186f1e4095c Mon Sep 17 00:00:00 2001
 From: Michael Brown <producer@holotronic.dk>
 Date: Sat, 10 Mar 2018 12:55:03 +0100
-Subject: [PATCH 07/18] rename kernel package names to *-socfpga-rt-ltsi
+Subject: [PATCH 07/23] rename kernel package names to *-socfpga-rt-ltsi
 
 Signed-off-by: Michael Brown <producer@holotronic.dk>
 ---
diff --git a/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0008-Enable-bridges-in-dtb-s.patch b/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0008-Enable-bridges-in-dtb-s.patch
index 038e91a..062d23b 100644
--- a/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0008-Enable-bridges-in-dtb-s.patch
+++ b/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0008-Enable-bridges-in-dtb-s.patch
@@ -1,7 +1,7 @@
-From 0794b2392204b60e5a1623df37c38b9c2b88dce1 Mon Sep 17 00:00:00 2001
+From ef472e6e5c416c0f4770c7966bf8b4a46d717154 Mon Sep 17 00:00:00 2001
 From: Michael Brown <producer@holotronic.dk>
 Date: Mon, 21 May 2018 13:19:43 +0200
-Subject: [PATCH 08/18] Enable bridges in dtb's
+Subject: [PATCH 08/23] Enable bridges in dtb's
 
 Signed-off-by: Michael Brown <producer@holotronic.dk>
 ---
diff --git a/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0009-add-spidev-in-dts-so-driver-is-loaded.patch b/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0009-add-spidev-in-dts-so-driver-is-loaded.patch
index 25fb023..ab50459 100644
--- a/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0009-add-spidev-in-dts-so-driver-is-loaded.patch
+++ b/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0009-add-spidev-in-dts-so-driver-is-loaded.patch
@@ -1,7 +1,7 @@
-From 78459a1ede4eb877df7b40fbfd2cd3462b002c11 Mon Sep 17 00:00:00 2001
+From 20ea6c604d6609dd913baa92228f9f8a23071e07 Mon Sep 17 00:00:00 2001
 From: Michael Brown <producer@holotronic.dk>
 Date: Sat, 10 Mar 2018 13:13:12 +0100
-Subject: [PATCH 09/18] add spidev in dts so driver is loaded
+Subject: [PATCH 09/23] add spidev in dts so driver is loaded
 
 Signed-off-by: Michael Brown <producer@holotronic.dk>
 ---
diff --git a/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0010-set-ACL-secutity.patch b/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0010-set-ACL-secutity.patch
index 7a73ef0..c8a379d 100644
--- a/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0010-set-ACL-secutity.patch
+++ b/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0010-set-ACL-secutity.patch
@@ -1,7 +1,7 @@
-From 068034f918fec37aae2427525d0d3a04592be91d Mon Sep 17 00:00:00 2001
+From 7d29dc2bf5391ce41cd1fb15503e2ec45c92a6b1 Mon Sep 17 00:00:00 2001
 From: Michael Brown <producer@holotronic.dk>
 Date: Mon, 12 Mar 2018 23:41:23 +0100
-Subject: [PATCH 10/18] set ACL secutity
+Subject: [PATCH 10/23] set ACL secutity
 
 Signed-off-by: Michael Brown <producer@holotronic.dk>
 ---
diff --git a/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0011-Enable-altvip-framebuffer.patch b/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0011-Enable-altvip-framebuffer.patch
index 0f12ec1..5adf8a1 100644
--- a/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0011-Enable-altvip-framebuffer.patch
+++ b/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0011-Enable-altvip-framebuffer.patch
@@ -1,7 +1,7 @@
-From 6579de47bf736ff969168f36ec8ab2a392ba9e77 Mon Sep 17 00:00:00 2001
+From 581ac795fff1e3da0419e26d1863a0c3e91ffe5b Mon Sep 17 00:00:00 2001
 From: Michael Brown <producer@holotronic.dk>
 Date: Fri, 30 Mar 2018 20:41:53 +0200
-Subject: [PATCH 11/18] Enable altvip framebuffer
+Subject: [PATCH 11/23] Enable altvip framebuffer
 
 Signed-off-by: Michael Brown <producer@holotronic.dk>
 ---
diff --git a/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0012-Added-DE-10-Nano-with-uio-with-without-framebuffer-1.patch b/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0012-Added-DE-10-Nano-with-uio-with-without-framebuffer-1.patch
index 2ca679d..c2466e8 100644
--- a/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0012-Added-DE-10-Nano-with-uio-with-without-framebuffer-1.patch
+++ b/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0012-Added-DE-10-Nano-with-uio-with-without-framebuffer-1.patch
@@ -1,7 +1,7 @@
-From b24ca38b38542e7ba7943d24793feb6ab2c527f4 Mon Sep 17 00:00:00 2001
+From 0b31761b59f5585494d7a80cb48c0828ae74fdcf Mon Sep 17 00:00:00 2001
 From: Michael Brown <producer@holotronic.dk>
 Date: Sun, 11 Mar 2018 22:21:04 +0100
-Subject: [PATCH 12/18] Added DE-10 Nano with uio, with/without framebuffer
+Subject: [PATCH 12/23] Added DE-10 Nano with uio, with/without framebuffer
  1024x768 and 1920x1080(hd) dts dtb
 
 Signed-off-by: Michael Brown <producer@holotronic.dk>
diff --git a/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0013-Add-framebuffer-ii-core-driver-based-on-Mister-and-e.patch b/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0013-Add-framebuffer-ii-core-driver-based-on-Mister-and-e.patch
index 66b6eb4..c3256dc 100644
--- a/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0013-Add-framebuffer-ii-core-driver-based-on-Mister-and-e.patch
+++ b/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0013-Add-framebuffer-ii-core-driver-based-on-Mister-and-e.patch
@@ -1,7 +1,7 @@
-From 4c317d9daddfc01549805a6af599ce5c050e5a33 Mon Sep 17 00:00:00 2001
+From 286c1bb32267da0fa8ecd531f7da0b5b8801e400 Mon Sep 17 00:00:00 2001
 From: Michael Brown <producer@holotronic.dk>
 Date: Fri, 18 May 2018 20:35:35 +0200
-Subject: [PATCH 13/18] Add framebuffer-ii core driver based on Mister, and
+Subject: [PATCH 13/23] Add framebuffer-ii core driver based on Mister, and
  enable it
 
 Signed-off-by: Michael Brown <producer@holotronic.dk>
diff --git a/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0014-Add-audio-and-midi-drivers-for-holosynth-and-builtin.patch b/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0014-Add-audio-and-midi-drivers-for-holosynth-and-builtin.patch
index d413bc4..8b79155 100644
--- a/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0014-Add-audio-and-midi-drivers-for-holosynth-and-builtin.patch
+++ b/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0014-Add-audio-and-midi-drivers-for-holosynth-and-builtin.patch
@@ -1,7 +1,7 @@
-From 2b77438809b377eeda2f10be8456131f74a3012c Mon Sep 17 00:00:00 2001
+From 7cdb53a7fcacdb48d60e71273bd0fb2f98b461ad Mon Sep 17 00:00:00 2001
 From: Michael Brown <producer@holotronic.dk>
 Date: Sun, 8 Apr 2018 22:39:54 +0200
-Subject: [PATCH 14/18] Add audio and midi drivers for holosynth and builtin
+Subject: [PATCH 14/23] Add audio and midi drivers for holosynth and builtin
  audio codec on de1 board
 
 Signed-off-by: Michael Brown <producer@holotronic.dk>
diff --git a/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0015-Add-Hsynth-audio-driver-with-Phat-pcm5102-audio-outp.patch b/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0015-Add-Hsynth-audio-driver-with-Phat-pcm5102-audio-outp.patch
index 3f7db97..5582fdb 100644
--- a/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0015-Add-Hsynth-audio-driver-with-Phat-pcm5102-audio-outp.patch
+++ b/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0015-Add-Hsynth-audio-driver-with-Phat-pcm5102-audio-outp.patch
@@ -1,7 +1,7 @@
-From e111e08bc321fddc1467ae86b86333a8ecddd9a9 Mon Sep 17 00:00:00 2001
+From bc57689674b257adc6fdbfe30ed8ae5aece86ace Mon Sep 17 00:00:00 2001
 From: Michael Brown <producer@holotronic.dk>
 Date: Thu, 17 May 2018 10:58:21 +0200
-Subject: [PATCH 15/18] Add Hsynth audio driver with Phat(pcm5102) audio output
+Subject: [PATCH 15/23] Add Hsynth audio driver with Phat(pcm5102) audio output
  Add vipii fb,pidac/hsynth audio dtb for DE10 Nano HD HDMI
 
 Signed-off-by: Michael Brown <producer@holotronic.dk>
diff --git a/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0016-add-vipii-framebuffer-dtb-for-de1_soc.patch b/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0016-add-vipii-framebuffer-dtb-for-de1_soc.patch
index 73abbe8..a9c61eb 100644
--- a/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0016-add-vipii-framebuffer-dtb-for-de1_soc.patch
+++ b/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0016-add-vipii-framebuffer-dtb-for-de1_soc.patch
@@ -1,7 +1,7 @@
-From 16af1e992897ccd80cc78854bae3510aca2d1a4b Mon Sep 17 00:00:00 2001
+From 24ae5222770099e114061e4faf89f754307cb67a Mon Sep 17 00:00:00 2001
 From: Michael Brown <producer@holotronic.dk>
 Date: Fri, 4 May 2018 14:32:56 +0200
-Subject: [PATCH 16/18] add vipii framebuffer dtb for de1_soc
+Subject: [PATCH 16/23] add vipii framebuffer dtb for de1_soc
 
 Signed-off-by: Michael Brown <producer@holotronic.dk>
 ---
diff --git a/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0017-div-codec-mods.patch b/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0017-div-codec-mods.patch
index 11ae8a6..dfad9a8 100644
--- a/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0017-div-codec-mods.patch
+++ b/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0017-div-codec-mods.patch
@@ -1,7 +1,7 @@
-From e174e8a81befdc588dc3a9d5d0d1dc04627388a8 Mon Sep 17 00:00:00 2001
+From 6429aafa9d4cc9edefce18997d3a0717649837df Mon Sep 17 00:00:00 2001
 From: Michael Brown <producer@holotronic.dk>
 Date: Thu, 24 May 2018 12:18:18 +0200
-Subject: [PATCH 17/18] div codec mods
+Subject: [PATCH 17/23] div codec mods
 
 Signed-off-by: Michael Brown <producer@holotronic.dk>
 ---
diff --git a/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0018-Change-uio-port-name-Fix-for-machinekit-use.patch b/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0018-Change-uio-port-name-Fix-for-machinekit-use.patch
index 271c46f..c4b9292 100644
--- a/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0018-Change-uio-port-name-Fix-for-machinekit-use.patch
+++ b/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0018-Change-uio-port-name-Fix-for-machinekit-use.patch
@@ -1,7 +1,7 @@
-From 3c0876af357dd1a1bc29c0e20b48b3180f529fba Mon Sep 17 00:00:00 2001
+From cc48f298696a05c23fcb92ff4b8e0ddb769837b8 Mon Sep 17 00:00:00 2001
 From: Michael Brown <producer@holotronic.dk>
 Date: Sat, 26 May 2018 21:36:55 +0200
-Subject: [PATCH 18/18] Change uio port name Fix: for machinekit use
+Subject: [PATCH 18/23] Change uio port name Fix: for machinekit use
 
 Signed-off-by: Michael Brown <producer@holotronic.dk>
 ---
diff --git a/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0019-Terasic-dev-boards-Make-core-addresses-in-qsys-devic.patch b/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0019-Terasic-dev-boards-Make-core-addresses-in-qsys-devic.patch
new file mode 100644
index 0000000..480d87d
--- /dev/null
+++ b/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0019-Terasic-dev-boards-Make-core-addresses-in-qsys-devic.patch
@@ -0,0 +1,289 @@
+From 0c3b0fac1543c1f6c36f3a220da59ff54453887a Mon Sep 17 00:00:00 2001
+From: Michael Brown <producer@holotronic.dk>
+Date: Wed, 30 May 2018 12:33:08 +0200
+Subject: [PATCH 19/23] Terasic dev boards: Make core addresses in qsys
+ devicetrees consistant
+
+Signed-off-by: Michael Brown <producer@holotronic.dk>
+---
+ .../socfpga_cyclone5_de10_nano_uio_aud_fbii_hd.dts | 16 ++---
+ .../boot/dts/socfpga_cyclone5_de10_nano_uio_fb.dts | 14 ++---
+ .../dts/socfpga_cyclone5_de10_nano_uio_fb_hd.dts   | 14 ++---
+ arch/arm/boot/dts/socfpga_cyclone5_de1_soc.dts     | 71 ++++++++++++----------
+ .../arm/boot/dts/socfpga_cyclone5_de1_soc_fbii.dts | 40 ++++++------
+ 5 files changed, 82 insertions(+), 73 deletions(-)
+
+diff --git a/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_aud_fbii_hd.dts b/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_aud_fbii_hd.dts
+index 7e1acf9..1bf0892 100644
+--- a/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_aud_fbii_hd.dts
++++ b/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_aud_fbii_hd.dts
+@@ -103,14 +103,14 @@
+ 		#address-cells = <0x2>;
+ 		#size-cells = <0x1>;
+ 		ranges = <0x00000001 0x00001000 0xff201000 0x00000008>,
+-				<0x00000001 0x00002000 0xff202000 0x00000008>,
+-				<0x00000001 0x00003000 0xff203000 0x00000010>,
+-				<0x00000001 0x00004000 0xff204000 0x00000010>,
+-				<0x00000001 0x00005000 0xff205000 0x00000010>,
+-				<0x00000001 0x00030000 0xff230000 0x00000100>,
+-				<0x00000001 0x00031000 0xff231000 0x00000080>,
+-				<0x00000001 0x00040000 0xff240000 0x00010000>,
+-				<0x00000001 0x00050000 0xff250000 0x00010000>;
++			<0x00000001 0x00002000 0xff202000 0x00000008>,
++			<0x00000001 0x00003000 0xff203000 0x00000010>,
++			<0x00000001 0x00004000 0xff204000 0x00000010>,
++			<0x00000001 0x00005000 0xff205000 0x00000010>,
++			<0x00000001 0x00030000 0xff230000 0x00000100>,
++			<0x00000001 0x00031000 0xff231000 0x00000080>,
++			<0x00000001 0x00040000 0xff240000 0x00010000>,
++			<0x00000001 0x00050000 0xff250000 0x00010000>;
+ 
+ 		sysid@0x100001000 {
+ 			compatible = "altr,sysid-15.1", "altr,sysid-1.0";
+diff --git a/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_fb.dts b/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_fb.dts
+index be476a1..c05a7f7 100644
+--- a/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_fb.dts
++++ b/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_fb.dts
+@@ -67,13 +67,13 @@
+ 		#address-cells = <0x2>;
+ 		#size-cells = <0x1>;
+ 		ranges = <0x00000001 0x00001000 0xff201000 0x00000008>,
+-				<0x00000001 0x00002000 0xff202000 0x00000008>,
+-				<0x00000001 0x00003000 0xff203000 0x00000010>,
+-				<0x00000001 0x00004000 0xff204000 0x00000010>,
+-				<0x00000001 0x00005000 0xff205000 0x00000010>,
+-				<0x00000001 0x00030000 0xff230000 0x00000100>,
+-				<0x00000001 0x00031000 0xff231000 0x00000080>,
+-				<0x00000001 0x00040000 0xff240000 0x00010000>;
++			<0x00000001 0x00002000 0xff202000 0x00000008>,
++			<0x00000001 0x00003000 0xff203000 0x00000010>,
++			<0x00000001 0x00004000 0xff204000 0x00000010>,
++			<0x00000001 0x00005000 0xff205000 0x00000010>,
++			<0x00000001 0x00030000 0xff230000 0x00000100>,
++			<0x00000001 0x00031000 0xff231000 0x00000080>,
++			<0x00000001 0x00040000 0xff240000 0x00010000>;
+ 
+ 		sysid@0x100001000 {
+ 			compatible = "altr,sysid-15.1", "altr,sysid-1.0";
+diff --git a/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_fb_hd.dts b/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_fb_hd.dts
+index f6ba2c6..ce568a0 100644
+--- a/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_fb_hd.dts
++++ b/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_fb_hd.dts
+@@ -67,13 +67,13 @@
+ 		#address-cells = <0x2>;
+ 		#size-cells = <0x1>;
+ 		ranges = <0x00000001 0x00001000 0xff201000 0x00000008>,
+-				<0x00000001 0x00002000 0xff202000 0x00000008>,
+-				<0x00000001 0x00003000 0xff203000 0x00000010>,
+-				<0x00000001 0x00004000 0xff204000 0x00000010>,
+-				<0x00000001 0x00005000 0xff205000 0x00000010>,
+-				<0x00000001 0x00030000 0xff230000 0x00000100>,
+-				<0x00000001 0x00031000 0xff231000 0x00000080>,
+-				<0x00000001 0x00040000 0xff240000 0x00010000>;
++			<0x00000001 0x00002000 0xff202000 0x00000008>,
++			<0x00000001 0x00003000 0xff203000 0x00000010>,
++			<0x00000001 0x00004000 0xff204000 0x00000010>,
++			<0x00000001 0x00005000 0xff205000 0x00000010>,
++			<0x00000001 0x00030000 0xff230000 0x00000100>,
++			<0x00000001 0x00031000 0xff231000 0x00000080>,
++			<0x00000001 0x00040000 0xff240000 0x00010000>;
+ 
+ 		sysid@0x100001000 {
+ 			compatible = "altr,sysid-15.1", "altr,sysid-1.0";
+diff --git a/arch/arm/boot/dts/socfpga_cyclone5_de1_soc.dts b/arch/arm/boot/dts/socfpga_cyclone5_de1_soc.dts
+index d2b80e6..4925f44 100644
+--- a/arch/arm/boot/dts/socfpga_cyclone5_de1_soc.dts
++++ b/arch/arm/boot/dts/socfpga_cyclone5_de1_soc.dts
+@@ -117,44 +117,34 @@
+ 		bridge-enable = <1>;
+ 		#address-cells = <0x2>;
+ 		#size-cells = <0x1>;
+-		ranges = <0x00000001 0x00020000 0xff220000 0x00000008>,
++		ranges = <0x00000001 0x00001000 0xff201000 0x00000008>,
++			<0x00000001 0x00002000 0xff202000 0x00000008>,
++			<0x00000001 0x00003000 0xff203000 0x00000010>,
++			<0x00000001 0x00004000 0xff204000 0x00000010>,
++			<0x00000001 0x00005000 0xff205000 0x00000010>,
++			<0x00000001 0x00030000 0xff230000 0x00000100>,
+ 			<0x00000001 0x00031000 0xff231000 0x00000080>,
+-			<0x00000001 0x00010000 0xff210000 0x00000008>,
+-			<0x00000001 0x000100c0 0xff2100c0 0x00000010>,
+-			<0x00000001 0x00010080 0xff210080 0x00000010>,
+-			<0x00000001 0x00010040 0xff210040 0x00000010>,
+ 			<0x00000001 0x00040000 0xff240000 0x00010000>,
+ 			<0x00000001 0x00050000 0xff250000 0x00010000>;
+ 
+-		serial@0x100020000 {
++		sysid@0x100001000 {
++			compatible = "altr,sysid-15.1", "altr,sysid-1.0";
++			reg = <0x00000001 0x00001000 0x00000008>;
++			id = <2899645186>;
++			timestamp = <1524157570>;
++		};
++
++		serial@0x100002000 {
+ 			compatible = "altr,juart-17.1", "altr,juart-1.0";
+-			reg = <0x00000001 0x00020000 0x00000008>;
++			reg = <0x00000001 0x00002000 0x00000008>;
+ 			interrupt-parent = <0x2>;
+ 			interrupts = <0 40 4>;
+ 			clocks = <0x2>;
+ 		}; //end serial@0x100020000 (jtag_uart)
+ 
+-		vip@0x100031000 {
+-			compatible = "altr,vip-frame-reader-1.0", "ALTR,vip-frame-reader-14.0";
+-			reg = <0x00000001 0x00031000 0x00000080>;
+-			max-width = <0x556>;
+-			max-height = <0x300>;
+-			bits-per-color = <0x8>;
+-			colors-per-beat = <0x4>;
+-			beats-per-pixel = <0x1>;
+-			mem-word-width = <0x80>;
+-		};
+-
+-		sysid@0x100010000 {
+-			compatible = "altr,sysid-15.1", "altr,sysid-1.0";
+-			reg = <0x00000001 0x00010000 0x00000008>;
+-			id = <2899645186>;
+-			timestamp = <1524157570>;
+-		};
+-
+-		gpio@0x1000100c0 {
++		gpio@0x100003000 {
+ 			compatible = "altr,pio-17.1", "altr,pio-1.0";
+-			reg = <0x00000001 0x000100c0 0x00000010>;
++			reg = <0x00000001 0x00003000 0x00000010>;
+ 			interrupt-parent = <0x2>;
+ 			interrupts = <0 41 1>;
+ 			clocks = <0x2>;
+@@ -168,9 +158,9 @@
+ 			gpio-controller;
+ 		}; //end gpio@0x1000100c0 (button_pio)
+ 
+-		gpio@0x100010080 {
++		gpio@0x100004000 {
+ 			compatible = "altr,pio-17.1", "altr,pio-1.0";
+-			reg = <0x00000001 0x00010080 0x00000010>;
++			reg = <0x00000001 0x00004000 0x00000010>;
+ 			interrupt-parent = <0x2>;
+ 			interrupts = <0 42 1>;
+ 			clocks = <0x2>;
+@@ -184,9 +174,9 @@
+ 			gpio-controller;
+ 		}; //end gpio@0x100010080 (dipsw_pio)
+ 
+-		gpio@0x100010040 {
++		gpio@0x100005000 {
+ 			compatible = "altr,pio-17.1", "altr,pio-1.0";
+-			reg = <0x00000001 0x00010040 0x00000010>;
++			reg = <0x00000001 0x00005000 0x00000010>;
+ 			clocks = <0x2>;
+ 			altr,gpio-bank-width = <10>;	/* embeddedsw.dts.params.altr,gpio-bank-width type NUMBER */
+ 			resetvalue = <0>;	/* embeddedsw.dts.params.resetvalue type NUMBER */
+@@ -194,6 +184,25 @@
+ 			gpio-controller;
+ 		}; //end gpio@0x100010040 (led_pio)
+ 
++		ilc@0x100030000 {
++			compatible = "altr,altera_ilc-15.1", "altr,ilc-1.0";
++			reg = <0x00000001 0x00030000 0x00000100>;
++			interrupt-controller;
++			#interrupt-cells = <0x1>;
++			altr,sw-fifo-depth = <0x20>;
++		};
++
++		vip@0x100031000 {
++			compatible = "altr,vip-frame-reader-1.0", "ALTR,vip-frame-reader-14.0";
++			reg = <0x00000001 0x00031000 0x00000080>;
++			max-width = <0x556>;
++			max-height = <0x300>;
++			bits-per-color = <0x8>;
++			colors-per-beat = <0x4>;
++			beats-per-pixel = <0x1>;
++			mem-word-width = <0x80>;
++		};
++
+ 		uio-socfpg0@0x100040000 {
+ 			compatible = "generic-uio,ui_pdrv";
+ 			reg = <0x00000001 0x00040000 0x00010000>;
+diff --git a/arch/arm/boot/dts/socfpga_cyclone5_de1_soc_fbii.dts b/arch/arm/boot/dts/socfpga_cyclone5_de1_soc_fbii.dts
+index 225e461..c6aaacc 100644
+--- a/arch/arm/boot/dts/socfpga_cyclone5_de1_soc_fbii.dts
++++ b/arch/arm/boot/dts/socfpga_cyclone5_de1_soc_fbii.dts
+@@ -117,33 +117,33 @@
+ 		bridge-enable = <1>;
+ 		#address-cells = <0x2>;
+ 		#size-cells = <0x1>;
+-		ranges = <0x00000001 0x00020000 0xff220000 0x00000008>,
+-			<0x00000001 0x00010000 0xff210000 0x00000008>,
+-			<0x00000001 0x000100c0 0xff2100c0 0x00000010>,
+-			<0x00000001 0x00010080 0xff210080 0x00000010>,
+-			<0x00000001 0x00010040 0xff210040 0x00000010>,
++		ranges = <0x00000001 0x00001000 0xff201000 0x00000008>,
++			<0x00000001 0x00002000 0xff202000 0x00000008>,
++			<0x00000001 0x00003000 0xff203000 0x00000010>,
++			<0x00000001 0x00004000 0xff204000 0x00000010>,
++			<0x00000001 0x00005000 0xff205000 0x00000010>,
+ 			<0x00000001 0x00031000 0xff231000 0x00000080>,
+ 			<0x00000001 0x00040000 0xff240000 0x00010000>,
+ 			<0x00000001 0x00050000 0xff250000 0x00010000>;
+ 
+-		serial@0x100020000 {
++		sysid@0x100001000 {
++			compatible = "altr,sysid-15.1", "altr,sysid-1.0";
++			reg = <0x00000001 0x00001000 0x00000008>;
++			id = <2899645186>;
++			timestamp = <1524157570>;
++		};
++
++		serial@0x100002000 {
+ 			compatible = "altr,juart-17.1", "altr,juart-1.0";
+-			reg = <0x00000001 0x00020000 0x00000008>;
++			reg = <0x00000001 0x00002000 0x00000008>;
+ 			interrupt-parent = <0x2>;
+ 			interrupts = <0 40 4>;
+ 			clocks = <0x2>;
+ 		}; //end serial@0x100020000 (jtag_uart)
+ 
+-		sysid@0x100010000 {
+-			compatible = "altr,sysid-15.1", "altr,sysid-1.0";
+-			reg = <0x00000001 0x00010000 0x00000008>;
+-			id = <2899645186>;
+-			timestamp = <1524157570>;
+-		};
+-
+-		gpio@0x1000100c0 {
++		gpio@0x100003000 {
+ 			compatible = "altr,pio-17.1", "altr,pio-1.0";
+-			reg = <0x00000001 0x000100c0 0x00000010>;
++			reg = <0x00000001 0x00003000 0x00000010>;
+ 			interrupt-parent = <0x2>;
+ 			interrupts = <0 41 1>;
+ 			clocks = <0x2>;
+@@ -157,9 +157,9 @@
+ 			gpio-controller;
+ 		}; //end gpio@0x1000100c0 (button_pio)
+ 
+-		gpio@0x100010080 {
++		gpio@0x100004000 {
+ 			compatible = "altr,pio-17.1", "altr,pio-1.0";
+-			reg = <0x00000001 0x00010080 0x00000010>;
++			reg = <0x00000001 0x00004000 0x00000010>;
+ 			interrupt-parent = <0x2>;
+ 			interrupts = <0 42 1>;
+ 			clocks = <0x2>;
+@@ -173,9 +173,9 @@
+ 			gpio-controller;
+ 		}; //end gpio@0x100010080 (dipsw_pio)
+ 
+-		gpio@0x100010040 {
++		gpio@0x100005000 {
+ 			compatible = "altr,pio-17.1", "altr,pio-1.0";
+-			reg = <0x00000001 0x00010040 0x00000010>;
++			reg = <0x00000001 0x00005000 0x00000010>;
+ 			clocks = <0x2>;
+ 			altr,gpio-bank-width = <10>;	/* embeddedsw.dts.params.altr,gpio-bank-width type NUMBER */
+ 			resetvalue = <0>;	/* embeddedsw.dts.params.resetvalue type NUMBER */
+-- 
+2.7.4
+
diff --git a/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0020-Test-Improve-dtb.patch b/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0020-Test-Improve-dtb.patch
new file mode 100644
index 0000000..863e7bf
--- /dev/null
+++ b/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0020-Test-Improve-dtb.patch
@@ -0,0 +1,88 @@
+From db1989353b097c1dfe6c74220247212e2a834ac8 Mon Sep 17 00:00:00 2001
+From: Michael Brown <producer@holotronic.dk>
+Date: Thu, 31 May 2018 13:46:11 +0200
+Subject: [PATCH 20/23] Test Improve dtb
+
+Signed-off-by: Michael Brown <producer@holotronic.dk>
+---
+ .../socfpga_cyclone5_de10_nano_uio_aud_fbii_hd.dts | 22 ++++++++++++++--------
+ 1 file changed, 14 insertions(+), 8 deletions(-)
+
+diff --git a/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_aud_fbii_hd.dts b/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_aud_fbii_hd.dts
+index 1bf0892..65d1a56 100644
+--- a/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_aud_fbii_hd.dts
++++ b/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_aud_fbii_hd.dts
+@@ -122,9 +122,8 @@
+ 		serial@0x100002000 {
+ 			compatible = "altr,juart-15.1", "altr,juart-1.0";
+ 			reg = <0x00000001 0x00002000 0x00000008>;
+-			interrupt-parent = <0x3>;
+-			interrupts = <0x0 0x2a 0x4>;
+-			clocks = <0x2>;
++			interrupt-parent = <&intc>;
++			interrupts = <0 40 4>;
+ 		};
+ 
+ 		gpio@0x100003000 {
+@@ -139,6 +138,8 @@
+ 		gpio@0x100004000 {
+ 			compatible = "altr,pio-15.1", "altr,pio-1.0";
+ 			reg = <0x00000001 0x00004000 0x00000010>;
++			interrupt-parent = <&intc>;
++			interrupts = <0 41 1>;
+ 			altr,gpio-bank-width = <0x4>;
+ 			altr,interrupt-type = <0x3>;
+ 			altr,interrupt_type = <0x3>;
+@@ -152,6 +153,8 @@
+ 		gpio@0x100005000 {
+ 			compatible = "altr,pio-15.1", "altr,pio-1.0";
+ 			reg = <0x00000001 0x00005000 0x00000010>;
++			interrupt-parent = <&intc>;
++			interrupts = <0 42 1>;
+ 			altr,gpio-bank-width = <0x2>;
+ 			altr,interrupt-type = <0x2>;
+ 			altr,interrupt_type = <0x2>;
+@@ -165,6 +168,9 @@
+ 		ilc@0x100030000 {
+ 			compatible = "altr,altera_ilc-15.1", "altr,ilc-1.0";
+ 			reg = <0x00000001 0x00030000 0x00000100>;
++			interrupt-parent = <&intc>;
++			interrupts = <0 0 4 0 2 1 0 1 1 0 3 4 0 4 4>;
++			interrupt-names = "jtag_uart", "button_pio", "dipsw_pio", "uioreg_io_0", "socmidi_0";
+ 			interrupt-controller;
+ 			#interrupt-cells = <0x1>;
+ 			altr,sw-fifo-depth = <0x20>;
+@@ -184,8 +190,8 @@
+ 		uio-socfpg0@0x100040000 {
+ 			compatible = "generic-uio,ui_pdrv";
+ 			reg = <0x00000001 0x00040000 0x00010000>;
+-			interrupt-parent = <0x2>;
+-			interrupts = <0 43 1>;
++			interrupt-parent = <&intc>;
++			interrupts = <0 43 4>;
+ 			address_width = <14>;
+ 			data_width = <32>;
+ 		};
+@@ -193,8 +199,8 @@
+ 		socmidi@0x100050000 {
+ 			compatible = "holotr,socsynth-midi";
+ 			reg = <0x00000001 0x00050000 0x00010000>;
+-			interrupt-parent = <0x2>;
+-/*			interrupts = <0 44 4>;*/
++			interrupt-parent = <&intc>;
++			interrupts = <0 44 4>;
+ 			address_width = <3>;   /* embeddedsw.dts.params.address_width type NUMBER */
+ 			data_width = <8>;      /* embeddedsw.dts.params.data_width type NUMBER */
+ 		};
+@@ -241,7 +247,7 @@
+ 		compatible = "adi,adxl34x";
+ 		reg = <0x53>;
+ 
+-		interrupt-parent = <&portc>;
++		interrupt-parent = <&intc>;
+ 		interrupts = <3 2>;
+ 	};
+ };
+-- 
+2.7.4
+
diff --git a/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0021-Add-missing-.ops-to-synthpcm5102-codec.patch b/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0021-Add-missing-.ops-to-synthpcm5102-codec.patch
new file mode 100644
index 0000000..8965fd2
--- /dev/null
+++ b/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0021-Add-missing-.ops-to-synthpcm5102-codec.patch
@@ -0,0 +1,122 @@
+From 75ae05513d02bf59f1bff6d65962b20d01bbd435 Mon Sep 17 00:00:00 2001
+From: Michael Brown <producer@holotronic.dk>
+Date: Thu, 31 May 2018 18:08:43 +0200
+Subject: [PATCH 21/23] Add missing .ops to synthpcm5102 codec
+
+Signed-off-by: Michael Brown <producer@holotronic.dk>
+---
+ sound/soc/codecs/hsynthpcm5102.c | 93 +++++++++++++++++++++++++++++++---------
+ 1 file changed, 72 insertions(+), 21 deletions(-)
+
+diff --git a/sound/soc/codecs/hsynthpcm5102.c b/sound/soc/codecs/hsynthpcm5102.c
+index 9791ae3..4144146 100644
+--- a/sound/soc/codecs/hsynthpcm5102.c
++++ b/sound/soc/codecs/hsynthpcm5102.c
+@@ -27,32 +27,83 @@ static const struct snd_soc_dapm_route hsynthpcm5102_routes[] = {
+ 
+ static int hsynthpcm5102_set_dai_fmt(struct snd_soc_dai *dai, unsigned int fmt)
+ {
+-    switch (fmt & SND_SOC_DAIFMT_MASTER_MASK) {
+-    case SND_SOC_DAIFMT_CBS_CFS:
+-        break;
+-    default:
+-        return -EINVAL;
+-    }
+-
+-    switch (fmt & SND_SOC_DAIFMT_INV_MASK) {
+-    case SND_SOC_DAIFMT_NB_NF:
+-        break;
+-    default:
+-        return -EINVAL;
+-    }
+-
+-    switch (fmt & SND_SOC_DAIFMT_FORMAT_MASK) {
+-    case SND_SOC_DAIFMT_I2S:
+-    case SND_SOC_DAIFMT_DSP_A:
+-        break;
+-    default:
+-        return -EINVAL;
+-    }
++//     switch (fmt & SND_SOC_DAIFMT_MASTER_MASK) {
++//     case SND_SOC_DAIFMT_CBS_CFS:
++//         break;
++//     default:
++//         return -EINVAL;
++//     }
++//
++//     switch (fmt & SND_SOC_DAIFMT_INV_MASK) {
++//     case SND_SOC_DAIFMT_NB_NF:
++//         break;
++//     default:
++//         return -EINVAL;
++//     }
++//
++//     switch (fmt & SND_SOC_DAIFMT_FORMAT_MASK) {
++//     case SND_SOC_DAIFMT_I2S:
++//     case SND_SOC_DAIFMT_DSP_A:
++//         break;
++//     default:
++//         return -EINVAL;
++//     }
+ 
+     return 0;
+ }
+ 
++static int hsynthpcm5102_hw_params(struct snd_pcm_substream *substream,
++                            struct snd_pcm_hw_params *params,
++                            struct snd_soc_dai *dai)
++{
++//     struct snd_soc_codec *codec = dai->codec;
++//     struct wm8731_priv *wm8731 = snd_soc_codec_get_drvdata(codec);
++//     u16 iface = snd_soc_read(codec, WM8731_IFACE) & 0xfff3;
++//     int i = get_coeff(wm8731->sysclk, params_rate(params));
++//     u16 srate = (coeff_div[i].sr << 2) |
++//     (coeff_div[i].bosr << 1) | coeff_div[i].usb;
++//
++//     wm8731->playback_fs = params_rate(params);
++//
++//     snd_soc_write(codec, WM8731_SRATE, srate);
++//
++//     /* bit size */
++//     switch (params_width(params)) {
++//         case 16:
++//             break;
++//         case 20:
++//             iface |= 0x0004;
++//             break;
++//         case 24:
++//             iface |= 0x0008;
++//             break;
++//         case 32:
++//             iface |= 0x000c;
++//             break;
++//     }
++//
++//     wm8731_set_deemph(codec);
++//
++//     snd_soc_write(codec, WM8731_IFACE, iface);
++    return 0;
++}
++
++static int hsynthpcm5102_startup(struct snd_pcm_substream *substream,
++                           struct snd_soc_dai *dai)
++{
++//     struct wm8731_priv *wm8731 = snd_soc_codec_get_drvdata(dai->codec);
++//
++//     if (wm8731->constraints)
++//         snd_pcm_hw_constraint_list(substream->runtime, 0,
++//                                    SNDRV_PCM_HW_PARAM_RATE,
++//                                    wm8731->constraints);
++
++        return 0;
++}
++
+ static const struct snd_soc_dai_ops hsynthpcm5102_dai_ops = {
++    .startup	= hsynthpcm5102_startup,
++    .hw_params	= hsynthpcm5102_hw_params,
+     .set_fmt = hsynthpcm5102_set_dai_fmt,
+ };
+ 
+-- 
+2.7.4
+
diff --git a/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0022-Make-DE1x-Devicetree-qsys-core-addresses-consistant.patch b/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0022-Make-DE1x-Devicetree-qsys-core-addresses-consistant.patch
new file mode 100644
index 0000000..2d89514
--- /dev/null
+++ b/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0022-Make-DE1x-Devicetree-qsys-core-addresses-consistant.patch
@@ -0,0 +1,315 @@
+From 5e510d8a218793c02edef33da7b7a4c78b0b17e9 Mon Sep 17 00:00:00 2001
+From: Michael Brown <producer@holotronic.dk>
+Date: Fri, 1 Jun 2018 12:52:57 +0200
+Subject: [PATCH 22/23] Make DE1x Devicetree qsys core addresses consistant
+
+Signed-off-by: Michael Brown <producer@holotronic.dk>
+---
+ .../socfpga_cyclone5_de10_nano_uio_aud_fbii_hd.dts |  6 +-
+ .../boot/dts/socfpga_cyclone5_de10_nano_uio_fb.dts | 22 +++----
+ .../dts/socfpga_cyclone5_de10_nano_uio_fb_hd.dts   | 26 ++++----
+ arch/arm/boot/dts/socfpga_cyclone5_de1_soc.dts     | 70 +++++++++++-----------
+ 4 files changed, 58 insertions(+), 66 deletions(-)
+
+diff --git a/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_aud_fbii_hd.dts b/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_aud_fbii_hd.dts
+index 65d1a56..4b8b813 100644
+--- a/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_aud_fbii_hd.dts
++++ b/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_aud_fbii_hd.dts
+@@ -133,7 +133,7 @@
+ 			resetvalue = <0xff>;
+ 			#gpio-cells = <0x2>;
+ 			gpio-controller;
+-		};
++		};// (led_pio)
+ 
+ 		gpio@0x100004000 {
+ 			compatible = "altr,pio-15.1", "altr,pio-1.0";
+@@ -148,7 +148,7 @@
+ 			resetvalue = <0x0>;
+ 			#gpio-cells = <0x2>;
+ 			gpio-controller;
+-		};
++		};// (dipsw_pio)
+ 
+ 		gpio@0x100005000 {
+ 			compatible = "altr,pio-15.1", "altr,pio-1.0";
+@@ -163,7 +163,7 @@
+ 			resetvalue = <0x0>;
+ 			#gpio-cells = <0x2>;
+ 			gpio-controller;
+-		};
++		};// (button_pio)
+ 
+ 		ilc@0x100030000 {
+ 			compatible = "altr,altera_ilc-15.1", "altr,ilc-1.0";
+diff --git a/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_fb.dts b/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_fb.dts
+index c05a7f7..cc62324 100644
+--- a/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_fb.dts
++++ b/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_fb.dts
+@@ -85,8 +85,8 @@
+ 		serial@0x100002000 {
+ 			compatible = "altr,juart-15.1", "altr,juart-1.0";
+ 			reg = <0x00000001 0x00002000 0x00000008>;
+-			interrupt-parent = <0x3>;
+-			interrupts = <0x0 0x2a 0x4>;
++			interrupt-parent = <&intc>;
++			interrupts = <0 40 4>;
+ 			clocks = <0x2>;
+ 		};
+ 
+@@ -103,6 +103,8 @@
+ 			compatible = "altr,pio-15.1", "altr,pio-1.0";
+ 			reg = <0x00000001 0x00004000 0x00000010>;
+ 			altr,gpio-bank-width = <0x4>;
++			interrupt-parent = <&intc>;
++			interrupts = <0 41 1>;
+ 			altr,interrupt-type = <0x3>;
+ 			altr,interrupt_type = <0x3>;
+ 			edge_type = <0x2>;
+@@ -115,6 +117,8 @@
+ 		gpio@0x100005000 {
+ 			compatible = "altr,pio-15.1", "altr,pio-1.0";
+ 			reg = <0x00000001 0x00005000 0x00000010>;
++			interrupt-parent = <&intc>;
++			interrupts = <0 42 1>;
+ 			altr,gpio-bank-width = <0x2>;
+ 			altr,interrupt-type = <0x2>;
+ 			altr,interrupt_type = <0x2>;
+@@ -125,14 +129,6 @@
+ 			gpio-controller;
+ 		};
+ 
+-		ilc@0x100030000 {
+-			compatible = "altr,altera_ilc-15.1", "altr,ilc-1.0";
+-			reg = <0x00000001 0x00030000 0x00000100>;
+-			interrupt-controller;
+-			#interrupt-cells = <0x1>;
+-			altr,sw-fifo-depth = <0x20>;
+-		};
+-
+ 		vip@0x100031000 {
+ 			compatible = "altr,vip-frame-reader-1.0", "ALTR,vip-frame-reader-9.1";
+ 			reg = <0x00000001 0x00031000 0x00000080>;
+@@ -147,8 +143,8 @@
+ 		hm2-socfpga0@0x100040000 {
+ 			compatible = "generic-uio,ui_pdrv";
+ 			reg = <0x00000001 0x00040000 0x00010000>;
+-			interrupt-parent = <0x2>;
+-			interrupts = <0 43 1>;
++			interrupt-parent = <&intc>;
++			interrupts = <0 43 4>;
+ 			address_width = <14>;
+ 			data_width = <32>;
+ 		};
+@@ -195,7 +191,7 @@
+ 		compatible = "adi,adxl34x";
+ 		reg = <0x53>;
+ 
+-		interrupt-parent = <&portc>;
++		interrupt-parent = <&intc>;
+ 		interrupts = <3 2>;
+ 	};
+ };
+diff --git a/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_fb_hd.dts b/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_fb_hd.dts
+index ce568a0..67bf19f 100644
+--- a/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_fb_hd.dts
++++ b/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_fb_hd.dts
+@@ -71,8 +71,8 @@
+ 			<0x00000001 0x00003000 0xff203000 0x00000010>,
+ 			<0x00000001 0x00004000 0xff204000 0x00000010>,
+ 			<0x00000001 0x00005000 0xff205000 0x00000010>,
+-			<0x00000001 0x00030000 0xff230000 0x00000100>,
+-			<0x00000001 0x00031000 0xff231000 0x00000080>,
++            <0x00000000 0x00010000 0xc0010000 0x00010000>,
++            <0x00000001 0x00031000 0xff231000 0x00000080>,
+ 			<0x00000001 0x00040000 0xff240000 0x00010000>;
+ 
+ 		sysid@0x100001000 {
+@@ -85,8 +85,8 @@
+ 		serial@0x100002000 {
+ 			compatible = "altr,juart-15.1", "altr,juart-1.0";
+ 			reg = <0x00000001 0x00002000 0x00000008>;
+-			interrupt-parent = <0x3>;
+-			interrupts = <0x0 0x2a 0x4>;
++			interrupt-parent = <&intc>;
++			interrupts = <0 40 4>;
+ 			clocks = <0x2>;
+ 		};
+ 
+@@ -102,6 +102,8 @@
+ 		gpio@0x100004000 {
+ 			compatible = "altr,pio-15.1", "altr,pio-1.0";
+ 			reg = <0x00000001 0x00004000 0x00000010>;
++			interrupt-parent = <&intc>;
++			interrupts = <0 41 1>;
+ 			altr,gpio-bank-width = <0x4>;
+ 			altr,interrupt-type = <0x3>;
+ 			altr,interrupt_type = <0x3>;
+@@ -115,6 +117,8 @@
+ 		gpio@0x100005000 {
+ 			compatible = "altr,pio-15.1", "altr,pio-1.0";
+ 			reg = <0x00000001 0x00005000 0x00000010>;
++			interrupt-parent = <&intc>;
++			interrupts = <0 42 1>;
+ 			altr,gpio-bank-width = <0x2>;
+ 			altr,interrupt-type = <0x2>;
+ 			altr,interrupt_type = <0x2>;
+@@ -125,14 +129,6 @@
+ 			gpio-controller;
+ 		};
+ 
+-		ilc@0x100030000 {
+-			compatible = "altr,altera_ilc-15.1", "altr,ilc-1.0";
+-			reg = <0x00000001 0x00030000 0x00000100>;
+-			interrupt-controller;
+-			#interrupt-cells = <0x1>;
+-			altr,sw-fifo-depth = <0x20>;
+-		};
+-
+ 		vip@0x100031000 {
+ 			compatible = "altr,vip-frame-reader-1.0", "ALTR,vip-frame-reader-9.1";
+ 			reg = <0x00000001 0x00031000 0x00000080>;
+@@ -147,8 +143,8 @@
+ 		hm2-socfpga0@0x100040000 {
+ 			compatible = "generic-uio,ui_pdrv";
+ 			reg = <0x00000001 0x00040000 0x00010000>;
+-			interrupt-parent = <0x2>;
+-			interrupts = <0 43 1>;
++			interrupt-parent = <&intc>;
++			interrupts = <0 43 4>;
+ 			address_width = <14>;
+ 			data_width = <32>;
+ 		};
+@@ -195,7 +191,7 @@
+ 		compatible = "adi,adxl34x";
+ 		reg = <0x53>;
+ 
+-		interrupt-parent = <&portc>;
++		interrupt-parent = <&intc>;
+ 		interrupts = <3 2>;
+ 	};
+ };
+diff --git a/arch/arm/boot/dts/socfpga_cyclone5_de1_soc.dts b/arch/arm/boot/dts/socfpga_cyclone5_de1_soc.dts
+index 4925f44..11f0a9c 100644
+--- a/arch/arm/boot/dts/socfpga_cyclone5_de1_soc.dts
++++ b/arch/arm/boot/dts/socfpga_cyclone5_de1_soc.dts
+@@ -137,56 +137,56 @@
+ 		serial@0x100002000 {
+ 			compatible = "altr,juart-17.1", "altr,juart-1.0";
+ 			reg = <0x00000001 0x00002000 0x00000008>;
+-			interrupt-parent = <0x2>;
++			interrupt-parent = <&intc>;
+ 			interrupts = <0 40 4>;
+ 			clocks = <0x2>;
+ 		}; //end serial@0x100020000 (jtag_uart)
+ 
+ 		gpio@0x100003000 {
+-			compatible = "altr,pio-17.1", "altr,pio-1.0";
++			compatible = "altr,pio-15.1", "altr,pio-1.0";
+ 			reg = <0x00000001 0x00003000 0x00000010>;
+-			interrupt-parent = <0x2>;
+-			interrupts = <0 41 1>;
+-			clocks = <0x2>;
+-			altr,gpio-bank-width = <2>;	/* embeddedsw.dts.params.altr,gpio-bank-width type NUMBER */
+-			altr,interrupt-type = <2>;	/* embeddedsw.dts.params.altr,interrupt-type type NUMBER */
+-			altr,interrupt_type = <2>;	/* embeddedsw.dts.params.altr,interrupt_type type NUMBER */
+-			edge_type = <1>;	/* embeddedsw.dts.params.edge_type type NUMBER */
+-			level_trigger = <0>;	/* embeddedsw.dts.params.level_trigger type NUMBER */
+-			resetvalue = <0>;	/* embeddedsw.dts.params.resetvalue type NUMBER */
+-			#gpio-cells = <2>;
++			altr,gpio-bank-width = <0x8>;
++			resetvalue = <0xff>;
++			#gpio-cells = <0x2>;
+ 			gpio-controller;
+-		}; //end gpio@0x1000100c0 (button_pio)
++		};// (led_pio)
+ 
+ 		gpio@0x100004000 {
+-			compatible = "altr,pio-17.1", "altr,pio-1.0";
++			compatible = "altr,pio-15.1", "altr,pio-1.0";
+ 			reg = <0x00000001 0x00004000 0x00000010>;
+-			interrupt-parent = <0x2>;
+-			interrupts = <0 42 1>;
+-			clocks = <0x2>;
+-			altr,gpio-bank-width = <10>;	/* embeddedsw.dts.params.altr,gpio-bank-width type NUMBER */
+-			altr,interrupt-type = <3>;	/* embeddedsw.dts.params.altr,interrupt-type type NUMBER */
+-			altr,interrupt_type = <3>;	/* embeddedsw.dts.params.altr,interrupt_type type NUMBER */
+-			edge_type = <2>;	/* embeddedsw.dts.params.edge_type type NUMBER */
+-			level_trigger = <0>;	/* embeddedsw.dts.params.level_trigger type NUMBER */
+-			resetvalue = <0>;	/* embeddedsw.dts.params.resetvalue type NUMBER */
+-			#gpio-cells = <2>;
++			interrupt-parent = <&intc>;
++			interrupts = <0 41 1>;
++			altr,gpio-bank-width = <0x4>;
++			altr,interrupt-type = <0x3>;
++			altr,interrupt_type = <0x3>;
++			edge_type = <0x2>;
++			level_trigger = <0x0>;
++			resetvalue = <0x0>;
++			#gpio-cells = <0x2>;
+ 			gpio-controller;
+-		}; //end gpio@0x100010080 (dipsw_pio)
++		};// (dipsw_pio)
+ 
+ 		gpio@0x100005000 {
+-			compatible = "altr,pio-17.1", "altr,pio-1.0";
++			compatible = "altr,pio-15.1", "altr,pio-1.0";
+ 			reg = <0x00000001 0x00005000 0x00000010>;
+-			clocks = <0x2>;
+-			altr,gpio-bank-width = <10>;	/* embeddedsw.dts.params.altr,gpio-bank-width type NUMBER */
+-			resetvalue = <0>;	/* embeddedsw.dts.params.resetvalue type NUMBER */
+-			#gpio-cells = <2>;
++			interrupt-parent = <&intc>;
++			interrupts = <0 42 1>;
++			altr,gpio-bank-width = <0x2>;
++			altr,interrupt-type = <0x2>;
++			altr,interrupt_type = <0x2>;
++			edge_type = <0x1>;
++			level_trigger = <0x0>;
++			resetvalue = <0x0>;
++			#gpio-cells = <0x2>;
+ 			gpio-controller;
+-		}; //end gpio@0x100010040 (led_pio)
++		};// (button_pio)
+ 
+ 		ilc@0x100030000 {
+ 			compatible = "altr,altera_ilc-15.1", "altr,ilc-1.0";
+ 			reg = <0x00000001 0x00030000 0x00000100>;
++			interrupt-parent = <&intc>;
++			interrupts = <0 0 4 0 2 1 0 1 1 0 3 4 0 4 4>;
++			interrupt-names = "jtag_uart", "button_pio", "dipsw_pio", "uioreg_io_0", "socmidi_0";
+ 			interrupt-controller;
+ 			#interrupt-cells = <0x1>;
+ 			altr,sw-fifo-depth = <0x20>;
+@@ -206,7 +206,7 @@
+ 		uio-socfpg0@0x100040000 {
+ 			compatible = "generic-uio,ui_pdrv";
+ 			reg = <0x00000001 0x00040000 0x00010000>;
+-			interrupt-parent = <0x2>;
++			interrupt-parent = <&intc>;
+ 			interrupts = <0 43 4>;
+ 			address_width = <14>;
+ 			data_width = <32>;
+@@ -215,8 +215,8 @@
+ 		socmidi@0x100050000 {
+ 			compatible = "holotr,socsynth-midi";
+ 			reg = <0x00000001 0x00050000 0x00010000>;
+-			interrupt-parent = <0x2>;
+-/*			interrupts = <0 44 4>;*/
++			interrupt-parent = <&intc>;
++			interrupts = <0 44 4>;
+ 			address_width = <3>;   /* embeddedsw.dts.params.address_width type NUMBER */
+ 			data_width = <8>;      /* embeddedsw.dts.params.data_width type NUMBER */
+ 		};
+@@ -269,7 +269,7 @@
+ 		compatible = "adi,adxl345";
+ 		reg = <0x53>;
+ 
+-		interrupt-parent = <&portc>;
++		interrupt-parent = <&intc>;
+ 		interrupts = <3 2>;
+ 	};
+ };
+-- 
+2.7.4
+
diff --git a/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0023-Add-builtin-audio-codec-driver-for-DE1-DE10-SoC-wm87.patch b/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0023-Add-builtin-audio-codec-driver-for-DE1-DE10-SoC-wm87.patch
new file mode 100644
index 0000000..b1d8b54
--- /dev/null
+++ b/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/0023-Add-builtin-audio-codec-driver-for-DE1-DE10-SoC-wm87.patch
@@ -0,0 +1,752 @@
+From 00c5c9fd98255f383e14ccf0603c9779f3179062 Mon Sep 17 00:00:00 2001
+From: Michael Brown <producer@holotronic.dk>
+Date: Sat, 2 Jun 2018 22:56:31 +0200
+Subject: [PATCH 23/23] Add builtin audio codec driver for DE1/DE10 SoC
+ (wm8731) Add Audio and framebuffer Supporting device trees xga and hd
+ versions
+
+Signed-off-by: Michael Brown <producer@holotronic.dk>
+---
+ arch/arm/boot/dts/Makefile                         |   2 +
+ .../boot/dts/socfpga_cyclone5_de1_soc_aud_fb.dts   | 194 ++++++++++++++++
+ .../dts/socfpga_cyclone5_de1_soc_aud_fb_hd.dts     | 194 ++++++++++++++++
+ arch/arm/configs/socfpga_defconfig                 |   3 +-
+ sound/soc/socsynth/Kconfig                         |   9 +-
+ sound/soc/socsynth/Makefile                        |   5 +-
+ sound/soc/socsynth/de1x-soc-wm8731.c               | 251 +++++++++++++++++++++
+ 7 files changed, 655 insertions(+), 3 deletions(-)
+ create mode 100644 arch/arm/boot/dts/socfpga_cyclone5_de1_soc_aud_fb.dts
+ create mode 100644 arch/arm/boot/dts/socfpga_cyclone5_de1_soc_aud_fb_hd.dts
+ create mode 100644 sound/soc/socsynth/de1x-soc-wm8731.c
+
+diff --git a/arch/arm/boot/dts/Makefile b/arch/arm/boot/dts/Makefile
+index 748b068..cd54d8e 100644
+--- a/arch/arm/boot/dts/Makefile
++++ b/arch/arm/boot/dts/Makefile
+@@ -705,6 +705,8 @@ dtb-$(CONFIG_ARCH_SOCFPGA) += \
+ 	socfpga_cyclone5_de10_nano_uio_aud_fbii_hd.dtb \
+ 	socfpga_cyclone5_de10_nano.dtb \
+ 	socfpga_cyclone5_de1_soc.dtb \
++	socfpga_cyclone5_de1_soc_aud_fb.dtb \
++	socfpga_cyclone5_de1_soc_aud_fb_hd.dtb \
+ 	socfpga_cyclone5_de1_soc_fbii.dtb \
+ 	socfpga_cyclone5_sockit.dtb \
+ 	socfpga_cyclone5_socrates.dtb \
+diff --git a/arch/arm/boot/dts/socfpga_cyclone5_de1_soc_aud_fb.dts b/arch/arm/boot/dts/socfpga_cyclone5_de1_soc_aud_fb.dts
+new file mode 100644
+index 0000000..4fb724a
+--- /dev/null
++++ b/arch/arm/boot/dts/socfpga_cyclone5_de1_soc_aud_fb.dts
+@@ -0,0 +1,194 @@
++/*
++ *  Copyright (C) 2013 Steffen Trumtrar <s.trumtrar@pengutronix.de>
++ *  Copyright (C) 2016 Stephen Arnold <nerdboy@gentoo.org>
++ *
++ * This program is free software; you can redistribute it and/or modify
++ * it under the terms of the GNU General Public License as published by
++ * the Free Software Foundation; either version 2 of the License, or
++ * (at your option) any later version.
++ *
++ * This program is distributed in the hope that it will be useful,
++ * but WITHOUT ANY WARRANTY; without even the implied warranty of
++ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
++ * GNU General Public License for more details.
++ *
++ * You should have received a copy of the GNU General Public License
++ * along with this program.  If not, see <http://www.gnu.org/licenses/>.
++ */
++
++#include "socfpga_cyclone5.dtsi"
++
++/ {
++	model = "Terasic DE1-SoC";
++	compatible = "altr,socfpga-cyclone5", "altr,socfpga";
++
++	chosen {
++		bootargs = "earlyprintk";
++		stdout-path = "serial0:115200n8";
++	};
++
++	memory {
++		name = "memory";
++		device_type = "memory";
++		reg = <0x0 0x40000000>; /* 1GB */
++	};
++
++	aliases {
++		ethernet0 = &gmac1;
++	};
++
++	regulator_3_3v: 3-3-v-regulator {
++		compatible = "regulator-fixed";
++		regulator-name = "3.3V";
++		regulator-min-microvolt = <3300000>;
++		regulator-max-microvolt = <3300000>;
++	};
++
++	leds {
++		compatible = "gpio-leds";
++		hps0 {
++			label = "hps_led0";
++			gpios = <&portb 24 0>;
++			linux,default-trigger = "heartbeat";
++		};
++	};
++
++	keys {
++		compatible = "gpio-keys";
++		hps0 {
++			label = "hps_key0";
++			gpios = <&portb 25 0>;
++			linux,code = <63>;
++			debounce-interval = <50>;
++		};
++	};
++
++	sound {
++		compatible = "opencores,de1soc-wm8731-audio";
++		i2s-controller = <&i2s>;
++		audio-codec = <&wm8731>;
++		i2c-mux-gpio = <&portb 19 0>;
++	};
++
++	clk48: clk48 {
++		compatible = "fixed-clock";
++		#clock-cells = <0>;
++		clock-frequency  = <24576000>;
++		clock-output-names = "clk48";
++	};
++
++	clk44: clk44 {
++		compatible = "fixed-clock";
++		#clock-cells = <0>;
++		clock-frequency  = <33868800>;
++		clock-output-names = "clk44";
++	};
++
++	i2s: i2s@0x0 {
++		#sound-dai-cells = <1>;
++		compatible = "opencores,i2s";
++		reg = <0xff200000 0x20>, <0xff200020 0x20>;
++		clocks = <&clk44>, <&clk48>;
++		clock-names = "clk44", "clk48";
++		dmas = <&pdma 0>, <&pdma 1>;
++		dma-names = "tx", "rx";
++	};
++
++	bridge@0xc0000000 {
++		compatible = "altr,bridge-15.1", "simple-bus";
++		reg = <0xc0000000 0x20000000 0xff200000 0x200000>;
++		bridge-enable = <1>;
++		#address-cells = <0x2>;
++		#size-cells = <0x1>;
++		ranges = <0x00000001 0x00001000 0xff201000 0x00000008>,
++			<0x00000001 0x00031000 0xff231000 0x00000080>;
++
++		sysid@0x100001000 {
++			compatible = "altr,sysid-15.1", "altr,sysid-1.0";
++			reg = <0x00000001 0x00001000 0x00000008>;
++			id = <2899645186>;
++			timestamp = <1524157570>;
++		};
++
++		vip@0x100031000 {
++			compatible = "altr,vip-frame-reader-1.0", "ALTR,vip-frame-reader-14.0";
++			reg = <0x00000001 0x00031000 0x00000080>;
++			max-width = <1024>;
++			max-height = <768>;
++			bits-per-color = <0x8>;
++			colors-per-beat = <0x4>;
++			beats-per-pixel = <0x1>;
++			mem-word-width = <0x80>;
++		};
++	};
++};
++
++&gmac1 {
++	status = "okay";
++	phy-mode = "rgmii";
++
++	txd0-skew-ps = <0>; /* -420ps */
++	txd1-skew-ps = <0>; /* -420ps */
++	txd2-skew-ps = <0>; /* -420ps */
++	txd3-skew-ps = <0>; /* -420ps */
++	rxd0-skew-ps = <420>; /* 0ps */
++	rxd1-skew-ps = <420>; /* 0ps */
++	rxd2-skew-ps = <420>; /* 0ps */
++	rxd3-skew-ps = <420>; /* 0ps */
++	txen-skew-ps = <0>; /* -420ps */
++	txc-skew-ps = <1860>; /* 960ps */
++	rxdv-skew-ps = <420>; /* 0ps */
++	rxc-skew-ps = <1680>; /* 780ps */
++
++	max-frame-size = <3800>;
++};
++
++&gpio0 {
++	status = "okay";
++};
++
++&gpio1 {
++	status = "okay";
++};
++
++&gpio2 {
++	status = "okay";
++};
++
++&i2c0 {
++	status = "okay";
++	speed-mode = <0>;
++
++	wm8731: wm8731@34 {
++		#sound-dai-cells = <0>;
++		compatible = "wlf,wm8731";
++		reg = <0x1a>;
++	};
++
++	adxl345: adxl345@0 {
++		compatible = "adi,adxl345";
++		reg = <0x53>;
++
++		interrupt-parent = <&portc>;
++		interrupts = <3 2>;
++	};
++};
++
++&i2c1 {
++	status = "okay";
++	speed-mode = <0>;
++};
++
++&mmc0 {
++	vmmc-supply = <&regulator_3_3v>;
++	vqmmc-supply = <&regulator_3_3v>;
++	status = "okay";
++};
++
++&uart0 {
++	status = "okay";
++};
++
++&usb1 {
++	status = "okay";
++};
+diff --git a/arch/arm/boot/dts/socfpga_cyclone5_de1_soc_aud_fb_hd.dts b/arch/arm/boot/dts/socfpga_cyclone5_de1_soc_aud_fb_hd.dts
+new file mode 100644
+index 0000000..ecebb6e
+--- /dev/null
++++ b/arch/arm/boot/dts/socfpga_cyclone5_de1_soc_aud_fb_hd.dts
+@@ -0,0 +1,194 @@
++/*
++ *  Copyright (C) 2013 Steffen Trumtrar <s.trumtrar@pengutronix.de>
++ *  Copyright (C) 2016 Stephen Arnold <nerdboy@gentoo.org>
++ *
++ * This program is free software; you can redistribute it and/or modify
++ * it under the terms of the GNU General Public License as published by
++ * the Free Software Foundation; either version 2 of the License, or
++ * (at your option) any later version.
++ *
++ * This program is distributed in the hope that it will be useful,
++ * but WITHOUT ANY WARRANTY; without even the implied warranty of
++ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
++ * GNU General Public License for more details.
++ *
++ * You should have received a copy of the GNU General Public License
++ * along with this program.  If not, see <http://www.gnu.org/licenses/>.
++ */
++
++#include "socfpga_cyclone5.dtsi"
++
++/ {
++	model = "Terasic DE1-SoC";
++	compatible = "altr,socfpga-cyclone5", "altr,socfpga";
++
++	chosen {
++		bootargs = "earlyprintk";
++		stdout-path = "serial0:115200n8";
++	};
++
++	memory {
++		name = "memory";
++		device_type = "memory";
++		reg = <0x0 0x40000000>; /* 1GB */
++	};
++
++	aliases {
++		ethernet0 = &gmac1;
++	};
++
++	regulator_3_3v: 3-3-v-regulator {
++		compatible = "regulator-fixed";
++		regulator-name = "3.3V";
++		regulator-min-microvolt = <3300000>;
++		regulator-max-microvolt = <3300000>;
++	};
++
++	leds {
++		compatible = "gpio-leds";
++		hps0 {
++			label = "hps_led0";
++			gpios = <&portb 24 0>;
++			linux,default-trigger = "heartbeat";
++		};
++	};
++
++	keys {
++		compatible = "gpio-keys";
++		hps0 {
++			label = "hps_key0";
++			gpios = <&portb 25 0>;
++			linux,code = <63>;
++			debounce-interval = <50>;
++		};
++	};
++
++	sound {
++		compatible = "opencores,de1soc-wm8731-audio";
++		i2s-controller = <&i2s>;
++		audio-codec = <&wm8731>;
++		i2c-mux-gpio = <&portb 19 0>;
++	};
++
++	clk48: clk48 {
++		compatible = "fixed-clock";
++		#clock-cells = <0>;
++		clock-frequency  = <24576000>;
++		clock-output-names = "clk48";
++	};
++
++	clk44: clk44 {
++		compatible = "fixed-clock";
++		#clock-cells = <0>;
++		clock-frequency  = <33868800>;
++		clock-output-names = "clk44";
++	};
++
++	i2s: i2s@0x0 {
++		#sound-dai-cells = <1>;
++		compatible = "opencores,i2s";
++		reg = <0xff200000 0x20>, <0xff200020 0x20>;
++		clocks = <&clk44>, <&clk48>;
++		clock-names = "clk44", "clk48";
++		dmas = <&pdma 0>, <&pdma 1>;
++		dma-names = "tx", "rx";
++	};
++
++	bridge@0xc0000000 {
++		compatible = "altr,bridge-15.1", "simple-bus";
++		reg = <0xc0000000 0x20000000 0xff200000 0x200000>;
++		bridge-enable = <1>;
++		#address-cells = <0x2>;
++		#size-cells = <0x1>;
++		ranges = <0x00000001 0x00001000 0xff201000 0x00000008>,
++			<0x00000001 0x00031000 0xff231000 0x00000080>;
++
++		sysid@0x100001000 {
++			compatible = "altr,sysid-15.1", "altr,sysid-1.0";
++			reg = <0x00000001 0x00001000 0x00000008>;
++			id = <2899645186>;
++			timestamp = <1524157570>;
++		};
++
++		vip@0x100031000 {
++			compatible = "altr,vip-frame-reader-1.0", "ALTR,vip-frame-reader-14.0";
++			reg = <0x00000001 0x00031000 0x00000080>;
++			max-width = <1920>;
++			max-height = <1080>;
++			bits-per-color = <0x8>;
++			colors-per-beat = <0x4>;
++			beats-per-pixel = <0x1>;
++			mem-word-width = <0x80>;
++		};
++	};
++};
++
++&gmac1 {
++	status = "okay";
++	phy-mode = "rgmii";
++
++	txd0-skew-ps = <0>; /* -420ps */
++	txd1-skew-ps = <0>; /* -420ps */
++	txd2-skew-ps = <0>; /* -420ps */
++	txd3-skew-ps = <0>; /* -420ps */
++	rxd0-skew-ps = <420>; /* 0ps */
++	rxd1-skew-ps = <420>; /* 0ps */
++	rxd2-skew-ps = <420>; /* 0ps */
++	rxd3-skew-ps = <420>; /* 0ps */
++	txen-skew-ps = <0>; /* -420ps */
++	txc-skew-ps = <1860>; /* 960ps */
++	rxdv-skew-ps = <420>; /* 0ps */
++	rxc-skew-ps = <1680>; /* 780ps */
++
++	max-frame-size = <3800>;
++};
++
++&gpio0 {
++	status = "okay";
++};
++
++&gpio1 {
++	status = "okay";
++};
++
++&gpio2 {
++	status = "okay";
++};
++
++&i2c0 {
++	status = "okay";
++	speed-mode = <0>;
++
++	wm8731: wm8731@34 {
++		#sound-dai-cells = <0>;
++		compatible = "wlf,wm8731";
++		reg = <0x1a>;
++	};
++
++	adxl345: adxl345@0 {
++		compatible = "adi,adxl345";
++		reg = <0x53>;
++
++		interrupt-parent = <&portc>;
++		interrupts = <3 2>;
++	};
++};
++
++&i2c1 {
++	status = "okay";
++	speed-mode = <0>;
++};
++
++&mmc0 {
++	vmmc-supply = <&regulator_3_3v>;
++	vqmmc-supply = <&regulator_3_3v>;
++	status = "okay";
++};
++
++&uart0 {
++	status = "okay";
++};
++
++&usb1 {
++	status = "okay";
++};
+diff --git a/arch/arm/configs/socfpga_defconfig b/arch/arm/configs/socfpga_defconfig
+index 25f92bd..4917baf 100644
+--- a/arch/arm/configs/socfpga_defconfig
++++ b/arch/arm/configs/socfpga_defconfig
+@@ -308,7 +308,8 @@ CONFIG_SND_SOC_SSM2602=m
+ CONFIG_SND_SOC_SSM2602_I2C=m
+ CONFIG_SND_ALOOP=m
+ CONFIG_SND_VIRMIDI=m
+-CONFIG_SND_SOC_DE1_WM8731_HSYNTH=m
++CONFIG_SND_SOC_DE1x_WM8731=m
++CONFIG_SND_SOC_DE1x_WM8731_HSYNTH=m
+ CONFIG_SND_SOC_HSYNTH_MIDI=m
+ CONFIG_SND_SOC_PCM5102A=m
+ CONFIG_SND_SOC_PCM5102_HSYNTH=m
+diff --git a/sound/soc/socsynth/Kconfig b/sound/soc/socsynth/Kconfig
+index 5d71a4e..b6b7dec 100644
+--- a/sound/soc/socsynth/Kconfig
++++ b/sound/soc/socsynth/Kconfig
+@@ -16,7 +16,7 @@ config SND_SOC_HSYNTHDMA
+          This driver can also be built as a module.  If so, the module
+          will be called hsynthdma.
+ 
+-config SND_SOC_DE1_WM8731_HSYNTH
++config SND_SOC_DE1x_WM8731_HSYNTH
+        tristate "DE1-Audio MIDI support"
+        select SND_SOC_WM8731
+        select SND_SOC_OC_I2S
+@@ -34,3 +34,10 @@ config SND_SOC_PCM5102_HSYNTH
+        select SND_SOC_OC_I2S
+        select SND_SOC_GENERIC_DMAENGINE_PCM
+        select REGMAP_MMIO
++
++config SND_SOC_DE1x_WM8731
++       tristate "DE1x-Builtin-Audio support"
++       select SND_SOC_WM8731
++       select SND_SOC_OC_I2S
++       select SND_SOC_GENERIC_DMAENGINE_PCM
++       select REGMAP_MMIO
+diff --git a/sound/soc/socsynth/Makefile b/sound/soc/socsynth/Makefile
+index 2043f43d..69fb2aa 100644
+--- a/sound/soc/socsynth/Makefile
++++ b/sound/soc/socsynth/Makefile
+@@ -2,7 +2,7 @@ snd-soc-opencores_i2s-objs := opencores_i2s.o
+ obj-$(CONFIG_SND_SOC_OC_I2S) += snd-soc-opencores_i2s.o
+ 
+ snd-de1-soc-wm8731-hsynth-objs := de1-soc-wm8731-hsynth.o
+-obj-$(CONFIG_SND_SOC_DE1_WM8731_HSYNTH) += snd-de1-soc-wm8731-hsynth.o
++obj-$(CONFIG_SND_SOC_DE1x_WM8731_HSYNTH) += snd-de1-soc-wm8731-hsynth.o
+ 
+ snd-soc-hsynthdma-objs := hsynthdma.o
+ obj-$(CONFIG_SND_SOC_HSYNTHDMA) += snd-soc-hsynthdma.o
+@@ -12,3 +12,6 @@ obj-$(CONFIG_SND_SOC_HSYNTH_MIDI) += snd-soc-hsynth-midi.o
+ 
+ snd-pcm5102-hsynth-objs := pcm5102-hsynth.o
+ obj-$(CONFIG_SND_SOC_PCM5102_HSYNTH) += snd-pcm5102-hsynth.o
++
++snd-soc-de1x-soc-wm8731-objs := de1x-soc-wm8731.o
++obj-$(CONFIG_SND_SOC_DE1x_WM8731) += snd-soc-de1x-soc-wm8731.o
+diff --git a/sound/soc/socsynth/de1x-soc-wm8731.c b/sound/soc/socsynth/de1x-soc-wm8731.c
+new file mode 100644
+index 0000000..e297ef4
+--- /dev/null
++++ b/sound/soc/socsynth/de1x-soc-wm8731.c
+@@ -0,0 +1,251 @@
++/*
++ * de1-soc-wm8731 -- SoC audio for Terasic DE1-SoC board
++ * Author: B. Steinsbo <bsteinsbo@gmail.com>
++ *
++ * Based on sam9g20_wm8731 by
++ * Sedji Gaouaou <sedji.gaouaou@atmel.com>
++ *
++ * Licensed under the GPL-2.
++ */
++
++#include <linux/module.h>
++#include <linux/kernel.h>
++#include <linux/clk.h>
++#include <linux/platform_device.h>
++#include <linux/of.h>
++#include <linux/gpio.h>
++#include <linux/of_gpio.h>
++#include <linux/uaccess.h>
++#include <linux/ioport.h>
++#include <linux/io.h>
++
++#include <sound/core.h>
++#include <sound/pcm.h>
++#include <sound/pcm_params.h>
++#include <sound/soc.h>
++#include <sound/initval.h>
++
++#define WM8731_SYSCLK_XTAL 1
++#define WM8731_SYSCLK_MCLK 2
++#define MCLK_RATE_48K 12288000 /* fs*256 */
++#define MCLK_RATE_44K 16934400 /* fs*384 */
++
++static unsigned int i2c_mux_gpio;
++
++static int de1soc_hw_params(struct snd_pcm_substream *substream,
++	struct snd_pcm_hw_params *params)
++{
++	struct snd_soc_pcm_runtime *rtd = substream->private_data;
++	struct snd_soc_dai *codec_dai = rtd->codec_dai;
++	struct device *dev = rtd->card->dev;
++	unsigned int mclk_freq;
++	int ret;
++
++	if ((params_rate(params) % 44100) == 0) {
++		mclk_freq = MCLK_RATE_44K;
++	} else if ((params_rate(params) % 48000) == 0) {
++		mclk_freq = MCLK_RATE_48K;
++	} else
++		return -EINVAL;
++
++	/* set codec mclk configuration */
++	ret = snd_soc_dai_set_sysclk(codec_dai, WM8731_SYSCLK_MCLK,
++		mclk_freq, SND_SOC_CLOCK_OUT);
++	if (ret < 0)
++		return ret;
++
++	dev_dbg(dev, "hw_params: mclk_freq=%d\n", mclk_freq);
++	return 0;
++}
++
++static void de1soc_shutdown(struct snd_pcm_substream *substream)
++{
++	struct snd_soc_pcm_runtime *rtd = substream->private_data;
++	struct snd_soc_dai *codec_dai = rtd->codec_dai;
++	struct device *dev = rtd->card->dev;
++	int ret;
++
++	dev_dbg(dev, "shutdown\n");
++	ret = snd_soc_dai_set_sysclk(codec_dai, WM8731_SYSCLK_MCLK,
++		0, SND_SOC_CLOCK_OUT);
++	if (ret < 0) {
++		dev_err(dev, "Failed to reset WM8731 SYSCLK: %d\n", ret);
++	}
++}
++
++static struct snd_soc_ops de1soc_ops = {
++	// .startup
++	.shutdown = de1soc_shutdown,
++	.hw_params = de1soc_hw_params,
++	// .hw_free
++	// .prepare
++	// .trigger
++};
++
++static const struct snd_soc_dapm_widget de1soc_dapm_widgets[] = {
++	SND_SOC_DAPM_HP("Headphone Jack", NULL),
++	SND_SOC_DAPM_MIC("Microphone Jack", NULL),
++	SND_SOC_DAPM_LINE("Line In Jack", NULL),
++	SND_SOC_DAPM_LINE("Line Out Jack", NULL),
++};
++
++static const struct snd_soc_dapm_route intercon[] = {
++	{"MICIN", NULL, "Mic Bias"},
++	{"Mic Bias", NULL, "Microphone Jack"},
++	{"LLINEIN", NULL, "Line In Jack"},
++	{"RLINEIN", NULL, "Line In Jack"},
++	{"Line Out Jack", NULL, "LOUT"},
++	{"Line Out Jack", NULL, "ROUT"},
++	{"Headphone Jack", NULL, "LHPOUT"},
++	{"Headphone Jack", NULL, "RHPOUT"},
++};
++
++static int de1soc_wm8731_init(struct snd_soc_pcm_runtime *rtd)
++{
++	struct snd_soc_dai *codec_dai = rtd->codec_dai;
++	struct snd_soc_dai *cpu_dai = rtd->cpu_dai;
++	struct device *dev = rtd->card->dev;
++	unsigned int fmt;
++	int ret;
++
++	dev_dbg(dev, "init\n");
++
++	fmt = SND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_NB_NF |
++	      SND_SOC_DAIFMT_CBS_CFS;
++
++	/* set cpu DAI configuration */
++	ret = snd_soc_dai_set_fmt(cpu_dai, fmt);
++	if (ret < 0)
++		return ret;
++
++	/* set codec DAI configuration */
++	ret = snd_soc_dai_set_fmt(codec_dai, fmt);
++	if (ret < 0)
++		return ret;
++
++	/* Don't let codec constraints interfere */
++	ret = snd_soc_dai_set_sysclk(codec_dai, WM8731_SYSCLK_MCLK,
++		0, SND_SOC_CLOCK_OUT);
++	if (ret < 0) {
++		dev_err(dev, "Failed to set WM8731 SYSCLK: %d\n", ret);
++		return ret;
++	}
++
++	return 0;
++}
++
++static struct snd_soc_dai_link de1soc_dai = {
++	.name = "WM8731",
++	.stream_name = "WM8731 PCM",
++	.cpu_dai_name = "ff200000.i2s",
++	.codec_dai_name = "wm8731-hifi",
++	.init = de1soc_wm8731_init,
++	.platform_name = "de1soc",
++	.codec_name = "wm8731.0-001a",
++	.ops = &de1soc_ops,
++};
++
++static struct snd_soc_card snd_soc_de1soc = {
++	.name = "DE1SOC-WM8731",
++	.owner = THIS_MODULE,
++	.dai_link = &de1soc_dai,
++	.num_links = 1,
++
++	.dapm_widgets = de1soc_dapm_widgets,
++	.num_dapm_widgets = ARRAY_SIZE(de1soc_dapm_widgets),
++	.dapm_routes = intercon,
++	.num_dapm_routes = ARRAY_SIZE(intercon),
++};
++
++static int de1soc_audio_probe(struct platform_device *pdev)
++{
++	struct device_node *np = pdev->dev.of_node;
++	struct device_node *codec_np, *cpu_np;
++	struct snd_soc_card *card = &snd_soc_de1soc;
++	int ret;
++
++	if (!np) {
++		return -ENODEV;
++	}
++
++	card->dev = &pdev->dev;
++
++	/* I2C bus is muxed between HPS and FPGA. Set mux to HPS */
++	i2c_mux_gpio = of_get_named_gpio(np, "i2c-mux-gpio", 0);
++	if (gpio_is_valid(i2c_mux_gpio)) {
++		ret = devm_gpio_request_one(&pdev->dev,
++			i2c_mux_gpio, GPIOF_OUT_INIT_LOW, "I2C_MUX");
++		if (ret) {
++			dev_err(&pdev->dev,
++				"Failed to request GPIO_%d for i2c_mux: %d\n",
++				i2c_mux_gpio, ret);
++			return ret;
++		}
++		gpio_set_value(i2c_mux_gpio, 1);
++	}
++
++	/* Parse codec info */
++	de1soc_dai.codec_name = NULL;
++	codec_np = of_parse_phandle(np, "audio-codec", 0);
++	if (!codec_np) {
++		dev_err(&pdev->dev, "codec info missing\n");
++		return -EINVAL;
++	}
++	de1soc_dai.codec_of_node = codec_np;
++
++	/* Parse dai and platform info */
++	de1soc_dai.cpu_dai_name = NULL;
++	de1soc_dai.platform_name = NULL;
++	cpu_np = of_parse_phandle(np, "i2s-controller", 0);
++	if (!cpu_np) {
++		dev_err(&pdev->dev, "dai and pcm info missing\n");
++		return -EINVAL;
++	}
++	de1soc_dai.cpu_of_node = cpu_np;
++	de1soc_dai.platform_of_node = cpu_np;
++
++	of_node_put(codec_np);
++	of_node_put(cpu_np);
++
++	ret = snd_soc_register_card(card);
++	if (ret) {
++		dev_err(&pdev->dev, "snd_soc_register_card() failed\n");
++	}
++
++	return ret;
++}
++
++static int de1soc_audio_remove(struct platform_device *pdev)
++{
++	struct snd_soc_card *card = platform_get_drvdata(pdev);
++
++	if (gpio_is_valid(i2c_mux_gpio))
++		devm_gpio_free(&pdev->dev, i2c_mux_gpio);
++
++	snd_soc_unregister_card(card);
++
++	return 0;
++}
++
++static const struct of_device_id de1soc_wm8731_dt_ids[] = {
++	{ .compatible = "opencores,de1soc-wm8731-audio", },
++	{ }
++};
++MODULE_DEVICE_TABLE(of, de1soc_wm8731_dt_ids);
++
++static struct platform_driver de1soc_audio_driver = {
++	.driver = {
++		.name	= "de1soc-audio",
++		.owner	= THIS_MODULE,
++		.of_match_table = of_match_ptr(de1soc_wm8731_dt_ids),
++	},
++	.probe	= de1soc_audio_probe,
++	.remove	= de1soc_audio_remove,
++};
++
++module_platform_driver(de1soc_audio_driver);
++
++/* Module information */
++MODULE_AUTHOR("Bjarne Steinsbo <bsteinsbo@gmail.com>");
++MODULE_DESCRIPTION("ALSA SoC DE1-SoC_WM8731");
++MODULE_LICENSE("GPL");
+-- 
+2.7.4
+
diff --git a/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/socfpga-4.9.76-ltsi-rt-changeset.patch b/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/socfpga-4.9.76-ltsi-rt-changeset.patch
index 1e8bc13..4540ce3 100644
--- a/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/socfpga-4.9.76-ltsi-rt-changeset.patch
+++ b/SD-Image-Gen/patches/4.9.76-ltsi-rt/current/socfpga-4.9.76-ltsi-rt-changeset.patch
@@ -1,7 +1,7 @@
-From 753ed154e5ec9bb74e8cfbc2191e06d88edb7dfd Mon Sep 17 00:00:00 2001
+From 8436e6d11733f7722c649f5ab656422cfbc77e9d Mon Sep 17 00:00:00 2001
 From: Michael Brown <producer@holotronic.dk>
 Date: Wed, 7 Mar 2018 14:14:18 +0100
-Subject: [PATCH 01/18] disable debug package gen
+Subject: [PATCH 01/23] disable debug package gen
 
 Signed-off-by: Michael Brown <producer@holotronic.dk>
 ---
@@ -25,10 +25,10 @@ index 5c8c02f..31148aa 100644
 2.7.4
 
 
-From 72b399286411702969d7c125e80556c75be5be5a Mon Sep 17 00:00:00 2001
+From f5e04b4bf29c5c9b8ae8fe195bb31de79f57cf81 Mon Sep 17 00:00:00 2001
 From: Michael Brown <producer@holotronic.dk>
 Date: Tue, 1 May 2018 16:02:19 +0200
-Subject: [PATCH 02/18] Remove gittag from kernel (file) name(s)
+Subject: [PATCH 02/23] Remove gittag from kernel (file) name(s)
 
 Signed-off-by: Michael Brown <producer@holotronic.dk>
 ---
@@ -48,10 +48,10 @@ index 31148aa..d5758c6 100644
 2.7.4
 
 
-From 92122fd2c48ad2f375b5ac902a0d8dd473da33e7 Mon Sep 17 00:00:00 2001
+From 846ba91a9e0ace87e89bc3ef43a5a50276c602d8 Mon Sep 17 00:00:00 2001
 From: Michael Brown <producer@holotronic.dk>
 Date: Wed, 7 Mar 2018 14:21:56 +0100
-Subject: [PATCH 03/18] add ext4 root fs support and autofs4 module
+Subject: [PATCH 03/23] add ext4 root fs support and autofs4 module
 
 Signed-off-by: Michael Brown <producer@holotronic.dk>
 ---
@@ -87,10 +87,10 @@ index d5758c6..5ac78d2 100644
 2.7.4
 
 
-From 6750877c0d2f8d926371e082a92bd0b8ddd713fe Mon Sep 17 00:00:00 2001
+From 9b9b15cf7dc4fc65305c1e83d3b21be1792f2bb8 Mon Sep 17 00:00:00 2001
 From: Michael Brown <producer@holotronic.dk>
 Date: Wed, 7 Mar 2018 14:26:50 +0100
-Subject: [PATCH 04/18] add .dtd files to kernel-image .deb
+Subject: [PATCH 04/23] add .dtd files to kernel-image .deb
 
 Signed-off-by: Michael Brown <producer@holotronic.dk>
 ---
@@ -125,10 +125,10 @@ index 3c575cd0..d67c791 100755
 2.7.4
 
 
-From 56da1f23868444b69807ed2be18c34555d34d59d Mon Sep 17 00:00:00 2001
+From 5dddb22b4ddfad71e67e9447056a3fefe9885a8f Mon Sep 17 00:00:00 2001
 From: Michael Brown <producer@holotronic.dk>
 Date: Wed, 7 Mar 2018 14:33:44 +0100
-Subject: [PATCH 05/18] add generate /boot/extlinux/extlinux.conf and
+Subject: [PATCH 05/23] add generate /boot/extlinux/extlinux.conf and
  /boot/uEnv.txt for uboot boot info
 
 Signed-off-by: Michael Brown <producer@holotronic.dk>
@@ -172,10 +172,10 @@ index d67c791..d6a4058 100755
 2.7.4
 
 
-From 21c4c40eefc2114c91f11b4ce128a04069271d77 Mon Sep 17 00:00:00 2001
+From e5c216b26feb274bd10a4513675867cc1bee7e09 Mon Sep 17 00:00:00 2001
 From: Michael Brown <producer@holotronic.dk>
 Date: Wed, 7 Mar 2018 15:43:11 +0100
-Subject: [PATCH 06/18] add configfs and fpgacfg dts entities, and dynamic dts
+Subject: [PATCH 06/23] add configfs and fpgacfg dts entities, and dynamic dts
  overlay support
 
 Signed-off-by: Michael Brown <producer@holotronic.dk>
@@ -212,10 +212,10 @@ index 5ac78d2..44eb991 100644
 2.7.4
 
 
-From 11be59d2718ea5d5c5c2a246fcbb4bdf94e39cd1 Mon Sep 17 00:00:00 2001
+From f6f71473dbf253e78020ec251a55a186f1e4095c Mon Sep 17 00:00:00 2001
 From: Michael Brown <producer@holotronic.dk>
 Date: Sat, 10 Mar 2018 12:55:03 +0100
-Subject: [PATCH 07/18] rename kernel package names to *-socfpga-rt-ltsi
+Subject: [PATCH 07/23] rename kernel package names to *-socfpga-rt-ltsi
 
 Signed-off-by: Michael Brown <producer@holotronic.dk>
 ---
@@ -243,10 +243,10 @@ index d6a4058..ee58811 100755
 2.7.4
 
 
-From 0794b2392204b60e5a1623df37c38b9c2b88dce1 Mon Sep 17 00:00:00 2001
+From ef472e6e5c416c0f4770c7966bf8b4a46d717154 Mon Sep 17 00:00:00 2001
 From: Michael Brown <producer@holotronic.dk>
 Date: Mon, 21 May 2018 13:19:43 +0200
-Subject: [PATCH 08/18] Enable bridges in dtb's
+Subject: [PATCH 08/23] Enable bridges in dtb's
 
 Signed-off-by: Michael Brown <producer@holotronic.dk>
 ---
@@ -277,10 +277,10 @@ index 595eb4f..3de276d 100644
 2.7.4
 
 
-From 78459a1ede4eb877df7b40fbfd2cd3462b002c11 Mon Sep 17 00:00:00 2001
+From 20ea6c604d6609dd913baa92228f9f8a23071e07 Mon Sep 17 00:00:00 2001
 From: Michael Brown <producer@holotronic.dk>
 Date: Sat, 10 Mar 2018 13:13:12 +0100
-Subject: [PATCH 09/18] add spidev in dts so driver is loaded
+Subject: [PATCH 09/23] add spidev in dts so driver is loaded
 
 Signed-off-by: Michael Brown <producer@holotronic.dk>
 ---
@@ -314,10 +314,10 @@ index 3de276d..dce1143 100644
 2.7.4
 
 
-From 068034f918fec37aae2427525d0d3a04592be91d Mon Sep 17 00:00:00 2001
+From 7d29dc2bf5391ce41cd1fb15503e2ec45c92a6b1 Mon Sep 17 00:00:00 2001
 From: Michael Brown <producer@holotronic.dk>
 Date: Mon, 12 Mar 2018 23:41:23 +0100
-Subject: [PATCH 10/18] set ACL secutity
+Subject: [PATCH 10/23] set ACL secutity
 
 Signed-off-by: Michael Brown <producer@holotronic.dk>
 ---
@@ -357,10 +357,10 @@ index 44eb991..bce72c2 100644
 2.7.4
 
 
-From 6579de47bf736ff969168f36ec8ab2a392ba9e77 Mon Sep 17 00:00:00 2001
+From 581ac795fff1e3da0419e26d1863a0c3e91ffe5b Mon Sep 17 00:00:00 2001
 From: Michael Brown <producer@holotronic.dk>
 Date: Fri, 30 Mar 2018 20:41:53 +0200
-Subject: [PATCH 11/18] Enable altvip framebuffer
+Subject: [PATCH 11/23] Enable altvip framebuffer
 
 Signed-off-by: Michael Brown <producer@holotronic.dk>
 ---
@@ -503,10 +503,10 @@ index bce72c2..ad7ca9d 100644
 2.7.4
 
 
-From b24ca38b38542e7ba7943d24793feb6ab2c527f4 Mon Sep 17 00:00:00 2001
+From 0b31761b59f5585494d7a80cb48c0828ae74fdcf Mon Sep 17 00:00:00 2001
 From: Michael Brown <producer@holotronic.dk>
 Date: Sun, 11 Mar 2018 22:21:04 +0100
-Subject: [PATCH 12/18] Added DE-10 Nano with uio, with/without framebuffer
+Subject: [PATCH 12/23] Added DE-10 Nano with uio, with/without framebuffer
  1024x768 and 1920x1080(hd) dts dtb
 
 Signed-off-by: Michael Brown <producer@holotronic.dk>
@@ -1098,10 +1098,10 @@ index 0000000..bfb2898
 2.7.4
 
 
-From 4c317d9daddfc01549805a6af599ce5c050e5a33 Mon Sep 17 00:00:00 2001
+From 286c1bb32267da0fa8ecd531f7da0b5b8801e400 Mon Sep 17 00:00:00 2001
 From: Michael Brown <producer@holotronic.dk>
 Date: Fri, 18 May 2018 20:35:35 +0200
-Subject: [PATCH 13/18] Add framebuffer-ii core driver based on Mister, and
+Subject: [PATCH 13/23] Add framebuffer-ii core driver based on Mister, and
  enable it
 
 Signed-off-by: Michael Brown <producer@holotronic.dk>
@@ -2006,10 +2006,10 @@ index 0000000..a80ae1a
 2.7.4
 
 
-From 2b77438809b377eeda2f10be8456131f74a3012c Mon Sep 17 00:00:00 2001
+From 7cdb53a7fcacdb48d60e71273bd0fb2f98b461ad Mon Sep 17 00:00:00 2001
 From: Michael Brown <producer@holotronic.dk>
 Date: Sun, 8 Apr 2018 22:39:54 +0200
-Subject: [PATCH 14/18] Add audio and midi drivers for holosynth and builtin
+Subject: [PATCH 14/23] Add audio and midi drivers for holosynth and builtin
  audio codec on de1 board
 
 Signed-off-by: Michael Brown <producer@holotronic.dk>
@@ -4307,10 +4307,10 @@ index 0000000..1f4268c
 2.7.4
 
 
-From e111e08bc321fddc1467ae86b86333a8ecddd9a9 Mon Sep 17 00:00:00 2001
+From bc57689674b257adc6fdbfe30ed8ae5aece86ace Mon Sep 17 00:00:00 2001
 From: Michael Brown <producer@holotronic.dk>
 Date: Thu, 17 May 2018 10:58:21 +0200
-Subject: [PATCH 15/18] Add Hsynth audio driver with Phat(pcm5102) audio output
+Subject: [PATCH 15/23] Add Hsynth audio driver with Phat(pcm5102) audio output
  Add vipii fb,pidac/hsynth audio dtb for DE10 Nano HD HDMI
 
 Signed-off-by: Michael Brown <producer@holotronic.dk>
@@ -5269,10 +5269,10 @@ index 0000000..2d56f0b
 2.7.4
 
 
-From 16af1e992897ccd80cc78854bae3510aca2d1a4b Mon Sep 17 00:00:00 2001
+From 24ae5222770099e114061e4faf89f754307cb67a Mon Sep 17 00:00:00 2001
 From: Michael Brown <producer@holotronic.dk>
 Date: Fri, 4 May 2018 14:32:56 +0200
-Subject: [PATCH 16/18] add vipii framebuffer dtb for de1_soc
+Subject: [PATCH 16/23] add vipii framebuffer dtb for de1_soc
 
 Signed-off-by: Michael Brown <producer@holotronic.dk>
 ---
@@ -5588,10 +5588,10 @@ index 0000000..225e461
 2.7.4
 
 
-From e174e8a81befdc588dc3a9d5d0d1dc04627388a8 Mon Sep 17 00:00:00 2001
+From 6429aafa9d4cc9edefce18997d3a0717649837df Mon Sep 17 00:00:00 2001
 From: Michael Brown <producer@holotronic.dk>
 Date: Thu, 24 May 2018 12:18:18 +0200
-Subject: [PATCH 17/18] div codec mods
+Subject: [PATCH 17/23] div codec mods
 
 Signed-off-by: Michael Brown <producer@holotronic.dk>
 ---
@@ -5741,10 +5741,10 @@ index 2d56f0b..3011c2b 100644
 2.7.4
 
 
-From 3c0876af357dd1a1bc29c0e20b48b3180f529fba Mon Sep 17 00:00:00 2001
+From cc48f298696a05c23fcb92ff4b8e0ddb769837b8 Mon Sep 17 00:00:00 2001
 From: Michael Brown <producer@holotronic.dk>
 Date: Sat, 26 May 2018 21:36:55 +0200
-Subject: [PATCH 18/18] Change uio port name Fix: for machinekit use
+Subject: [PATCH 18/23] Change uio port name Fix: for machinekit use
 
 Signed-off-by: Michael Brown <producer@holotronic.dk>
 ---
@@ -5781,3 +5781,1574 @@ index bfb2898..f6ba2c6 100644
 -- 
 2.7.4
 
+
+From 0c3b0fac1543c1f6c36f3a220da59ff54453887a Mon Sep 17 00:00:00 2001
+From: Michael Brown <producer@holotronic.dk>
+Date: Wed, 30 May 2018 12:33:08 +0200
+Subject: [PATCH 19/23] Terasic dev boards: Make core addresses in qsys
+ devicetrees consistant
+
+Signed-off-by: Michael Brown <producer@holotronic.dk>
+---
+ .../socfpga_cyclone5_de10_nano_uio_aud_fbii_hd.dts | 16 ++---
+ .../boot/dts/socfpga_cyclone5_de10_nano_uio_fb.dts | 14 ++---
+ .../dts/socfpga_cyclone5_de10_nano_uio_fb_hd.dts   | 14 ++---
+ arch/arm/boot/dts/socfpga_cyclone5_de1_soc.dts     | 71 ++++++++++++----------
+ .../arm/boot/dts/socfpga_cyclone5_de1_soc_fbii.dts | 40 ++++++------
+ 5 files changed, 82 insertions(+), 73 deletions(-)
+
+diff --git a/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_aud_fbii_hd.dts b/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_aud_fbii_hd.dts
+index 7e1acf9..1bf0892 100644
+--- a/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_aud_fbii_hd.dts
++++ b/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_aud_fbii_hd.dts
+@@ -103,14 +103,14 @@
+ 		#address-cells = <0x2>;
+ 		#size-cells = <0x1>;
+ 		ranges = <0x00000001 0x00001000 0xff201000 0x00000008>,
+-				<0x00000001 0x00002000 0xff202000 0x00000008>,
+-				<0x00000001 0x00003000 0xff203000 0x00000010>,
+-				<0x00000001 0x00004000 0xff204000 0x00000010>,
+-				<0x00000001 0x00005000 0xff205000 0x00000010>,
+-				<0x00000001 0x00030000 0xff230000 0x00000100>,
+-				<0x00000001 0x00031000 0xff231000 0x00000080>,
+-				<0x00000001 0x00040000 0xff240000 0x00010000>,
+-				<0x00000001 0x00050000 0xff250000 0x00010000>;
++			<0x00000001 0x00002000 0xff202000 0x00000008>,
++			<0x00000001 0x00003000 0xff203000 0x00000010>,
++			<0x00000001 0x00004000 0xff204000 0x00000010>,
++			<0x00000001 0x00005000 0xff205000 0x00000010>,
++			<0x00000001 0x00030000 0xff230000 0x00000100>,
++			<0x00000001 0x00031000 0xff231000 0x00000080>,
++			<0x00000001 0x00040000 0xff240000 0x00010000>,
++			<0x00000001 0x00050000 0xff250000 0x00010000>;
+ 
+ 		sysid@0x100001000 {
+ 			compatible = "altr,sysid-15.1", "altr,sysid-1.0";
+diff --git a/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_fb.dts b/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_fb.dts
+index be476a1..c05a7f7 100644
+--- a/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_fb.dts
++++ b/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_fb.dts
+@@ -67,13 +67,13 @@
+ 		#address-cells = <0x2>;
+ 		#size-cells = <0x1>;
+ 		ranges = <0x00000001 0x00001000 0xff201000 0x00000008>,
+-				<0x00000001 0x00002000 0xff202000 0x00000008>,
+-				<0x00000001 0x00003000 0xff203000 0x00000010>,
+-				<0x00000001 0x00004000 0xff204000 0x00000010>,
+-				<0x00000001 0x00005000 0xff205000 0x00000010>,
+-				<0x00000001 0x00030000 0xff230000 0x00000100>,
+-				<0x00000001 0x00031000 0xff231000 0x00000080>,
+-				<0x00000001 0x00040000 0xff240000 0x00010000>;
++			<0x00000001 0x00002000 0xff202000 0x00000008>,
++			<0x00000001 0x00003000 0xff203000 0x00000010>,
++			<0x00000001 0x00004000 0xff204000 0x00000010>,
++			<0x00000001 0x00005000 0xff205000 0x00000010>,
++			<0x00000001 0x00030000 0xff230000 0x00000100>,
++			<0x00000001 0x00031000 0xff231000 0x00000080>,
++			<0x00000001 0x00040000 0xff240000 0x00010000>;
+ 
+ 		sysid@0x100001000 {
+ 			compatible = "altr,sysid-15.1", "altr,sysid-1.0";
+diff --git a/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_fb_hd.dts b/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_fb_hd.dts
+index f6ba2c6..ce568a0 100644
+--- a/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_fb_hd.dts
++++ b/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_fb_hd.dts
+@@ -67,13 +67,13 @@
+ 		#address-cells = <0x2>;
+ 		#size-cells = <0x1>;
+ 		ranges = <0x00000001 0x00001000 0xff201000 0x00000008>,
+-				<0x00000001 0x00002000 0xff202000 0x00000008>,
+-				<0x00000001 0x00003000 0xff203000 0x00000010>,
+-				<0x00000001 0x00004000 0xff204000 0x00000010>,
+-				<0x00000001 0x00005000 0xff205000 0x00000010>,
+-				<0x00000001 0x00030000 0xff230000 0x00000100>,
+-				<0x00000001 0x00031000 0xff231000 0x00000080>,
+-				<0x00000001 0x00040000 0xff240000 0x00010000>;
++			<0x00000001 0x00002000 0xff202000 0x00000008>,
++			<0x00000001 0x00003000 0xff203000 0x00000010>,
++			<0x00000001 0x00004000 0xff204000 0x00000010>,
++			<0x00000001 0x00005000 0xff205000 0x00000010>,
++			<0x00000001 0x00030000 0xff230000 0x00000100>,
++			<0x00000001 0x00031000 0xff231000 0x00000080>,
++			<0x00000001 0x00040000 0xff240000 0x00010000>;
+ 
+ 		sysid@0x100001000 {
+ 			compatible = "altr,sysid-15.1", "altr,sysid-1.0";
+diff --git a/arch/arm/boot/dts/socfpga_cyclone5_de1_soc.dts b/arch/arm/boot/dts/socfpga_cyclone5_de1_soc.dts
+index d2b80e6..4925f44 100644
+--- a/arch/arm/boot/dts/socfpga_cyclone5_de1_soc.dts
++++ b/arch/arm/boot/dts/socfpga_cyclone5_de1_soc.dts
+@@ -117,44 +117,34 @@
+ 		bridge-enable = <1>;
+ 		#address-cells = <0x2>;
+ 		#size-cells = <0x1>;
+-		ranges = <0x00000001 0x00020000 0xff220000 0x00000008>,
++		ranges = <0x00000001 0x00001000 0xff201000 0x00000008>,
++			<0x00000001 0x00002000 0xff202000 0x00000008>,
++			<0x00000001 0x00003000 0xff203000 0x00000010>,
++			<0x00000001 0x00004000 0xff204000 0x00000010>,
++			<0x00000001 0x00005000 0xff205000 0x00000010>,
++			<0x00000001 0x00030000 0xff230000 0x00000100>,
+ 			<0x00000001 0x00031000 0xff231000 0x00000080>,
+-			<0x00000001 0x00010000 0xff210000 0x00000008>,
+-			<0x00000001 0x000100c0 0xff2100c0 0x00000010>,
+-			<0x00000001 0x00010080 0xff210080 0x00000010>,
+-			<0x00000001 0x00010040 0xff210040 0x00000010>,
+ 			<0x00000001 0x00040000 0xff240000 0x00010000>,
+ 			<0x00000001 0x00050000 0xff250000 0x00010000>;
+ 
+-		serial@0x100020000 {
++		sysid@0x100001000 {
++			compatible = "altr,sysid-15.1", "altr,sysid-1.0";
++			reg = <0x00000001 0x00001000 0x00000008>;
++			id = <2899645186>;
++			timestamp = <1524157570>;
++		};
++
++		serial@0x100002000 {
+ 			compatible = "altr,juart-17.1", "altr,juart-1.0";
+-			reg = <0x00000001 0x00020000 0x00000008>;
++			reg = <0x00000001 0x00002000 0x00000008>;
+ 			interrupt-parent = <0x2>;
+ 			interrupts = <0 40 4>;
+ 			clocks = <0x2>;
+ 		}; //end serial@0x100020000 (jtag_uart)
+ 
+-		vip@0x100031000 {
+-			compatible = "altr,vip-frame-reader-1.0", "ALTR,vip-frame-reader-14.0";
+-			reg = <0x00000001 0x00031000 0x00000080>;
+-			max-width = <0x556>;
+-			max-height = <0x300>;
+-			bits-per-color = <0x8>;
+-			colors-per-beat = <0x4>;
+-			beats-per-pixel = <0x1>;
+-			mem-word-width = <0x80>;
+-		};
+-
+-		sysid@0x100010000 {
+-			compatible = "altr,sysid-15.1", "altr,sysid-1.0";
+-			reg = <0x00000001 0x00010000 0x00000008>;
+-			id = <2899645186>;
+-			timestamp = <1524157570>;
+-		};
+-
+-		gpio@0x1000100c0 {
++		gpio@0x100003000 {
+ 			compatible = "altr,pio-17.1", "altr,pio-1.0";
+-			reg = <0x00000001 0x000100c0 0x00000010>;
++			reg = <0x00000001 0x00003000 0x00000010>;
+ 			interrupt-parent = <0x2>;
+ 			interrupts = <0 41 1>;
+ 			clocks = <0x2>;
+@@ -168,9 +158,9 @@
+ 			gpio-controller;
+ 		}; //end gpio@0x1000100c0 (button_pio)
+ 
+-		gpio@0x100010080 {
++		gpio@0x100004000 {
+ 			compatible = "altr,pio-17.1", "altr,pio-1.0";
+-			reg = <0x00000001 0x00010080 0x00000010>;
++			reg = <0x00000001 0x00004000 0x00000010>;
+ 			interrupt-parent = <0x2>;
+ 			interrupts = <0 42 1>;
+ 			clocks = <0x2>;
+@@ -184,9 +174,9 @@
+ 			gpio-controller;
+ 		}; //end gpio@0x100010080 (dipsw_pio)
+ 
+-		gpio@0x100010040 {
++		gpio@0x100005000 {
+ 			compatible = "altr,pio-17.1", "altr,pio-1.0";
+-			reg = <0x00000001 0x00010040 0x00000010>;
++			reg = <0x00000001 0x00005000 0x00000010>;
+ 			clocks = <0x2>;
+ 			altr,gpio-bank-width = <10>;	/* embeddedsw.dts.params.altr,gpio-bank-width type NUMBER */
+ 			resetvalue = <0>;	/* embeddedsw.dts.params.resetvalue type NUMBER */
+@@ -194,6 +184,25 @@
+ 			gpio-controller;
+ 		}; //end gpio@0x100010040 (led_pio)
+ 
++		ilc@0x100030000 {
++			compatible = "altr,altera_ilc-15.1", "altr,ilc-1.0";
++			reg = <0x00000001 0x00030000 0x00000100>;
++			interrupt-controller;
++			#interrupt-cells = <0x1>;
++			altr,sw-fifo-depth = <0x20>;
++		};
++
++		vip@0x100031000 {
++			compatible = "altr,vip-frame-reader-1.0", "ALTR,vip-frame-reader-14.0";
++			reg = <0x00000001 0x00031000 0x00000080>;
++			max-width = <0x556>;
++			max-height = <0x300>;
++			bits-per-color = <0x8>;
++			colors-per-beat = <0x4>;
++			beats-per-pixel = <0x1>;
++			mem-word-width = <0x80>;
++		};
++
+ 		uio-socfpg0@0x100040000 {
+ 			compatible = "generic-uio,ui_pdrv";
+ 			reg = <0x00000001 0x00040000 0x00010000>;
+diff --git a/arch/arm/boot/dts/socfpga_cyclone5_de1_soc_fbii.dts b/arch/arm/boot/dts/socfpga_cyclone5_de1_soc_fbii.dts
+index 225e461..c6aaacc 100644
+--- a/arch/arm/boot/dts/socfpga_cyclone5_de1_soc_fbii.dts
++++ b/arch/arm/boot/dts/socfpga_cyclone5_de1_soc_fbii.dts
+@@ -117,33 +117,33 @@
+ 		bridge-enable = <1>;
+ 		#address-cells = <0x2>;
+ 		#size-cells = <0x1>;
+-		ranges = <0x00000001 0x00020000 0xff220000 0x00000008>,
+-			<0x00000001 0x00010000 0xff210000 0x00000008>,
+-			<0x00000001 0x000100c0 0xff2100c0 0x00000010>,
+-			<0x00000001 0x00010080 0xff210080 0x00000010>,
+-			<0x00000001 0x00010040 0xff210040 0x00000010>,
++		ranges = <0x00000001 0x00001000 0xff201000 0x00000008>,
++			<0x00000001 0x00002000 0xff202000 0x00000008>,
++			<0x00000001 0x00003000 0xff203000 0x00000010>,
++			<0x00000001 0x00004000 0xff204000 0x00000010>,
++			<0x00000001 0x00005000 0xff205000 0x00000010>,
+ 			<0x00000001 0x00031000 0xff231000 0x00000080>,
+ 			<0x00000001 0x00040000 0xff240000 0x00010000>,
+ 			<0x00000001 0x00050000 0xff250000 0x00010000>;
+ 
+-		serial@0x100020000 {
++		sysid@0x100001000 {
++			compatible = "altr,sysid-15.1", "altr,sysid-1.0";
++			reg = <0x00000001 0x00001000 0x00000008>;
++			id = <2899645186>;
++			timestamp = <1524157570>;
++		};
++
++		serial@0x100002000 {
+ 			compatible = "altr,juart-17.1", "altr,juart-1.0";
+-			reg = <0x00000001 0x00020000 0x00000008>;
++			reg = <0x00000001 0x00002000 0x00000008>;
+ 			interrupt-parent = <0x2>;
+ 			interrupts = <0 40 4>;
+ 			clocks = <0x2>;
+ 		}; //end serial@0x100020000 (jtag_uart)
+ 
+-		sysid@0x100010000 {
+-			compatible = "altr,sysid-15.1", "altr,sysid-1.0";
+-			reg = <0x00000001 0x00010000 0x00000008>;
+-			id = <2899645186>;
+-			timestamp = <1524157570>;
+-		};
+-
+-		gpio@0x1000100c0 {
++		gpio@0x100003000 {
+ 			compatible = "altr,pio-17.1", "altr,pio-1.0";
+-			reg = <0x00000001 0x000100c0 0x00000010>;
++			reg = <0x00000001 0x00003000 0x00000010>;
+ 			interrupt-parent = <0x2>;
+ 			interrupts = <0 41 1>;
+ 			clocks = <0x2>;
+@@ -157,9 +157,9 @@
+ 			gpio-controller;
+ 		}; //end gpio@0x1000100c0 (button_pio)
+ 
+-		gpio@0x100010080 {
++		gpio@0x100004000 {
+ 			compatible = "altr,pio-17.1", "altr,pio-1.0";
+-			reg = <0x00000001 0x00010080 0x00000010>;
++			reg = <0x00000001 0x00004000 0x00000010>;
+ 			interrupt-parent = <0x2>;
+ 			interrupts = <0 42 1>;
+ 			clocks = <0x2>;
+@@ -173,9 +173,9 @@
+ 			gpio-controller;
+ 		}; //end gpio@0x100010080 (dipsw_pio)
+ 
+-		gpio@0x100010040 {
++		gpio@0x100005000 {
+ 			compatible = "altr,pio-17.1", "altr,pio-1.0";
+-			reg = <0x00000001 0x00010040 0x00000010>;
++			reg = <0x00000001 0x00005000 0x00000010>;
+ 			clocks = <0x2>;
+ 			altr,gpio-bank-width = <10>;	/* embeddedsw.dts.params.altr,gpio-bank-width type NUMBER */
+ 			resetvalue = <0>;	/* embeddedsw.dts.params.resetvalue type NUMBER */
+-- 
+2.7.4
+
+
+From db1989353b097c1dfe6c74220247212e2a834ac8 Mon Sep 17 00:00:00 2001
+From: Michael Brown <producer@holotronic.dk>
+Date: Thu, 31 May 2018 13:46:11 +0200
+Subject: [PATCH 20/23] Test Improve dtb
+
+Signed-off-by: Michael Brown <producer@holotronic.dk>
+---
+ .../socfpga_cyclone5_de10_nano_uio_aud_fbii_hd.dts | 22 ++++++++++++++--------
+ 1 file changed, 14 insertions(+), 8 deletions(-)
+
+diff --git a/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_aud_fbii_hd.dts b/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_aud_fbii_hd.dts
+index 1bf0892..65d1a56 100644
+--- a/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_aud_fbii_hd.dts
++++ b/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_aud_fbii_hd.dts
+@@ -122,9 +122,8 @@
+ 		serial@0x100002000 {
+ 			compatible = "altr,juart-15.1", "altr,juart-1.0";
+ 			reg = <0x00000001 0x00002000 0x00000008>;
+-			interrupt-parent = <0x3>;
+-			interrupts = <0x0 0x2a 0x4>;
+-			clocks = <0x2>;
++			interrupt-parent = <&intc>;
++			interrupts = <0 40 4>;
+ 		};
+ 
+ 		gpio@0x100003000 {
+@@ -139,6 +138,8 @@
+ 		gpio@0x100004000 {
+ 			compatible = "altr,pio-15.1", "altr,pio-1.0";
+ 			reg = <0x00000001 0x00004000 0x00000010>;
++			interrupt-parent = <&intc>;
++			interrupts = <0 41 1>;
+ 			altr,gpio-bank-width = <0x4>;
+ 			altr,interrupt-type = <0x3>;
+ 			altr,interrupt_type = <0x3>;
+@@ -152,6 +153,8 @@
+ 		gpio@0x100005000 {
+ 			compatible = "altr,pio-15.1", "altr,pio-1.0";
+ 			reg = <0x00000001 0x00005000 0x00000010>;
++			interrupt-parent = <&intc>;
++			interrupts = <0 42 1>;
+ 			altr,gpio-bank-width = <0x2>;
+ 			altr,interrupt-type = <0x2>;
+ 			altr,interrupt_type = <0x2>;
+@@ -165,6 +168,9 @@
+ 		ilc@0x100030000 {
+ 			compatible = "altr,altera_ilc-15.1", "altr,ilc-1.0";
+ 			reg = <0x00000001 0x00030000 0x00000100>;
++			interrupt-parent = <&intc>;
++			interrupts = <0 0 4 0 2 1 0 1 1 0 3 4 0 4 4>;
++			interrupt-names = "jtag_uart", "button_pio", "dipsw_pio", "uioreg_io_0", "socmidi_0";
+ 			interrupt-controller;
+ 			#interrupt-cells = <0x1>;
+ 			altr,sw-fifo-depth = <0x20>;
+@@ -184,8 +190,8 @@
+ 		uio-socfpg0@0x100040000 {
+ 			compatible = "generic-uio,ui_pdrv";
+ 			reg = <0x00000001 0x00040000 0x00010000>;
+-			interrupt-parent = <0x2>;
+-			interrupts = <0 43 1>;
++			interrupt-parent = <&intc>;
++			interrupts = <0 43 4>;
+ 			address_width = <14>;
+ 			data_width = <32>;
+ 		};
+@@ -193,8 +199,8 @@
+ 		socmidi@0x100050000 {
+ 			compatible = "holotr,socsynth-midi";
+ 			reg = <0x00000001 0x00050000 0x00010000>;
+-			interrupt-parent = <0x2>;
+-/*			interrupts = <0 44 4>;*/
++			interrupt-parent = <&intc>;
++			interrupts = <0 44 4>;
+ 			address_width = <3>;   /* embeddedsw.dts.params.address_width type NUMBER */
+ 			data_width = <8>;      /* embeddedsw.dts.params.data_width type NUMBER */
+ 		};
+@@ -241,7 +247,7 @@
+ 		compatible = "adi,adxl34x";
+ 		reg = <0x53>;
+ 
+-		interrupt-parent = <&portc>;
++		interrupt-parent = <&intc>;
+ 		interrupts = <3 2>;
+ 	};
+ };
+-- 
+2.7.4
+
+
+From 75ae05513d02bf59f1bff6d65962b20d01bbd435 Mon Sep 17 00:00:00 2001
+From: Michael Brown <producer@holotronic.dk>
+Date: Thu, 31 May 2018 18:08:43 +0200
+Subject: [PATCH 21/23] Add missing .ops to synthpcm5102 codec
+
+Signed-off-by: Michael Brown <producer@holotronic.dk>
+---
+ sound/soc/codecs/hsynthpcm5102.c | 93 +++++++++++++++++++++++++++++++---------
+ 1 file changed, 72 insertions(+), 21 deletions(-)
+
+diff --git a/sound/soc/codecs/hsynthpcm5102.c b/sound/soc/codecs/hsynthpcm5102.c
+index 9791ae3..4144146 100644
+--- a/sound/soc/codecs/hsynthpcm5102.c
++++ b/sound/soc/codecs/hsynthpcm5102.c
+@@ -27,32 +27,83 @@ static const struct snd_soc_dapm_route hsynthpcm5102_routes[] = {
+ 
+ static int hsynthpcm5102_set_dai_fmt(struct snd_soc_dai *dai, unsigned int fmt)
+ {
+-    switch (fmt & SND_SOC_DAIFMT_MASTER_MASK) {
+-    case SND_SOC_DAIFMT_CBS_CFS:
+-        break;
+-    default:
+-        return -EINVAL;
+-    }
+-
+-    switch (fmt & SND_SOC_DAIFMT_INV_MASK) {
+-    case SND_SOC_DAIFMT_NB_NF:
+-        break;
+-    default:
+-        return -EINVAL;
+-    }
+-
+-    switch (fmt & SND_SOC_DAIFMT_FORMAT_MASK) {
+-    case SND_SOC_DAIFMT_I2S:
+-    case SND_SOC_DAIFMT_DSP_A:
+-        break;
+-    default:
+-        return -EINVAL;
+-    }
++//     switch (fmt & SND_SOC_DAIFMT_MASTER_MASK) {
++//     case SND_SOC_DAIFMT_CBS_CFS:
++//         break;
++//     default:
++//         return -EINVAL;
++//     }
++//
++//     switch (fmt & SND_SOC_DAIFMT_INV_MASK) {
++//     case SND_SOC_DAIFMT_NB_NF:
++//         break;
++//     default:
++//         return -EINVAL;
++//     }
++//
++//     switch (fmt & SND_SOC_DAIFMT_FORMAT_MASK) {
++//     case SND_SOC_DAIFMT_I2S:
++//     case SND_SOC_DAIFMT_DSP_A:
++//         break;
++//     default:
++//         return -EINVAL;
++//     }
+ 
+     return 0;
+ }
+ 
++static int hsynthpcm5102_hw_params(struct snd_pcm_substream *substream,
++                            struct snd_pcm_hw_params *params,
++                            struct snd_soc_dai *dai)
++{
++//     struct snd_soc_codec *codec = dai->codec;
++//     struct wm8731_priv *wm8731 = snd_soc_codec_get_drvdata(codec);
++//     u16 iface = snd_soc_read(codec, WM8731_IFACE) & 0xfff3;
++//     int i = get_coeff(wm8731->sysclk, params_rate(params));
++//     u16 srate = (coeff_div[i].sr << 2) |
++//     (coeff_div[i].bosr << 1) | coeff_div[i].usb;
++//
++//     wm8731->playback_fs = params_rate(params);
++//
++//     snd_soc_write(codec, WM8731_SRATE, srate);
++//
++//     /* bit size */
++//     switch (params_width(params)) {
++//         case 16:
++//             break;
++//         case 20:
++//             iface |= 0x0004;
++//             break;
++//         case 24:
++//             iface |= 0x0008;
++//             break;
++//         case 32:
++//             iface |= 0x000c;
++//             break;
++//     }
++//
++//     wm8731_set_deemph(codec);
++//
++//     snd_soc_write(codec, WM8731_IFACE, iface);
++    return 0;
++}
++
++static int hsynthpcm5102_startup(struct snd_pcm_substream *substream,
++                           struct snd_soc_dai *dai)
++{
++//     struct wm8731_priv *wm8731 = snd_soc_codec_get_drvdata(dai->codec);
++//
++//     if (wm8731->constraints)
++//         snd_pcm_hw_constraint_list(substream->runtime, 0,
++//                                    SNDRV_PCM_HW_PARAM_RATE,
++//                                    wm8731->constraints);
++
++        return 0;
++}
++
+ static const struct snd_soc_dai_ops hsynthpcm5102_dai_ops = {
++    .startup	= hsynthpcm5102_startup,
++    .hw_params	= hsynthpcm5102_hw_params,
+     .set_fmt = hsynthpcm5102_set_dai_fmt,
+ };
+ 
+-- 
+2.7.4
+
+
+From 5e510d8a218793c02edef33da7b7a4c78b0b17e9 Mon Sep 17 00:00:00 2001
+From: Michael Brown <producer@holotronic.dk>
+Date: Fri, 1 Jun 2018 12:52:57 +0200
+Subject: [PATCH 22/23] Make DE1x Devicetree qsys core addresses consistant
+
+Signed-off-by: Michael Brown <producer@holotronic.dk>
+---
+ .../socfpga_cyclone5_de10_nano_uio_aud_fbii_hd.dts |  6 +-
+ .../boot/dts/socfpga_cyclone5_de10_nano_uio_fb.dts | 22 +++----
+ .../dts/socfpga_cyclone5_de10_nano_uio_fb_hd.dts   | 26 ++++----
+ arch/arm/boot/dts/socfpga_cyclone5_de1_soc.dts     | 70 +++++++++++-----------
+ 4 files changed, 58 insertions(+), 66 deletions(-)
+
+diff --git a/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_aud_fbii_hd.dts b/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_aud_fbii_hd.dts
+index 65d1a56..4b8b813 100644
+--- a/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_aud_fbii_hd.dts
++++ b/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_aud_fbii_hd.dts
+@@ -133,7 +133,7 @@
+ 			resetvalue = <0xff>;
+ 			#gpio-cells = <0x2>;
+ 			gpio-controller;
+-		};
++		};// (led_pio)
+ 
+ 		gpio@0x100004000 {
+ 			compatible = "altr,pio-15.1", "altr,pio-1.0";
+@@ -148,7 +148,7 @@
+ 			resetvalue = <0x0>;
+ 			#gpio-cells = <0x2>;
+ 			gpio-controller;
+-		};
++		};// (dipsw_pio)
+ 
+ 		gpio@0x100005000 {
+ 			compatible = "altr,pio-15.1", "altr,pio-1.0";
+@@ -163,7 +163,7 @@
+ 			resetvalue = <0x0>;
+ 			#gpio-cells = <0x2>;
+ 			gpio-controller;
+-		};
++		};// (button_pio)
+ 
+ 		ilc@0x100030000 {
+ 			compatible = "altr,altera_ilc-15.1", "altr,ilc-1.0";
+diff --git a/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_fb.dts b/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_fb.dts
+index c05a7f7..cc62324 100644
+--- a/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_fb.dts
++++ b/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_fb.dts
+@@ -85,8 +85,8 @@
+ 		serial@0x100002000 {
+ 			compatible = "altr,juart-15.1", "altr,juart-1.0";
+ 			reg = <0x00000001 0x00002000 0x00000008>;
+-			interrupt-parent = <0x3>;
+-			interrupts = <0x0 0x2a 0x4>;
++			interrupt-parent = <&intc>;
++			interrupts = <0 40 4>;
+ 			clocks = <0x2>;
+ 		};
+ 
+@@ -103,6 +103,8 @@
+ 			compatible = "altr,pio-15.1", "altr,pio-1.0";
+ 			reg = <0x00000001 0x00004000 0x00000010>;
+ 			altr,gpio-bank-width = <0x4>;
++			interrupt-parent = <&intc>;
++			interrupts = <0 41 1>;
+ 			altr,interrupt-type = <0x3>;
+ 			altr,interrupt_type = <0x3>;
+ 			edge_type = <0x2>;
+@@ -115,6 +117,8 @@
+ 		gpio@0x100005000 {
+ 			compatible = "altr,pio-15.1", "altr,pio-1.0";
+ 			reg = <0x00000001 0x00005000 0x00000010>;
++			interrupt-parent = <&intc>;
++			interrupts = <0 42 1>;
+ 			altr,gpio-bank-width = <0x2>;
+ 			altr,interrupt-type = <0x2>;
+ 			altr,interrupt_type = <0x2>;
+@@ -125,14 +129,6 @@
+ 			gpio-controller;
+ 		};
+ 
+-		ilc@0x100030000 {
+-			compatible = "altr,altera_ilc-15.1", "altr,ilc-1.0";
+-			reg = <0x00000001 0x00030000 0x00000100>;
+-			interrupt-controller;
+-			#interrupt-cells = <0x1>;
+-			altr,sw-fifo-depth = <0x20>;
+-		};
+-
+ 		vip@0x100031000 {
+ 			compatible = "altr,vip-frame-reader-1.0", "ALTR,vip-frame-reader-9.1";
+ 			reg = <0x00000001 0x00031000 0x00000080>;
+@@ -147,8 +143,8 @@
+ 		hm2-socfpga0@0x100040000 {
+ 			compatible = "generic-uio,ui_pdrv";
+ 			reg = <0x00000001 0x00040000 0x00010000>;
+-			interrupt-parent = <0x2>;
+-			interrupts = <0 43 1>;
++			interrupt-parent = <&intc>;
++			interrupts = <0 43 4>;
+ 			address_width = <14>;
+ 			data_width = <32>;
+ 		};
+@@ -195,7 +191,7 @@
+ 		compatible = "adi,adxl34x";
+ 		reg = <0x53>;
+ 
+-		interrupt-parent = <&portc>;
++		interrupt-parent = <&intc>;
+ 		interrupts = <3 2>;
+ 	};
+ };
+diff --git a/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_fb_hd.dts b/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_fb_hd.dts
+index ce568a0..67bf19f 100644
+--- a/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_fb_hd.dts
++++ b/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_fb_hd.dts
+@@ -71,8 +71,8 @@
+ 			<0x00000001 0x00003000 0xff203000 0x00000010>,
+ 			<0x00000001 0x00004000 0xff204000 0x00000010>,
+ 			<0x00000001 0x00005000 0xff205000 0x00000010>,
+-			<0x00000001 0x00030000 0xff230000 0x00000100>,
+-			<0x00000001 0x00031000 0xff231000 0x00000080>,
++            <0x00000000 0x00010000 0xc0010000 0x00010000>,
++            <0x00000001 0x00031000 0xff231000 0x00000080>,
+ 			<0x00000001 0x00040000 0xff240000 0x00010000>;
+ 
+ 		sysid@0x100001000 {
+@@ -85,8 +85,8 @@
+ 		serial@0x100002000 {
+ 			compatible = "altr,juart-15.1", "altr,juart-1.0";
+ 			reg = <0x00000001 0x00002000 0x00000008>;
+-			interrupt-parent = <0x3>;
+-			interrupts = <0x0 0x2a 0x4>;
++			interrupt-parent = <&intc>;
++			interrupts = <0 40 4>;
+ 			clocks = <0x2>;
+ 		};
+ 
+@@ -102,6 +102,8 @@
+ 		gpio@0x100004000 {
+ 			compatible = "altr,pio-15.1", "altr,pio-1.0";
+ 			reg = <0x00000001 0x00004000 0x00000010>;
++			interrupt-parent = <&intc>;
++			interrupts = <0 41 1>;
+ 			altr,gpio-bank-width = <0x4>;
+ 			altr,interrupt-type = <0x3>;
+ 			altr,interrupt_type = <0x3>;
+@@ -115,6 +117,8 @@
+ 		gpio@0x100005000 {
+ 			compatible = "altr,pio-15.1", "altr,pio-1.0";
+ 			reg = <0x00000001 0x00005000 0x00000010>;
++			interrupt-parent = <&intc>;
++			interrupts = <0 42 1>;
+ 			altr,gpio-bank-width = <0x2>;
+ 			altr,interrupt-type = <0x2>;
+ 			altr,interrupt_type = <0x2>;
+@@ -125,14 +129,6 @@
+ 			gpio-controller;
+ 		};
+ 
+-		ilc@0x100030000 {
+-			compatible = "altr,altera_ilc-15.1", "altr,ilc-1.0";
+-			reg = <0x00000001 0x00030000 0x00000100>;
+-			interrupt-controller;
+-			#interrupt-cells = <0x1>;
+-			altr,sw-fifo-depth = <0x20>;
+-		};
+-
+ 		vip@0x100031000 {
+ 			compatible = "altr,vip-frame-reader-1.0", "ALTR,vip-frame-reader-9.1";
+ 			reg = <0x00000001 0x00031000 0x00000080>;
+@@ -147,8 +143,8 @@
+ 		hm2-socfpga0@0x100040000 {
+ 			compatible = "generic-uio,ui_pdrv";
+ 			reg = <0x00000001 0x00040000 0x00010000>;
+-			interrupt-parent = <0x2>;
+-			interrupts = <0 43 1>;
++			interrupt-parent = <&intc>;
++			interrupts = <0 43 4>;
+ 			address_width = <14>;
+ 			data_width = <32>;
+ 		};
+@@ -195,7 +191,7 @@
+ 		compatible = "adi,adxl34x";
+ 		reg = <0x53>;
+ 
+-		interrupt-parent = <&portc>;
++		interrupt-parent = <&intc>;
+ 		interrupts = <3 2>;
+ 	};
+ };
+diff --git a/arch/arm/boot/dts/socfpga_cyclone5_de1_soc.dts b/arch/arm/boot/dts/socfpga_cyclone5_de1_soc.dts
+index 4925f44..11f0a9c 100644
+--- a/arch/arm/boot/dts/socfpga_cyclone5_de1_soc.dts
++++ b/arch/arm/boot/dts/socfpga_cyclone5_de1_soc.dts
+@@ -137,56 +137,56 @@
+ 		serial@0x100002000 {
+ 			compatible = "altr,juart-17.1", "altr,juart-1.0";
+ 			reg = <0x00000001 0x00002000 0x00000008>;
+-			interrupt-parent = <0x2>;
++			interrupt-parent = <&intc>;
+ 			interrupts = <0 40 4>;
+ 			clocks = <0x2>;
+ 		}; //end serial@0x100020000 (jtag_uart)
+ 
+ 		gpio@0x100003000 {
+-			compatible = "altr,pio-17.1", "altr,pio-1.0";
++			compatible = "altr,pio-15.1", "altr,pio-1.0";
+ 			reg = <0x00000001 0x00003000 0x00000010>;
+-			interrupt-parent = <0x2>;
+-			interrupts = <0 41 1>;
+-			clocks = <0x2>;
+-			altr,gpio-bank-width = <2>;	/* embeddedsw.dts.params.altr,gpio-bank-width type NUMBER */
+-			altr,interrupt-type = <2>;	/* embeddedsw.dts.params.altr,interrupt-type type NUMBER */
+-			altr,interrupt_type = <2>;	/* embeddedsw.dts.params.altr,interrupt_type type NUMBER */
+-			edge_type = <1>;	/* embeddedsw.dts.params.edge_type type NUMBER */
+-			level_trigger = <0>;	/* embeddedsw.dts.params.level_trigger type NUMBER */
+-			resetvalue = <0>;	/* embeddedsw.dts.params.resetvalue type NUMBER */
+-			#gpio-cells = <2>;
++			altr,gpio-bank-width = <0x8>;
++			resetvalue = <0xff>;
++			#gpio-cells = <0x2>;
+ 			gpio-controller;
+-		}; //end gpio@0x1000100c0 (button_pio)
++		};// (led_pio)
+ 
+ 		gpio@0x100004000 {
+-			compatible = "altr,pio-17.1", "altr,pio-1.0";
++			compatible = "altr,pio-15.1", "altr,pio-1.0";
+ 			reg = <0x00000001 0x00004000 0x00000010>;
+-			interrupt-parent = <0x2>;
+-			interrupts = <0 42 1>;
+-			clocks = <0x2>;
+-			altr,gpio-bank-width = <10>;	/* embeddedsw.dts.params.altr,gpio-bank-width type NUMBER */
+-			altr,interrupt-type = <3>;	/* embeddedsw.dts.params.altr,interrupt-type type NUMBER */
+-			altr,interrupt_type = <3>;	/* embeddedsw.dts.params.altr,interrupt_type type NUMBER */
+-			edge_type = <2>;	/* embeddedsw.dts.params.edge_type type NUMBER */
+-			level_trigger = <0>;	/* embeddedsw.dts.params.level_trigger type NUMBER */
+-			resetvalue = <0>;	/* embeddedsw.dts.params.resetvalue type NUMBER */
+-			#gpio-cells = <2>;
++			interrupt-parent = <&intc>;
++			interrupts = <0 41 1>;
++			altr,gpio-bank-width = <0x4>;
++			altr,interrupt-type = <0x3>;
++			altr,interrupt_type = <0x3>;
++			edge_type = <0x2>;
++			level_trigger = <0x0>;
++			resetvalue = <0x0>;
++			#gpio-cells = <0x2>;
+ 			gpio-controller;
+-		}; //end gpio@0x100010080 (dipsw_pio)
++		};// (dipsw_pio)
+ 
+ 		gpio@0x100005000 {
+-			compatible = "altr,pio-17.1", "altr,pio-1.0";
++			compatible = "altr,pio-15.1", "altr,pio-1.0";
+ 			reg = <0x00000001 0x00005000 0x00000010>;
+-			clocks = <0x2>;
+-			altr,gpio-bank-width = <10>;	/* embeddedsw.dts.params.altr,gpio-bank-width type NUMBER */
+-			resetvalue = <0>;	/* embeddedsw.dts.params.resetvalue type NUMBER */
+-			#gpio-cells = <2>;
++			interrupt-parent = <&intc>;
++			interrupts = <0 42 1>;
++			altr,gpio-bank-width = <0x2>;
++			altr,interrupt-type = <0x2>;
++			altr,interrupt_type = <0x2>;
++			edge_type = <0x1>;
++			level_trigger = <0x0>;
++			resetvalue = <0x0>;
++			#gpio-cells = <0x2>;
+ 			gpio-controller;
+-		}; //end gpio@0x100010040 (led_pio)
++		};// (button_pio)
+ 
+ 		ilc@0x100030000 {
+ 			compatible = "altr,altera_ilc-15.1", "altr,ilc-1.0";
+ 			reg = <0x00000001 0x00030000 0x00000100>;
++			interrupt-parent = <&intc>;
++			interrupts = <0 0 4 0 2 1 0 1 1 0 3 4 0 4 4>;
++			interrupt-names = "jtag_uart", "button_pio", "dipsw_pio", "uioreg_io_0", "socmidi_0";
+ 			interrupt-controller;
+ 			#interrupt-cells = <0x1>;
+ 			altr,sw-fifo-depth = <0x20>;
+@@ -206,7 +206,7 @@
+ 		uio-socfpg0@0x100040000 {
+ 			compatible = "generic-uio,ui_pdrv";
+ 			reg = <0x00000001 0x00040000 0x00010000>;
+-			interrupt-parent = <0x2>;
++			interrupt-parent = <&intc>;
+ 			interrupts = <0 43 4>;
+ 			address_width = <14>;
+ 			data_width = <32>;
+@@ -215,8 +215,8 @@
+ 		socmidi@0x100050000 {
+ 			compatible = "holotr,socsynth-midi";
+ 			reg = <0x00000001 0x00050000 0x00010000>;
+-			interrupt-parent = <0x2>;
+-/*			interrupts = <0 44 4>;*/
++			interrupt-parent = <&intc>;
++			interrupts = <0 44 4>;
+ 			address_width = <3>;   /* embeddedsw.dts.params.address_width type NUMBER */
+ 			data_width = <8>;      /* embeddedsw.dts.params.data_width type NUMBER */
+ 		};
+@@ -269,7 +269,7 @@
+ 		compatible = "adi,adxl345";
+ 		reg = <0x53>;
+ 
+-		interrupt-parent = <&portc>;
++		interrupt-parent = <&intc>;
+ 		interrupts = <3 2>;
+ 	};
+ };
+-- 
+2.7.4
+
+
+From 00c5c9fd98255f383e14ccf0603c9779f3179062 Mon Sep 17 00:00:00 2001
+From: Michael Brown <producer@holotronic.dk>
+Date: Sat, 2 Jun 2018 22:56:31 +0200
+Subject: [PATCH 23/23] Add builtin audio codec driver for DE1/DE10 SoC
+ (wm8731) Add Audio and framebuffer Supporting device trees xga and hd
+ versions
+
+Signed-off-by: Michael Brown <producer@holotronic.dk>
+---
+ arch/arm/boot/dts/Makefile                         |   2 +
+ .../boot/dts/socfpga_cyclone5_de1_soc_aud_fb.dts   | 194 ++++++++++++++++
+ .../dts/socfpga_cyclone5_de1_soc_aud_fb_hd.dts     | 194 ++++++++++++++++
+ arch/arm/configs/socfpga_defconfig                 |   3 +-
+ sound/soc/socsynth/Kconfig                         |   9 +-
+ sound/soc/socsynth/Makefile                        |   5 +-
+ sound/soc/socsynth/de1x-soc-wm8731.c               | 251 +++++++++++++++++++++
+ 7 files changed, 655 insertions(+), 3 deletions(-)
+ create mode 100644 arch/arm/boot/dts/socfpga_cyclone5_de1_soc_aud_fb.dts
+ create mode 100644 arch/arm/boot/dts/socfpga_cyclone5_de1_soc_aud_fb_hd.dts
+ create mode 100644 sound/soc/socsynth/de1x-soc-wm8731.c
+
+diff --git a/arch/arm/boot/dts/Makefile b/arch/arm/boot/dts/Makefile
+index 748b068..cd54d8e 100644
+--- a/arch/arm/boot/dts/Makefile
++++ b/arch/arm/boot/dts/Makefile
+@@ -705,6 +705,8 @@ dtb-$(CONFIG_ARCH_SOCFPGA) += \
+ 	socfpga_cyclone5_de10_nano_uio_aud_fbii_hd.dtb \
+ 	socfpga_cyclone5_de10_nano.dtb \
+ 	socfpga_cyclone5_de1_soc.dtb \
++	socfpga_cyclone5_de1_soc_aud_fb.dtb \
++	socfpga_cyclone5_de1_soc_aud_fb_hd.dtb \
+ 	socfpga_cyclone5_de1_soc_fbii.dtb \
+ 	socfpga_cyclone5_sockit.dtb \
+ 	socfpga_cyclone5_socrates.dtb \
+diff --git a/arch/arm/boot/dts/socfpga_cyclone5_de1_soc_aud_fb.dts b/arch/arm/boot/dts/socfpga_cyclone5_de1_soc_aud_fb.dts
+new file mode 100644
+index 0000000..4fb724a
+--- /dev/null
++++ b/arch/arm/boot/dts/socfpga_cyclone5_de1_soc_aud_fb.dts
+@@ -0,0 +1,194 @@
++/*
++ *  Copyright (C) 2013 Steffen Trumtrar <s.trumtrar@pengutronix.de>
++ *  Copyright (C) 2016 Stephen Arnold <nerdboy@gentoo.org>
++ *
++ * This program is free software; you can redistribute it and/or modify
++ * it under the terms of the GNU General Public License as published by
++ * the Free Software Foundation; either version 2 of the License, or
++ * (at your option) any later version.
++ *
++ * This program is distributed in the hope that it will be useful,
++ * but WITHOUT ANY WARRANTY; without even the implied warranty of
++ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
++ * GNU General Public License for more details.
++ *
++ * You should have received a copy of the GNU General Public License
++ * along with this program.  If not, see <http://www.gnu.org/licenses/>.
++ */
++
++#include "socfpga_cyclone5.dtsi"
++
++/ {
++	model = "Terasic DE1-SoC";
++	compatible = "altr,socfpga-cyclone5", "altr,socfpga";
++
++	chosen {
++		bootargs = "earlyprintk";
++		stdout-path = "serial0:115200n8";
++	};
++
++	memory {
++		name = "memory";
++		device_type = "memory";
++		reg = <0x0 0x40000000>; /* 1GB */
++	};
++
++	aliases {
++		ethernet0 = &gmac1;
++	};
++
++	regulator_3_3v: 3-3-v-regulator {
++		compatible = "regulator-fixed";
++		regulator-name = "3.3V";
++		regulator-min-microvolt = <3300000>;
++		regulator-max-microvolt = <3300000>;
++	};
++
++	leds {
++		compatible = "gpio-leds";
++		hps0 {
++			label = "hps_led0";
++			gpios = <&portb 24 0>;
++			linux,default-trigger = "heartbeat";
++		};
++	};
++
++	keys {
++		compatible = "gpio-keys";
++		hps0 {
++			label = "hps_key0";
++			gpios = <&portb 25 0>;
++			linux,code = <63>;
++			debounce-interval = <50>;
++		};
++	};
++
++	sound {
++		compatible = "opencores,de1soc-wm8731-audio";
++		i2s-controller = <&i2s>;
++		audio-codec = <&wm8731>;
++		i2c-mux-gpio = <&portb 19 0>;
++	};
++
++	clk48: clk48 {
++		compatible = "fixed-clock";
++		#clock-cells = <0>;
++		clock-frequency  = <24576000>;
++		clock-output-names = "clk48";
++	};
++
++	clk44: clk44 {
++		compatible = "fixed-clock";
++		#clock-cells = <0>;
++		clock-frequency  = <33868800>;
++		clock-output-names = "clk44";
++	};
++
++	i2s: i2s@0x0 {
++		#sound-dai-cells = <1>;
++		compatible = "opencores,i2s";
++		reg = <0xff200000 0x20>, <0xff200020 0x20>;
++		clocks = <&clk44>, <&clk48>;
++		clock-names = "clk44", "clk48";
++		dmas = <&pdma 0>, <&pdma 1>;
++		dma-names = "tx", "rx";
++	};
++
++	bridge@0xc0000000 {
++		compatible = "altr,bridge-15.1", "simple-bus";
++		reg = <0xc0000000 0x20000000 0xff200000 0x200000>;
++		bridge-enable = <1>;
++		#address-cells = <0x2>;
++		#size-cells = <0x1>;
++		ranges = <0x00000001 0x00001000 0xff201000 0x00000008>,
++			<0x00000001 0x00031000 0xff231000 0x00000080>;
++
++		sysid@0x100001000 {
++			compatible = "altr,sysid-15.1", "altr,sysid-1.0";
++			reg = <0x00000001 0x00001000 0x00000008>;
++			id = <2899645186>;
++			timestamp = <1524157570>;
++		};
++
++		vip@0x100031000 {
++			compatible = "altr,vip-frame-reader-1.0", "ALTR,vip-frame-reader-14.0";
++			reg = <0x00000001 0x00031000 0x00000080>;
++			max-width = <1024>;
++			max-height = <768>;
++			bits-per-color = <0x8>;
++			colors-per-beat = <0x4>;
++			beats-per-pixel = <0x1>;
++			mem-word-width = <0x80>;
++		};
++	};
++};
++
++&gmac1 {
++	status = "okay";
++	phy-mode = "rgmii";
++
++	txd0-skew-ps = <0>; /* -420ps */
++	txd1-skew-ps = <0>; /* -420ps */
++	txd2-skew-ps = <0>; /* -420ps */
++	txd3-skew-ps = <0>; /* -420ps */
++	rxd0-skew-ps = <420>; /* 0ps */
++	rxd1-skew-ps = <420>; /* 0ps */
++	rxd2-skew-ps = <420>; /* 0ps */
++	rxd3-skew-ps = <420>; /* 0ps */
++	txen-skew-ps = <0>; /* -420ps */
++	txc-skew-ps = <1860>; /* 960ps */
++	rxdv-skew-ps = <420>; /* 0ps */
++	rxc-skew-ps = <1680>; /* 780ps */
++
++	max-frame-size = <3800>;
++};
++
++&gpio0 {
++	status = "okay";
++};
++
++&gpio1 {
++	status = "okay";
++};
++
++&gpio2 {
++	status = "okay";
++};
++
++&i2c0 {
++	status = "okay";
++	speed-mode = <0>;
++
++	wm8731: wm8731@34 {
++		#sound-dai-cells = <0>;
++		compatible = "wlf,wm8731";
++		reg = <0x1a>;
++	};
++
++	adxl345: adxl345@0 {
++		compatible = "adi,adxl345";
++		reg = <0x53>;
++
++		interrupt-parent = <&portc>;
++		interrupts = <3 2>;
++	};
++};
++
++&i2c1 {
++	status = "okay";
++	speed-mode = <0>;
++};
++
++&mmc0 {
++	vmmc-supply = <&regulator_3_3v>;
++	vqmmc-supply = <&regulator_3_3v>;
++	status = "okay";
++};
++
++&uart0 {
++	status = "okay";
++};
++
++&usb1 {
++	status = "okay";
++};
+diff --git a/arch/arm/boot/dts/socfpga_cyclone5_de1_soc_aud_fb_hd.dts b/arch/arm/boot/dts/socfpga_cyclone5_de1_soc_aud_fb_hd.dts
+new file mode 100644
+index 0000000..ecebb6e
+--- /dev/null
++++ b/arch/arm/boot/dts/socfpga_cyclone5_de1_soc_aud_fb_hd.dts
+@@ -0,0 +1,194 @@
++/*
++ *  Copyright (C) 2013 Steffen Trumtrar <s.trumtrar@pengutronix.de>
++ *  Copyright (C) 2016 Stephen Arnold <nerdboy@gentoo.org>
++ *
++ * This program is free software; you can redistribute it and/or modify
++ * it under the terms of the GNU General Public License as published by
++ * the Free Software Foundation; either version 2 of the License, or
++ * (at your option) any later version.
++ *
++ * This program is distributed in the hope that it will be useful,
++ * but WITHOUT ANY WARRANTY; without even the implied warranty of
++ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
++ * GNU General Public License for more details.
++ *
++ * You should have received a copy of the GNU General Public License
++ * along with this program.  If not, see <http://www.gnu.org/licenses/>.
++ */
++
++#include "socfpga_cyclone5.dtsi"
++
++/ {
++	model = "Terasic DE1-SoC";
++	compatible = "altr,socfpga-cyclone5", "altr,socfpga";
++
++	chosen {
++		bootargs = "earlyprintk";
++		stdout-path = "serial0:115200n8";
++	};
++
++	memory {
++		name = "memory";
++		device_type = "memory";
++		reg = <0x0 0x40000000>; /* 1GB */
++	};
++
++	aliases {
++		ethernet0 = &gmac1;
++	};
++
++	regulator_3_3v: 3-3-v-regulator {
++		compatible = "regulator-fixed";
++		regulator-name = "3.3V";
++		regulator-min-microvolt = <3300000>;
++		regulator-max-microvolt = <3300000>;
++	};
++
++	leds {
++		compatible = "gpio-leds";
++		hps0 {
++			label = "hps_led0";
++			gpios = <&portb 24 0>;
++			linux,default-trigger = "heartbeat";
++		};
++	};
++
++	keys {
++		compatible = "gpio-keys";
++		hps0 {
++			label = "hps_key0";
++			gpios = <&portb 25 0>;
++			linux,code = <63>;
++			debounce-interval = <50>;
++		};
++	};
++
++	sound {
++		compatible = "opencores,de1soc-wm8731-audio";
++		i2s-controller = <&i2s>;
++		audio-codec = <&wm8731>;
++		i2c-mux-gpio = <&portb 19 0>;
++	};
++
++	clk48: clk48 {
++		compatible = "fixed-clock";
++		#clock-cells = <0>;
++		clock-frequency  = <24576000>;
++		clock-output-names = "clk48";
++	};
++
++	clk44: clk44 {
++		compatible = "fixed-clock";
++		#clock-cells = <0>;
++		clock-frequency  = <33868800>;
++		clock-output-names = "clk44";
++	};
++
++	i2s: i2s@0x0 {
++		#sound-dai-cells = <1>;
++		compatible = "opencores,i2s";
++		reg = <0xff200000 0x20>, <0xff200020 0x20>;
++		clocks = <&clk44>, <&clk48>;
++		clock-names = "clk44", "clk48";
++		dmas = <&pdma 0>, <&pdma 1>;
++		dma-names = "tx", "rx";
++	};
++
++	bridge@0xc0000000 {
++		compatible = "altr,bridge-15.1", "simple-bus";
++		reg = <0xc0000000 0x20000000 0xff200000 0x200000>;
++		bridge-enable = <1>;
++		#address-cells = <0x2>;
++		#size-cells = <0x1>;
++		ranges = <0x00000001 0x00001000 0xff201000 0x00000008>,
++			<0x00000001 0x00031000 0xff231000 0x00000080>;
++
++		sysid@0x100001000 {
++			compatible = "altr,sysid-15.1", "altr,sysid-1.0";
++			reg = <0x00000001 0x00001000 0x00000008>;
++			id = <2899645186>;
++			timestamp = <1524157570>;
++		};
++
++		vip@0x100031000 {
++			compatible = "altr,vip-frame-reader-1.0", "ALTR,vip-frame-reader-14.0";
++			reg = <0x00000001 0x00031000 0x00000080>;
++			max-width = <1920>;
++			max-height = <1080>;
++			bits-per-color = <0x8>;
++			colors-per-beat = <0x4>;
++			beats-per-pixel = <0x1>;
++			mem-word-width = <0x80>;
++		};
++	};
++};
++
++&gmac1 {
++	status = "okay";
++	phy-mode = "rgmii";
++
++	txd0-skew-ps = <0>; /* -420ps */
++	txd1-skew-ps = <0>; /* -420ps */
++	txd2-skew-ps = <0>; /* -420ps */
++	txd3-skew-ps = <0>; /* -420ps */
++	rxd0-skew-ps = <420>; /* 0ps */
++	rxd1-skew-ps = <420>; /* 0ps */
++	rxd2-skew-ps = <420>; /* 0ps */
++	rxd3-skew-ps = <420>; /* 0ps */
++	txen-skew-ps = <0>; /* -420ps */
++	txc-skew-ps = <1860>; /* 960ps */
++	rxdv-skew-ps = <420>; /* 0ps */
++	rxc-skew-ps = <1680>; /* 780ps */
++
++	max-frame-size = <3800>;
++};
++
++&gpio0 {
++	status = "okay";
++};
++
++&gpio1 {
++	status = "okay";
++};
++
++&gpio2 {
++	status = "okay";
++};
++
++&i2c0 {
++	status = "okay";
++	speed-mode = <0>;
++
++	wm8731: wm8731@34 {
++		#sound-dai-cells = <0>;
++		compatible = "wlf,wm8731";
++		reg = <0x1a>;
++	};
++
++	adxl345: adxl345@0 {
++		compatible = "adi,adxl345";
++		reg = <0x53>;
++
++		interrupt-parent = <&portc>;
++		interrupts = <3 2>;
++	};
++};
++
++&i2c1 {
++	status = "okay";
++	speed-mode = <0>;
++};
++
++&mmc0 {
++	vmmc-supply = <&regulator_3_3v>;
++	vqmmc-supply = <&regulator_3_3v>;
++	status = "okay";
++};
++
++&uart0 {
++	status = "okay";
++};
++
++&usb1 {
++	status = "okay";
++};
+diff --git a/arch/arm/configs/socfpga_defconfig b/arch/arm/configs/socfpga_defconfig
+index 25f92bd..4917baf 100644
+--- a/arch/arm/configs/socfpga_defconfig
++++ b/arch/arm/configs/socfpga_defconfig
+@@ -308,7 +308,8 @@ CONFIG_SND_SOC_SSM2602=m
+ CONFIG_SND_SOC_SSM2602_I2C=m
+ CONFIG_SND_ALOOP=m
+ CONFIG_SND_VIRMIDI=m
+-CONFIG_SND_SOC_DE1_WM8731_HSYNTH=m
++CONFIG_SND_SOC_DE1x_WM8731=m
++CONFIG_SND_SOC_DE1x_WM8731_HSYNTH=m
+ CONFIG_SND_SOC_HSYNTH_MIDI=m
+ CONFIG_SND_SOC_PCM5102A=m
+ CONFIG_SND_SOC_PCM5102_HSYNTH=m
+diff --git a/sound/soc/socsynth/Kconfig b/sound/soc/socsynth/Kconfig
+index 5d71a4e..b6b7dec 100644
+--- a/sound/soc/socsynth/Kconfig
++++ b/sound/soc/socsynth/Kconfig
+@@ -16,7 +16,7 @@ config SND_SOC_HSYNTHDMA
+          This driver can also be built as a module.  If so, the module
+          will be called hsynthdma.
+ 
+-config SND_SOC_DE1_WM8731_HSYNTH
++config SND_SOC_DE1x_WM8731_HSYNTH
+        tristate "DE1-Audio MIDI support"
+        select SND_SOC_WM8731
+        select SND_SOC_OC_I2S
+@@ -34,3 +34,10 @@ config SND_SOC_PCM5102_HSYNTH
+        select SND_SOC_OC_I2S
+        select SND_SOC_GENERIC_DMAENGINE_PCM
+        select REGMAP_MMIO
++
++config SND_SOC_DE1x_WM8731
++       tristate "DE1x-Builtin-Audio support"
++       select SND_SOC_WM8731
++       select SND_SOC_OC_I2S
++       select SND_SOC_GENERIC_DMAENGINE_PCM
++       select REGMAP_MMIO
+diff --git a/sound/soc/socsynth/Makefile b/sound/soc/socsynth/Makefile
+index 2043f43d..69fb2aa 100644
+--- a/sound/soc/socsynth/Makefile
++++ b/sound/soc/socsynth/Makefile
+@@ -2,7 +2,7 @@ snd-soc-opencores_i2s-objs := opencores_i2s.o
+ obj-$(CONFIG_SND_SOC_OC_I2S) += snd-soc-opencores_i2s.o
+ 
+ snd-de1-soc-wm8731-hsynth-objs := de1-soc-wm8731-hsynth.o
+-obj-$(CONFIG_SND_SOC_DE1_WM8731_HSYNTH) += snd-de1-soc-wm8731-hsynth.o
++obj-$(CONFIG_SND_SOC_DE1x_WM8731_HSYNTH) += snd-de1-soc-wm8731-hsynth.o
+ 
+ snd-soc-hsynthdma-objs := hsynthdma.o
+ obj-$(CONFIG_SND_SOC_HSYNTHDMA) += snd-soc-hsynthdma.o
+@@ -12,3 +12,6 @@ obj-$(CONFIG_SND_SOC_HSYNTH_MIDI) += snd-soc-hsynth-midi.o
+ 
+ snd-pcm5102-hsynth-objs := pcm5102-hsynth.o
+ obj-$(CONFIG_SND_SOC_PCM5102_HSYNTH) += snd-pcm5102-hsynth.o
++
++snd-soc-de1x-soc-wm8731-objs := de1x-soc-wm8731.o
++obj-$(CONFIG_SND_SOC_DE1x_WM8731) += snd-soc-de1x-soc-wm8731.o
+diff --git a/sound/soc/socsynth/de1x-soc-wm8731.c b/sound/soc/socsynth/de1x-soc-wm8731.c
+new file mode 100644
+index 0000000..e297ef4
+--- /dev/null
++++ b/sound/soc/socsynth/de1x-soc-wm8731.c
+@@ -0,0 +1,251 @@
++/*
++ * de1-soc-wm8731 -- SoC audio for Terasic DE1-SoC board
++ * Author: B. Steinsbo <bsteinsbo@gmail.com>
++ *
++ * Based on sam9g20_wm8731 by
++ * Sedji Gaouaou <sedji.gaouaou@atmel.com>
++ *
++ * Licensed under the GPL-2.
++ */
++
++#include <linux/module.h>
++#include <linux/kernel.h>
++#include <linux/clk.h>
++#include <linux/platform_device.h>
++#include <linux/of.h>
++#include <linux/gpio.h>
++#include <linux/of_gpio.h>
++#include <linux/uaccess.h>
++#include <linux/ioport.h>
++#include <linux/io.h>
++
++#include <sound/core.h>
++#include <sound/pcm.h>
++#include <sound/pcm_params.h>
++#include <sound/soc.h>
++#include <sound/initval.h>
++
++#define WM8731_SYSCLK_XTAL 1
++#define WM8731_SYSCLK_MCLK 2
++#define MCLK_RATE_48K 12288000 /* fs*256 */
++#define MCLK_RATE_44K 16934400 /* fs*384 */
++
++static unsigned int i2c_mux_gpio;
++
++static int de1soc_hw_params(struct snd_pcm_substream *substream,
++	struct snd_pcm_hw_params *params)
++{
++	struct snd_soc_pcm_runtime *rtd = substream->private_data;
++	struct snd_soc_dai *codec_dai = rtd->codec_dai;
++	struct device *dev = rtd->card->dev;
++	unsigned int mclk_freq;
++	int ret;
++
++	if ((params_rate(params) % 44100) == 0) {
++		mclk_freq = MCLK_RATE_44K;
++	} else if ((params_rate(params) % 48000) == 0) {
++		mclk_freq = MCLK_RATE_48K;
++	} else
++		return -EINVAL;
++
++	/* set codec mclk configuration */
++	ret = snd_soc_dai_set_sysclk(codec_dai, WM8731_SYSCLK_MCLK,
++		mclk_freq, SND_SOC_CLOCK_OUT);
++	if (ret < 0)
++		return ret;
++
++	dev_dbg(dev, "hw_params: mclk_freq=%d\n", mclk_freq);
++	return 0;
++}
++
++static void de1soc_shutdown(struct snd_pcm_substream *substream)
++{
++	struct snd_soc_pcm_runtime *rtd = substream->private_data;
++	struct snd_soc_dai *codec_dai = rtd->codec_dai;
++	struct device *dev = rtd->card->dev;
++	int ret;
++
++	dev_dbg(dev, "shutdown\n");
++	ret = snd_soc_dai_set_sysclk(codec_dai, WM8731_SYSCLK_MCLK,
++		0, SND_SOC_CLOCK_OUT);
++	if (ret < 0) {
++		dev_err(dev, "Failed to reset WM8731 SYSCLK: %d\n", ret);
++	}
++}
++
++static struct snd_soc_ops de1soc_ops = {
++	// .startup
++	.shutdown = de1soc_shutdown,
++	.hw_params = de1soc_hw_params,
++	// .hw_free
++	// .prepare
++	// .trigger
++};
++
++static const struct snd_soc_dapm_widget de1soc_dapm_widgets[] = {
++	SND_SOC_DAPM_HP("Headphone Jack", NULL),
++	SND_SOC_DAPM_MIC("Microphone Jack", NULL),
++	SND_SOC_DAPM_LINE("Line In Jack", NULL),
++	SND_SOC_DAPM_LINE("Line Out Jack", NULL),
++};
++
++static const struct snd_soc_dapm_route intercon[] = {
++	{"MICIN", NULL, "Mic Bias"},
++	{"Mic Bias", NULL, "Microphone Jack"},
++	{"LLINEIN", NULL, "Line In Jack"},
++	{"RLINEIN", NULL, "Line In Jack"},
++	{"Line Out Jack", NULL, "LOUT"},
++	{"Line Out Jack", NULL, "ROUT"},
++	{"Headphone Jack", NULL, "LHPOUT"},
++	{"Headphone Jack", NULL, "RHPOUT"},
++};
++
++static int de1soc_wm8731_init(struct snd_soc_pcm_runtime *rtd)
++{
++	struct snd_soc_dai *codec_dai = rtd->codec_dai;
++	struct snd_soc_dai *cpu_dai = rtd->cpu_dai;
++	struct device *dev = rtd->card->dev;
++	unsigned int fmt;
++	int ret;
++
++	dev_dbg(dev, "init\n");
++
++	fmt = SND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_NB_NF |
++	      SND_SOC_DAIFMT_CBS_CFS;
++
++	/* set cpu DAI configuration */
++	ret = snd_soc_dai_set_fmt(cpu_dai, fmt);
++	if (ret < 0)
++		return ret;
++
++	/* set codec DAI configuration */
++	ret = snd_soc_dai_set_fmt(codec_dai, fmt);
++	if (ret < 0)
++		return ret;
++
++	/* Don't let codec constraints interfere */
++	ret = snd_soc_dai_set_sysclk(codec_dai, WM8731_SYSCLK_MCLK,
++		0, SND_SOC_CLOCK_OUT);
++	if (ret < 0) {
++		dev_err(dev, "Failed to set WM8731 SYSCLK: %d\n", ret);
++		return ret;
++	}
++
++	return 0;
++}
++
++static struct snd_soc_dai_link de1soc_dai = {
++	.name = "WM8731",
++	.stream_name = "WM8731 PCM",
++	.cpu_dai_name = "ff200000.i2s",
++	.codec_dai_name = "wm8731-hifi",
++	.init = de1soc_wm8731_init,
++	.platform_name = "de1soc",
++	.codec_name = "wm8731.0-001a",
++	.ops = &de1soc_ops,
++};
++
++static struct snd_soc_card snd_soc_de1soc = {
++	.name = "DE1SOC-WM8731",
++	.owner = THIS_MODULE,
++	.dai_link = &de1soc_dai,
++	.num_links = 1,
++
++	.dapm_widgets = de1soc_dapm_widgets,
++	.num_dapm_widgets = ARRAY_SIZE(de1soc_dapm_widgets),
++	.dapm_routes = intercon,
++	.num_dapm_routes = ARRAY_SIZE(intercon),
++};
++
++static int de1soc_audio_probe(struct platform_device *pdev)
++{
++	struct device_node *np = pdev->dev.of_node;
++	struct device_node *codec_np, *cpu_np;
++	struct snd_soc_card *card = &snd_soc_de1soc;
++	int ret;
++
++	if (!np) {
++		return -ENODEV;
++	}
++
++	card->dev = &pdev->dev;
++
++	/* I2C bus is muxed between HPS and FPGA. Set mux to HPS */
++	i2c_mux_gpio = of_get_named_gpio(np, "i2c-mux-gpio", 0);
++	if (gpio_is_valid(i2c_mux_gpio)) {
++		ret = devm_gpio_request_one(&pdev->dev,
++			i2c_mux_gpio, GPIOF_OUT_INIT_LOW, "I2C_MUX");
++		if (ret) {
++			dev_err(&pdev->dev,
++				"Failed to request GPIO_%d for i2c_mux: %d\n",
++				i2c_mux_gpio, ret);
++			return ret;
++		}
++		gpio_set_value(i2c_mux_gpio, 1);
++	}
++
++	/* Parse codec info */
++	de1soc_dai.codec_name = NULL;
++	codec_np = of_parse_phandle(np, "audio-codec", 0);
++	if (!codec_np) {
++		dev_err(&pdev->dev, "codec info missing\n");
++		return -EINVAL;
++	}
++	de1soc_dai.codec_of_node = codec_np;
++
++	/* Parse dai and platform info */
++	de1soc_dai.cpu_dai_name = NULL;
++	de1soc_dai.platform_name = NULL;
++	cpu_np = of_parse_phandle(np, "i2s-controller", 0);
++	if (!cpu_np) {
++		dev_err(&pdev->dev, "dai and pcm info missing\n");
++		return -EINVAL;
++	}
++	de1soc_dai.cpu_of_node = cpu_np;
++	de1soc_dai.platform_of_node = cpu_np;
++
++	of_node_put(codec_np);
++	of_node_put(cpu_np);
++
++	ret = snd_soc_register_card(card);
++	if (ret) {
++		dev_err(&pdev->dev, "snd_soc_register_card() failed\n");
++	}
++
++	return ret;
++}
++
++static int de1soc_audio_remove(struct platform_device *pdev)
++{
++	struct snd_soc_card *card = platform_get_drvdata(pdev);
++
++	if (gpio_is_valid(i2c_mux_gpio))
++		devm_gpio_free(&pdev->dev, i2c_mux_gpio);
++
++	snd_soc_unregister_card(card);
++
++	return 0;
++}
++
++static const struct of_device_id de1soc_wm8731_dt_ids[] = {
++	{ .compatible = "opencores,de1soc-wm8731-audio", },
++	{ }
++};
++MODULE_DEVICE_TABLE(of, de1soc_wm8731_dt_ids);
++
++static struct platform_driver de1soc_audio_driver = {
++	.driver = {
++		.name	= "de1soc-audio",
++		.owner	= THIS_MODULE,
++		.of_match_table = of_match_ptr(de1soc_wm8731_dt_ids),
++	},
++	.probe	= de1soc_audio_probe,
++	.remove	= de1soc_audio_remove,
++};
++
++module_platform_driver(de1soc_audio_driver);
++
++/* Module information */
++MODULE_AUTHOR("Bjarne Steinsbo <bsteinsbo@gmail.com>");
++MODULE_DESCRIPTION("ALSA SoC DE1-SoC_WM8731");
++MODULE_LICENSE("GPL");
+-- 
+2.7.4
+
diff --git a/SD-Image-Gen/patches/socfpga-4.9.76-ltsi-rt-changeset.patch b/SD-Image-Gen/patches/socfpga-4.9.76-ltsi-rt-changeset.patch
index 1e8bc13..4540ce3 100644
--- a/SD-Image-Gen/patches/socfpga-4.9.76-ltsi-rt-changeset.patch
+++ b/SD-Image-Gen/patches/socfpga-4.9.76-ltsi-rt-changeset.patch
@@ -1,7 +1,7 @@
-From 753ed154e5ec9bb74e8cfbc2191e06d88edb7dfd Mon Sep 17 00:00:00 2001
+From 8436e6d11733f7722c649f5ab656422cfbc77e9d Mon Sep 17 00:00:00 2001
 From: Michael Brown <producer@holotronic.dk>
 Date: Wed, 7 Mar 2018 14:14:18 +0100
-Subject: [PATCH 01/18] disable debug package gen
+Subject: [PATCH 01/23] disable debug package gen
 
 Signed-off-by: Michael Brown <producer@holotronic.dk>
 ---
@@ -25,10 +25,10 @@ index 5c8c02f..31148aa 100644
 2.7.4
 
 
-From 72b399286411702969d7c125e80556c75be5be5a Mon Sep 17 00:00:00 2001
+From f5e04b4bf29c5c9b8ae8fe195bb31de79f57cf81 Mon Sep 17 00:00:00 2001
 From: Michael Brown <producer@holotronic.dk>
 Date: Tue, 1 May 2018 16:02:19 +0200
-Subject: [PATCH 02/18] Remove gittag from kernel (file) name(s)
+Subject: [PATCH 02/23] Remove gittag from kernel (file) name(s)
 
 Signed-off-by: Michael Brown <producer@holotronic.dk>
 ---
@@ -48,10 +48,10 @@ index 31148aa..d5758c6 100644
 2.7.4
 
 
-From 92122fd2c48ad2f375b5ac902a0d8dd473da33e7 Mon Sep 17 00:00:00 2001
+From 846ba91a9e0ace87e89bc3ef43a5a50276c602d8 Mon Sep 17 00:00:00 2001
 From: Michael Brown <producer@holotronic.dk>
 Date: Wed, 7 Mar 2018 14:21:56 +0100
-Subject: [PATCH 03/18] add ext4 root fs support and autofs4 module
+Subject: [PATCH 03/23] add ext4 root fs support and autofs4 module
 
 Signed-off-by: Michael Brown <producer@holotronic.dk>
 ---
@@ -87,10 +87,10 @@ index d5758c6..5ac78d2 100644
 2.7.4
 
 
-From 6750877c0d2f8d926371e082a92bd0b8ddd713fe Mon Sep 17 00:00:00 2001
+From 9b9b15cf7dc4fc65305c1e83d3b21be1792f2bb8 Mon Sep 17 00:00:00 2001
 From: Michael Brown <producer@holotronic.dk>
 Date: Wed, 7 Mar 2018 14:26:50 +0100
-Subject: [PATCH 04/18] add .dtd files to kernel-image .deb
+Subject: [PATCH 04/23] add .dtd files to kernel-image .deb
 
 Signed-off-by: Michael Brown <producer@holotronic.dk>
 ---
@@ -125,10 +125,10 @@ index 3c575cd0..d67c791 100755
 2.7.4
 
 
-From 56da1f23868444b69807ed2be18c34555d34d59d Mon Sep 17 00:00:00 2001
+From 5dddb22b4ddfad71e67e9447056a3fefe9885a8f Mon Sep 17 00:00:00 2001
 From: Michael Brown <producer@holotronic.dk>
 Date: Wed, 7 Mar 2018 14:33:44 +0100
-Subject: [PATCH 05/18] add generate /boot/extlinux/extlinux.conf and
+Subject: [PATCH 05/23] add generate /boot/extlinux/extlinux.conf and
  /boot/uEnv.txt for uboot boot info
 
 Signed-off-by: Michael Brown <producer@holotronic.dk>
@@ -172,10 +172,10 @@ index d67c791..d6a4058 100755
 2.7.4
 
 
-From 21c4c40eefc2114c91f11b4ce128a04069271d77 Mon Sep 17 00:00:00 2001
+From e5c216b26feb274bd10a4513675867cc1bee7e09 Mon Sep 17 00:00:00 2001
 From: Michael Brown <producer@holotronic.dk>
 Date: Wed, 7 Mar 2018 15:43:11 +0100
-Subject: [PATCH 06/18] add configfs and fpgacfg dts entities, and dynamic dts
+Subject: [PATCH 06/23] add configfs and fpgacfg dts entities, and dynamic dts
  overlay support
 
 Signed-off-by: Michael Brown <producer@holotronic.dk>
@@ -212,10 +212,10 @@ index 5ac78d2..44eb991 100644
 2.7.4
 
 
-From 11be59d2718ea5d5c5c2a246fcbb4bdf94e39cd1 Mon Sep 17 00:00:00 2001
+From f6f71473dbf253e78020ec251a55a186f1e4095c Mon Sep 17 00:00:00 2001
 From: Michael Brown <producer@holotronic.dk>
 Date: Sat, 10 Mar 2018 12:55:03 +0100
-Subject: [PATCH 07/18] rename kernel package names to *-socfpga-rt-ltsi
+Subject: [PATCH 07/23] rename kernel package names to *-socfpga-rt-ltsi
 
 Signed-off-by: Michael Brown <producer@holotronic.dk>
 ---
@@ -243,10 +243,10 @@ index d6a4058..ee58811 100755
 2.7.4
 
 
-From 0794b2392204b60e5a1623df37c38b9c2b88dce1 Mon Sep 17 00:00:00 2001
+From ef472e6e5c416c0f4770c7966bf8b4a46d717154 Mon Sep 17 00:00:00 2001
 From: Michael Brown <producer@holotronic.dk>
 Date: Mon, 21 May 2018 13:19:43 +0200
-Subject: [PATCH 08/18] Enable bridges in dtb's
+Subject: [PATCH 08/23] Enable bridges in dtb's
 
 Signed-off-by: Michael Brown <producer@holotronic.dk>
 ---
@@ -277,10 +277,10 @@ index 595eb4f..3de276d 100644
 2.7.4
 
 
-From 78459a1ede4eb877df7b40fbfd2cd3462b002c11 Mon Sep 17 00:00:00 2001
+From 20ea6c604d6609dd913baa92228f9f8a23071e07 Mon Sep 17 00:00:00 2001
 From: Michael Brown <producer@holotronic.dk>
 Date: Sat, 10 Mar 2018 13:13:12 +0100
-Subject: [PATCH 09/18] add spidev in dts so driver is loaded
+Subject: [PATCH 09/23] add spidev in dts so driver is loaded
 
 Signed-off-by: Michael Brown <producer@holotronic.dk>
 ---
@@ -314,10 +314,10 @@ index 3de276d..dce1143 100644
 2.7.4
 
 
-From 068034f918fec37aae2427525d0d3a04592be91d Mon Sep 17 00:00:00 2001
+From 7d29dc2bf5391ce41cd1fb15503e2ec45c92a6b1 Mon Sep 17 00:00:00 2001
 From: Michael Brown <producer@holotronic.dk>
 Date: Mon, 12 Mar 2018 23:41:23 +0100
-Subject: [PATCH 10/18] set ACL secutity
+Subject: [PATCH 10/23] set ACL secutity
 
 Signed-off-by: Michael Brown <producer@holotronic.dk>
 ---
@@ -357,10 +357,10 @@ index 44eb991..bce72c2 100644
 2.7.4
 
 
-From 6579de47bf736ff969168f36ec8ab2a392ba9e77 Mon Sep 17 00:00:00 2001
+From 581ac795fff1e3da0419e26d1863a0c3e91ffe5b Mon Sep 17 00:00:00 2001
 From: Michael Brown <producer@holotronic.dk>
 Date: Fri, 30 Mar 2018 20:41:53 +0200
-Subject: [PATCH 11/18] Enable altvip framebuffer
+Subject: [PATCH 11/23] Enable altvip framebuffer
 
 Signed-off-by: Michael Brown <producer@holotronic.dk>
 ---
@@ -503,10 +503,10 @@ index bce72c2..ad7ca9d 100644
 2.7.4
 
 
-From b24ca38b38542e7ba7943d24793feb6ab2c527f4 Mon Sep 17 00:00:00 2001
+From 0b31761b59f5585494d7a80cb48c0828ae74fdcf Mon Sep 17 00:00:00 2001
 From: Michael Brown <producer@holotronic.dk>
 Date: Sun, 11 Mar 2018 22:21:04 +0100
-Subject: [PATCH 12/18] Added DE-10 Nano with uio, with/without framebuffer
+Subject: [PATCH 12/23] Added DE-10 Nano with uio, with/without framebuffer
  1024x768 and 1920x1080(hd) dts dtb
 
 Signed-off-by: Michael Brown <producer@holotronic.dk>
@@ -1098,10 +1098,10 @@ index 0000000..bfb2898
 2.7.4
 
 
-From 4c317d9daddfc01549805a6af599ce5c050e5a33 Mon Sep 17 00:00:00 2001
+From 286c1bb32267da0fa8ecd531f7da0b5b8801e400 Mon Sep 17 00:00:00 2001
 From: Michael Brown <producer@holotronic.dk>
 Date: Fri, 18 May 2018 20:35:35 +0200
-Subject: [PATCH 13/18] Add framebuffer-ii core driver based on Mister, and
+Subject: [PATCH 13/23] Add framebuffer-ii core driver based on Mister, and
  enable it
 
 Signed-off-by: Michael Brown <producer@holotronic.dk>
@@ -2006,10 +2006,10 @@ index 0000000..a80ae1a
 2.7.4
 
 
-From 2b77438809b377eeda2f10be8456131f74a3012c Mon Sep 17 00:00:00 2001
+From 7cdb53a7fcacdb48d60e71273bd0fb2f98b461ad Mon Sep 17 00:00:00 2001
 From: Michael Brown <producer@holotronic.dk>
 Date: Sun, 8 Apr 2018 22:39:54 +0200
-Subject: [PATCH 14/18] Add audio and midi drivers for holosynth and builtin
+Subject: [PATCH 14/23] Add audio and midi drivers for holosynth and builtin
  audio codec on de1 board
 
 Signed-off-by: Michael Brown <producer@holotronic.dk>
@@ -4307,10 +4307,10 @@ index 0000000..1f4268c
 2.7.4
 
 
-From e111e08bc321fddc1467ae86b86333a8ecddd9a9 Mon Sep 17 00:00:00 2001
+From bc57689674b257adc6fdbfe30ed8ae5aece86ace Mon Sep 17 00:00:00 2001
 From: Michael Brown <producer@holotronic.dk>
 Date: Thu, 17 May 2018 10:58:21 +0200
-Subject: [PATCH 15/18] Add Hsynth audio driver with Phat(pcm5102) audio output
+Subject: [PATCH 15/23] Add Hsynth audio driver with Phat(pcm5102) audio output
  Add vipii fb,pidac/hsynth audio dtb for DE10 Nano HD HDMI
 
 Signed-off-by: Michael Brown <producer@holotronic.dk>
@@ -5269,10 +5269,10 @@ index 0000000..2d56f0b
 2.7.4
 
 
-From 16af1e992897ccd80cc78854bae3510aca2d1a4b Mon Sep 17 00:00:00 2001
+From 24ae5222770099e114061e4faf89f754307cb67a Mon Sep 17 00:00:00 2001
 From: Michael Brown <producer@holotronic.dk>
 Date: Fri, 4 May 2018 14:32:56 +0200
-Subject: [PATCH 16/18] add vipii framebuffer dtb for de1_soc
+Subject: [PATCH 16/23] add vipii framebuffer dtb for de1_soc
 
 Signed-off-by: Michael Brown <producer@holotronic.dk>
 ---
@@ -5588,10 +5588,10 @@ index 0000000..225e461
 2.7.4
 
 
-From e174e8a81befdc588dc3a9d5d0d1dc04627388a8 Mon Sep 17 00:00:00 2001
+From 6429aafa9d4cc9edefce18997d3a0717649837df Mon Sep 17 00:00:00 2001
 From: Michael Brown <producer@holotronic.dk>
 Date: Thu, 24 May 2018 12:18:18 +0200
-Subject: [PATCH 17/18] div codec mods
+Subject: [PATCH 17/23] div codec mods
 
 Signed-off-by: Michael Brown <producer@holotronic.dk>
 ---
@@ -5741,10 +5741,10 @@ index 2d56f0b..3011c2b 100644
 2.7.4
 
 
-From 3c0876af357dd1a1bc29c0e20b48b3180f529fba Mon Sep 17 00:00:00 2001
+From cc48f298696a05c23fcb92ff4b8e0ddb769837b8 Mon Sep 17 00:00:00 2001
 From: Michael Brown <producer@holotronic.dk>
 Date: Sat, 26 May 2018 21:36:55 +0200
-Subject: [PATCH 18/18] Change uio port name Fix: for machinekit use
+Subject: [PATCH 18/23] Change uio port name Fix: for machinekit use
 
 Signed-off-by: Michael Brown <producer@holotronic.dk>
 ---
@@ -5781,3 +5781,1574 @@ index bfb2898..f6ba2c6 100644
 -- 
 2.7.4
 
+
+From 0c3b0fac1543c1f6c36f3a220da59ff54453887a Mon Sep 17 00:00:00 2001
+From: Michael Brown <producer@holotronic.dk>
+Date: Wed, 30 May 2018 12:33:08 +0200
+Subject: [PATCH 19/23] Terasic dev boards: Make core addresses in qsys
+ devicetrees consistant
+
+Signed-off-by: Michael Brown <producer@holotronic.dk>
+---
+ .../socfpga_cyclone5_de10_nano_uio_aud_fbii_hd.dts | 16 ++---
+ .../boot/dts/socfpga_cyclone5_de10_nano_uio_fb.dts | 14 ++---
+ .../dts/socfpga_cyclone5_de10_nano_uio_fb_hd.dts   | 14 ++---
+ arch/arm/boot/dts/socfpga_cyclone5_de1_soc.dts     | 71 ++++++++++++----------
+ .../arm/boot/dts/socfpga_cyclone5_de1_soc_fbii.dts | 40 ++++++------
+ 5 files changed, 82 insertions(+), 73 deletions(-)
+
+diff --git a/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_aud_fbii_hd.dts b/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_aud_fbii_hd.dts
+index 7e1acf9..1bf0892 100644
+--- a/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_aud_fbii_hd.dts
++++ b/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_aud_fbii_hd.dts
+@@ -103,14 +103,14 @@
+ 		#address-cells = <0x2>;
+ 		#size-cells = <0x1>;
+ 		ranges = <0x00000001 0x00001000 0xff201000 0x00000008>,
+-				<0x00000001 0x00002000 0xff202000 0x00000008>,
+-				<0x00000001 0x00003000 0xff203000 0x00000010>,
+-				<0x00000001 0x00004000 0xff204000 0x00000010>,
+-				<0x00000001 0x00005000 0xff205000 0x00000010>,
+-				<0x00000001 0x00030000 0xff230000 0x00000100>,
+-				<0x00000001 0x00031000 0xff231000 0x00000080>,
+-				<0x00000001 0x00040000 0xff240000 0x00010000>,
+-				<0x00000001 0x00050000 0xff250000 0x00010000>;
++			<0x00000001 0x00002000 0xff202000 0x00000008>,
++			<0x00000001 0x00003000 0xff203000 0x00000010>,
++			<0x00000001 0x00004000 0xff204000 0x00000010>,
++			<0x00000001 0x00005000 0xff205000 0x00000010>,
++			<0x00000001 0x00030000 0xff230000 0x00000100>,
++			<0x00000001 0x00031000 0xff231000 0x00000080>,
++			<0x00000001 0x00040000 0xff240000 0x00010000>,
++			<0x00000001 0x00050000 0xff250000 0x00010000>;
+ 
+ 		sysid@0x100001000 {
+ 			compatible = "altr,sysid-15.1", "altr,sysid-1.0";
+diff --git a/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_fb.dts b/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_fb.dts
+index be476a1..c05a7f7 100644
+--- a/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_fb.dts
++++ b/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_fb.dts
+@@ -67,13 +67,13 @@
+ 		#address-cells = <0x2>;
+ 		#size-cells = <0x1>;
+ 		ranges = <0x00000001 0x00001000 0xff201000 0x00000008>,
+-				<0x00000001 0x00002000 0xff202000 0x00000008>,
+-				<0x00000001 0x00003000 0xff203000 0x00000010>,
+-				<0x00000001 0x00004000 0xff204000 0x00000010>,
+-				<0x00000001 0x00005000 0xff205000 0x00000010>,
+-				<0x00000001 0x00030000 0xff230000 0x00000100>,
+-				<0x00000001 0x00031000 0xff231000 0x00000080>,
+-				<0x00000001 0x00040000 0xff240000 0x00010000>;
++			<0x00000001 0x00002000 0xff202000 0x00000008>,
++			<0x00000001 0x00003000 0xff203000 0x00000010>,
++			<0x00000001 0x00004000 0xff204000 0x00000010>,
++			<0x00000001 0x00005000 0xff205000 0x00000010>,
++			<0x00000001 0x00030000 0xff230000 0x00000100>,
++			<0x00000001 0x00031000 0xff231000 0x00000080>,
++			<0x00000001 0x00040000 0xff240000 0x00010000>;
+ 
+ 		sysid@0x100001000 {
+ 			compatible = "altr,sysid-15.1", "altr,sysid-1.0";
+diff --git a/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_fb_hd.dts b/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_fb_hd.dts
+index f6ba2c6..ce568a0 100644
+--- a/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_fb_hd.dts
++++ b/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_fb_hd.dts
+@@ -67,13 +67,13 @@
+ 		#address-cells = <0x2>;
+ 		#size-cells = <0x1>;
+ 		ranges = <0x00000001 0x00001000 0xff201000 0x00000008>,
+-				<0x00000001 0x00002000 0xff202000 0x00000008>,
+-				<0x00000001 0x00003000 0xff203000 0x00000010>,
+-				<0x00000001 0x00004000 0xff204000 0x00000010>,
+-				<0x00000001 0x00005000 0xff205000 0x00000010>,
+-				<0x00000001 0x00030000 0xff230000 0x00000100>,
+-				<0x00000001 0x00031000 0xff231000 0x00000080>,
+-				<0x00000001 0x00040000 0xff240000 0x00010000>;
++			<0x00000001 0x00002000 0xff202000 0x00000008>,
++			<0x00000001 0x00003000 0xff203000 0x00000010>,
++			<0x00000001 0x00004000 0xff204000 0x00000010>,
++			<0x00000001 0x00005000 0xff205000 0x00000010>,
++			<0x00000001 0x00030000 0xff230000 0x00000100>,
++			<0x00000001 0x00031000 0xff231000 0x00000080>,
++			<0x00000001 0x00040000 0xff240000 0x00010000>;
+ 
+ 		sysid@0x100001000 {
+ 			compatible = "altr,sysid-15.1", "altr,sysid-1.0";
+diff --git a/arch/arm/boot/dts/socfpga_cyclone5_de1_soc.dts b/arch/arm/boot/dts/socfpga_cyclone5_de1_soc.dts
+index d2b80e6..4925f44 100644
+--- a/arch/arm/boot/dts/socfpga_cyclone5_de1_soc.dts
++++ b/arch/arm/boot/dts/socfpga_cyclone5_de1_soc.dts
+@@ -117,44 +117,34 @@
+ 		bridge-enable = <1>;
+ 		#address-cells = <0x2>;
+ 		#size-cells = <0x1>;
+-		ranges = <0x00000001 0x00020000 0xff220000 0x00000008>,
++		ranges = <0x00000001 0x00001000 0xff201000 0x00000008>,
++			<0x00000001 0x00002000 0xff202000 0x00000008>,
++			<0x00000001 0x00003000 0xff203000 0x00000010>,
++			<0x00000001 0x00004000 0xff204000 0x00000010>,
++			<0x00000001 0x00005000 0xff205000 0x00000010>,
++			<0x00000001 0x00030000 0xff230000 0x00000100>,
+ 			<0x00000001 0x00031000 0xff231000 0x00000080>,
+-			<0x00000001 0x00010000 0xff210000 0x00000008>,
+-			<0x00000001 0x000100c0 0xff2100c0 0x00000010>,
+-			<0x00000001 0x00010080 0xff210080 0x00000010>,
+-			<0x00000001 0x00010040 0xff210040 0x00000010>,
+ 			<0x00000001 0x00040000 0xff240000 0x00010000>,
+ 			<0x00000001 0x00050000 0xff250000 0x00010000>;
+ 
+-		serial@0x100020000 {
++		sysid@0x100001000 {
++			compatible = "altr,sysid-15.1", "altr,sysid-1.0";
++			reg = <0x00000001 0x00001000 0x00000008>;
++			id = <2899645186>;
++			timestamp = <1524157570>;
++		};
++
++		serial@0x100002000 {
+ 			compatible = "altr,juart-17.1", "altr,juart-1.0";
+-			reg = <0x00000001 0x00020000 0x00000008>;
++			reg = <0x00000001 0x00002000 0x00000008>;
+ 			interrupt-parent = <0x2>;
+ 			interrupts = <0 40 4>;
+ 			clocks = <0x2>;
+ 		}; //end serial@0x100020000 (jtag_uart)
+ 
+-		vip@0x100031000 {
+-			compatible = "altr,vip-frame-reader-1.0", "ALTR,vip-frame-reader-14.0";
+-			reg = <0x00000001 0x00031000 0x00000080>;
+-			max-width = <0x556>;
+-			max-height = <0x300>;
+-			bits-per-color = <0x8>;
+-			colors-per-beat = <0x4>;
+-			beats-per-pixel = <0x1>;
+-			mem-word-width = <0x80>;
+-		};
+-
+-		sysid@0x100010000 {
+-			compatible = "altr,sysid-15.1", "altr,sysid-1.0";
+-			reg = <0x00000001 0x00010000 0x00000008>;
+-			id = <2899645186>;
+-			timestamp = <1524157570>;
+-		};
+-
+-		gpio@0x1000100c0 {
++		gpio@0x100003000 {
+ 			compatible = "altr,pio-17.1", "altr,pio-1.0";
+-			reg = <0x00000001 0x000100c0 0x00000010>;
++			reg = <0x00000001 0x00003000 0x00000010>;
+ 			interrupt-parent = <0x2>;
+ 			interrupts = <0 41 1>;
+ 			clocks = <0x2>;
+@@ -168,9 +158,9 @@
+ 			gpio-controller;
+ 		}; //end gpio@0x1000100c0 (button_pio)
+ 
+-		gpio@0x100010080 {
++		gpio@0x100004000 {
+ 			compatible = "altr,pio-17.1", "altr,pio-1.0";
+-			reg = <0x00000001 0x00010080 0x00000010>;
++			reg = <0x00000001 0x00004000 0x00000010>;
+ 			interrupt-parent = <0x2>;
+ 			interrupts = <0 42 1>;
+ 			clocks = <0x2>;
+@@ -184,9 +174,9 @@
+ 			gpio-controller;
+ 		}; //end gpio@0x100010080 (dipsw_pio)
+ 
+-		gpio@0x100010040 {
++		gpio@0x100005000 {
+ 			compatible = "altr,pio-17.1", "altr,pio-1.0";
+-			reg = <0x00000001 0x00010040 0x00000010>;
++			reg = <0x00000001 0x00005000 0x00000010>;
+ 			clocks = <0x2>;
+ 			altr,gpio-bank-width = <10>;	/* embeddedsw.dts.params.altr,gpio-bank-width type NUMBER */
+ 			resetvalue = <0>;	/* embeddedsw.dts.params.resetvalue type NUMBER */
+@@ -194,6 +184,25 @@
+ 			gpio-controller;
+ 		}; //end gpio@0x100010040 (led_pio)
+ 
++		ilc@0x100030000 {
++			compatible = "altr,altera_ilc-15.1", "altr,ilc-1.0";
++			reg = <0x00000001 0x00030000 0x00000100>;
++			interrupt-controller;
++			#interrupt-cells = <0x1>;
++			altr,sw-fifo-depth = <0x20>;
++		};
++
++		vip@0x100031000 {
++			compatible = "altr,vip-frame-reader-1.0", "ALTR,vip-frame-reader-14.0";
++			reg = <0x00000001 0x00031000 0x00000080>;
++			max-width = <0x556>;
++			max-height = <0x300>;
++			bits-per-color = <0x8>;
++			colors-per-beat = <0x4>;
++			beats-per-pixel = <0x1>;
++			mem-word-width = <0x80>;
++		};
++
+ 		uio-socfpg0@0x100040000 {
+ 			compatible = "generic-uio,ui_pdrv";
+ 			reg = <0x00000001 0x00040000 0x00010000>;
+diff --git a/arch/arm/boot/dts/socfpga_cyclone5_de1_soc_fbii.dts b/arch/arm/boot/dts/socfpga_cyclone5_de1_soc_fbii.dts
+index 225e461..c6aaacc 100644
+--- a/arch/arm/boot/dts/socfpga_cyclone5_de1_soc_fbii.dts
++++ b/arch/arm/boot/dts/socfpga_cyclone5_de1_soc_fbii.dts
+@@ -117,33 +117,33 @@
+ 		bridge-enable = <1>;
+ 		#address-cells = <0x2>;
+ 		#size-cells = <0x1>;
+-		ranges = <0x00000001 0x00020000 0xff220000 0x00000008>,
+-			<0x00000001 0x00010000 0xff210000 0x00000008>,
+-			<0x00000001 0x000100c0 0xff2100c0 0x00000010>,
+-			<0x00000001 0x00010080 0xff210080 0x00000010>,
+-			<0x00000001 0x00010040 0xff210040 0x00000010>,
++		ranges = <0x00000001 0x00001000 0xff201000 0x00000008>,
++			<0x00000001 0x00002000 0xff202000 0x00000008>,
++			<0x00000001 0x00003000 0xff203000 0x00000010>,
++			<0x00000001 0x00004000 0xff204000 0x00000010>,
++			<0x00000001 0x00005000 0xff205000 0x00000010>,
+ 			<0x00000001 0x00031000 0xff231000 0x00000080>,
+ 			<0x00000001 0x00040000 0xff240000 0x00010000>,
+ 			<0x00000001 0x00050000 0xff250000 0x00010000>;
+ 
+-		serial@0x100020000 {
++		sysid@0x100001000 {
++			compatible = "altr,sysid-15.1", "altr,sysid-1.0";
++			reg = <0x00000001 0x00001000 0x00000008>;
++			id = <2899645186>;
++			timestamp = <1524157570>;
++		};
++
++		serial@0x100002000 {
+ 			compatible = "altr,juart-17.1", "altr,juart-1.0";
+-			reg = <0x00000001 0x00020000 0x00000008>;
++			reg = <0x00000001 0x00002000 0x00000008>;
+ 			interrupt-parent = <0x2>;
+ 			interrupts = <0 40 4>;
+ 			clocks = <0x2>;
+ 		}; //end serial@0x100020000 (jtag_uart)
+ 
+-		sysid@0x100010000 {
+-			compatible = "altr,sysid-15.1", "altr,sysid-1.0";
+-			reg = <0x00000001 0x00010000 0x00000008>;
+-			id = <2899645186>;
+-			timestamp = <1524157570>;
+-		};
+-
+-		gpio@0x1000100c0 {
++		gpio@0x100003000 {
+ 			compatible = "altr,pio-17.1", "altr,pio-1.0";
+-			reg = <0x00000001 0x000100c0 0x00000010>;
++			reg = <0x00000001 0x00003000 0x00000010>;
+ 			interrupt-parent = <0x2>;
+ 			interrupts = <0 41 1>;
+ 			clocks = <0x2>;
+@@ -157,9 +157,9 @@
+ 			gpio-controller;
+ 		}; //end gpio@0x1000100c0 (button_pio)
+ 
+-		gpio@0x100010080 {
++		gpio@0x100004000 {
+ 			compatible = "altr,pio-17.1", "altr,pio-1.0";
+-			reg = <0x00000001 0x00010080 0x00000010>;
++			reg = <0x00000001 0x00004000 0x00000010>;
+ 			interrupt-parent = <0x2>;
+ 			interrupts = <0 42 1>;
+ 			clocks = <0x2>;
+@@ -173,9 +173,9 @@
+ 			gpio-controller;
+ 		}; //end gpio@0x100010080 (dipsw_pio)
+ 
+-		gpio@0x100010040 {
++		gpio@0x100005000 {
+ 			compatible = "altr,pio-17.1", "altr,pio-1.0";
+-			reg = <0x00000001 0x00010040 0x00000010>;
++			reg = <0x00000001 0x00005000 0x00000010>;
+ 			clocks = <0x2>;
+ 			altr,gpio-bank-width = <10>;	/* embeddedsw.dts.params.altr,gpio-bank-width type NUMBER */
+ 			resetvalue = <0>;	/* embeddedsw.dts.params.resetvalue type NUMBER */
+-- 
+2.7.4
+
+
+From db1989353b097c1dfe6c74220247212e2a834ac8 Mon Sep 17 00:00:00 2001
+From: Michael Brown <producer@holotronic.dk>
+Date: Thu, 31 May 2018 13:46:11 +0200
+Subject: [PATCH 20/23] Test Improve dtb
+
+Signed-off-by: Michael Brown <producer@holotronic.dk>
+---
+ .../socfpga_cyclone5_de10_nano_uio_aud_fbii_hd.dts | 22 ++++++++++++++--------
+ 1 file changed, 14 insertions(+), 8 deletions(-)
+
+diff --git a/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_aud_fbii_hd.dts b/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_aud_fbii_hd.dts
+index 1bf0892..65d1a56 100644
+--- a/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_aud_fbii_hd.dts
++++ b/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_aud_fbii_hd.dts
+@@ -122,9 +122,8 @@
+ 		serial@0x100002000 {
+ 			compatible = "altr,juart-15.1", "altr,juart-1.0";
+ 			reg = <0x00000001 0x00002000 0x00000008>;
+-			interrupt-parent = <0x3>;
+-			interrupts = <0x0 0x2a 0x4>;
+-			clocks = <0x2>;
++			interrupt-parent = <&intc>;
++			interrupts = <0 40 4>;
+ 		};
+ 
+ 		gpio@0x100003000 {
+@@ -139,6 +138,8 @@
+ 		gpio@0x100004000 {
+ 			compatible = "altr,pio-15.1", "altr,pio-1.0";
+ 			reg = <0x00000001 0x00004000 0x00000010>;
++			interrupt-parent = <&intc>;
++			interrupts = <0 41 1>;
+ 			altr,gpio-bank-width = <0x4>;
+ 			altr,interrupt-type = <0x3>;
+ 			altr,interrupt_type = <0x3>;
+@@ -152,6 +153,8 @@
+ 		gpio@0x100005000 {
+ 			compatible = "altr,pio-15.1", "altr,pio-1.0";
+ 			reg = <0x00000001 0x00005000 0x00000010>;
++			interrupt-parent = <&intc>;
++			interrupts = <0 42 1>;
+ 			altr,gpio-bank-width = <0x2>;
+ 			altr,interrupt-type = <0x2>;
+ 			altr,interrupt_type = <0x2>;
+@@ -165,6 +168,9 @@
+ 		ilc@0x100030000 {
+ 			compatible = "altr,altera_ilc-15.1", "altr,ilc-1.0";
+ 			reg = <0x00000001 0x00030000 0x00000100>;
++			interrupt-parent = <&intc>;
++			interrupts = <0 0 4 0 2 1 0 1 1 0 3 4 0 4 4>;
++			interrupt-names = "jtag_uart", "button_pio", "dipsw_pio", "uioreg_io_0", "socmidi_0";
+ 			interrupt-controller;
+ 			#interrupt-cells = <0x1>;
+ 			altr,sw-fifo-depth = <0x20>;
+@@ -184,8 +190,8 @@
+ 		uio-socfpg0@0x100040000 {
+ 			compatible = "generic-uio,ui_pdrv";
+ 			reg = <0x00000001 0x00040000 0x00010000>;
+-			interrupt-parent = <0x2>;
+-			interrupts = <0 43 1>;
++			interrupt-parent = <&intc>;
++			interrupts = <0 43 4>;
+ 			address_width = <14>;
+ 			data_width = <32>;
+ 		};
+@@ -193,8 +199,8 @@
+ 		socmidi@0x100050000 {
+ 			compatible = "holotr,socsynth-midi";
+ 			reg = <0x00000001 0x00050000 0x00010000>;
+-			interrupt-parent = <0x2>;
+-/*			interrupts = <0 44 4>;*/
++			interrupt-parent = <&intc>;
++			interrupts = <0 44 4>;
+ 			address_width = <3>;   /* embeddedsw.dts.params.address_width type NUMBER */
+ 			data_width = <8>;      /* embeddedsw.dts.params.data_width type NUMBER */
+ 		};
+@@ -241,7 +247,7 @@
+ 		compatible = "adi,adxl34x";
+ 		reg = <0x53>;
+ 
+-		interrupt-parent = <&portc>;
++		interrupt-parent = <&intc>;
+ 		interrupts = <3 2>;
+ 	};
+ };
+-- 
+2.7.4
+
+
+From 75ae05513d02bf59f1bff6d65962b20d01bbd435 Mon Sep 17 00:00:00 2001
+From: Michael Brown <producer@holotronic.dk>
+Date: Thu, 31 May 2018 18:08:43 +0200
+Subject: [PATCH 21/23] Add missing .ops to synthpcm5102 codec
+
+Signed-off-by: Michael Brown <producer@holotronic.dk>
+---
+ sound/soc/codecs/hsynthpcm5102.c | 93 +++++++++++++++++++++++++++++++---------
+ 1 file changed, 72 insertions(+), 21 deletions(-)
+
+diff --git a/sound/soc/codecs/hsynthpcm5102.c b/sound/soc/codecs/hsynthpcm5102.c
+index 9791ae3..4144146 100644
+--- a/sound/soc/codecs/hsynthpcm5102.c
++++ b/sound/soc/codecs/hsynthpcm5102.c
+@@ -27,32 +27,83 @@ static const struct snd_soc_dapm_route hsynthpcm5102_routes[] = {
+ 
+ static int hsynthpcm5102_set_dai_fmt(struct snd_soc_dai *dai, unsigned int fmt)
+ {
+-    switch (fmt & SND_SOC_DAIFMT_MASTER_MASK) {
+-    case SND_SOC_DAIFMT_CBS_CFS:
+-        break;
+-    default:
+-        return -EINVAL;
+-    }
+-
+-    switch (fmt & SND_SOC_DAIFMT_INV_MASK) {
+-    case SND_SOC_DAIFMT_NB_NF:
+-        break;
+-    default:
+-        return -EINVAL;
+-    }
+-
+-    switch (fmt & SND_SOC_DAIFMT_FORMAT_MASK) {
+-    case SND_SOC_DAIFMT_I2S:
+-    case SND_SOC_DAIFMT_DSP_A:
+-        break;
+-    default:
+-        return -EINVAL;
+-    }
++//     switch (fmt & SND_SOC_DAIFMT_MASTER_MASK) {
++//     case SND_SOC_DAIFMT_CBS_CFS:
++//         break;
++//     default:
++//         return -EINVAL;
++//     }
++//
++//     switch (fmt & SND_SOC_DAIFMT_INV_MASK) {
++//     case SND_SOC_DAIFMT_NB_NF:
++//         break;
++//     default:
++//         return -EINVAL;
++//     }
++//
++//     switch (fmt & SND_SOC_DAIFMT_FORMAT_MASK) {
++//     case SND_SOC_DAIFMT_I2S:
++//     case SND_SOC_DAIFMT_DSP_A:
++//         break;
++//     default:
++//         return -EINVAL;
++//     }
+ 
+     return 0;
+ }
+ 
++static int hsynthpcm5102_hw_params(struct snd_pcm_substream *substream,
++                            struct snd_pcm_hw_params *params,
++                            struct snd_soc_dai *dai)
++{
++//     struct snd_soc_codec *codec = dai->codec;
++//     struct wm8731_priv *wm8731 = snd_soc_codec_get_drvdata(codec);
++//     u16 iface = snd_soc_read(codec, WM8731_IFACE) & 0xfff3;
++//     int i = get_coeff(wm8731->sysclk, params_rate(params));
++//     u16 srate = (coeff_div[i].sr << 2) |
++//     (coeff_div[i].bosr << 1) | coeff_div[i].usb;
++//
++//     wm8731->playback_fs = params_rate(params);
++//
++//     snd_soc_write(codec, WM8731_SRATE, srate);
++//
++//     /* bit size */
++//     switch (params_width(params)) {
++//         case 16:
++//             break;
++//         case 20:
++//             iface |= 0x0004;
++//             break;
++//         case 24:
++//             iface |= 0x0008;
++//             break;
++//         case 32:
++//             iface |= 0x000c;
++//             break;
++//     }
++//
++//     wm8731_set_deemph(codec);
++//
++//     snd_soc_write(codec, WM8731_IFACE, iface);
++    return 0;
++}
++
++static int hsynthpcm5102_startup(struct snd_pcm_substream *substream,
++                           struct snd_soc_dai *dai)
++{
++//     struct wm8731_priv *wm8731 = snd_soc_codec_get_drvdata(dai->codec);
++//
++//     if (wm8731->constraints)
++//         snd_pcm_hw_constraint_list(substream->runtime, 0,
++//                                    SNDRV_PCM_HW_PARAM_RATE,
++//                                    wm8731->constraints);
++
++        return 0;
++}
++
+ static const struct snd_soc_dai_ops hsynthpcm5102_dai_ops = {
++    .startup	= hsynthpcm5102_startup,
++    .hw_params	= hsynthpcm5102_hw_params,
+     .set_fmt = hsynthpcm5102_set_dai_fmt,
+ };
+ 
+-- 
+2.7.4
+
+
+From 5e510d8a218793c02edef33da7b7a4c78b0b17e9 Mon Sep 17 00:00:00 2001
+From: Michael Brown <producer@holotronic.dk>
+Date: Fri, 1 Jun 2018 12:52:57 +0200
+Subject: [PATCH 22/23] Make DE1x Devicetree qsys core addresses consistant
+
+Signed-off-by: Michael Brown <producer@holotronic.dk>
+---
+ .../socfpga_cyclone5_de10_nano_uio_aud_fbii_hd.dts |  6 +-
+ .../boot/dts/socfpga_cyclone5_de10_nano_uio_fb.dts | 22 +++----
+ .../dts/socfpga_cyclone5_de10_nano_uio_fb_hd.dts   | 26 ++++----
+ arch/arm/boot/dts/socfpga_cyclone5_de1_soc.dts     | 70 +++++++++++-----------
+ 4 files changed, 58 insertions(+), 66 deletions(-)
+
+diff --git a/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_aud_fbii_hd.dts b/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_aud_fbii_hd.dts
+index 65d1a56..4b8b813 100644
+--- a/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_aud_fbii_hd.dts
++++ b/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_aud_fbii_hd.dts
+@@ -133,7 +133,7 @@
+ 			resetvalue = <0xff>;
+ 			#gpio-cells = <0x2>;
+ 			gpio-controller;
+-		};
++		};// (led_pio)
+ 
+ 		gpio@0x100004000 {
+ 			compatible = "altr,pio-15.1", "altr,pio-1.0";
+@@ -148,7 +148,7 @@
+ 			resetvalue = <0x0>;
+ 			#gpio-cells = <0x2>;
+ 			gpio-controller;
+-		};
++		};// (dipsw_pio)
+ 
+ 		gpio@0x100005000 {
+ 			compatible = "altr,pio-15.1", "altr,pio-1.0";
+@@ -163,7 +163,7 @@
+ 			resetvalue = <0x0>;
+ 			#gpio-cells = <0x2>;
+ 			gpio-controller;
+-		};
++		};// (button_pio)
+ 
+ 		ilc@0x100030000 {
+ 			compatible = "altr,altera_ilc-15.1", "altr,ilc-1.0";
+diff --git a/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_fb.dts b/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_fb.dts
+index c05a7f7..cc62324 100644
+--- a/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_fb.dts
++++ b/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_fb.dts
+@@ -85,8 +85,8 @@
+ 		serial@0x100002000 {
+ 			compatible = "altr,juart-15.1", "altr,juart-1.0";
+ 			reg = <0x00000001 0x00002000 0x00000008>;
+-			interrupt-parent = <0x3>;
+-			interrupts = <0x0 0x2a 0x4>;
++			interrupt-parent = <&intc>;
++			interrupts = <0 40 4>;
+ 			clocks = <0x2>;
+ 		};
+ 
+@@ -103,6 +103,8 @@
+ 			compatible = "altr,pio-15.1", "altr,pio-1.0";
+ 			reg = <0x00000001 0x00004000 0x00000010>;
+ 			altr,gpio-bank-width = <0x4>;
++			interrupt-parent = <&intc>;
++			interrupts = <0 41 1>;
+ 			altr,interrupt-type = <0x3>;
+ 			altr,interrupt_type = <0x3>;
+ 			edge_type = <0x2>;
+@@ -115,6 +117,8 @@
+ 		gpio@0x100005000 {
+ 			compatible = "altr,pio-15.1", "altr,pio-1.0";
+ 			reg = <0x00000001 0x00005000 0x00000010>;
++			interrupt-parent = <&intc>;
++			interrupts = <0 42 1>;
+ 			altr,gpio-bank-width = <0x2>;
+ 			altr,interrupt-type = <0x2>;
+ 			altr,interrupt_type = <0x2>;
+@@ -125,14 +129,6 @@
+ 			gpio-controller;
+ 		};
+ 
+-		ilc@0x100030000 {
+-			compatible = "altr,altera_ilc-15.1", "altr,ilc-1.0";
+-			reg = <0x00000001 0x00030000 0x00000100>;
+-			interrupt-controller;
+-			#interrupt-cells = <0x1>;
+-			altr,sw-fifo-depth = <0x20>;
+-		};
+-
+ 		vip@0x100031000 {
+ 			compatible = "altr,vip-frame-reader-1.0", "ALTR,vip-frame-reader-9.1";
+ 			reg = <0x00000001 0x00031000 0x00000080>;
+@@ -147,8 +143,8 @@
+ 		hm2-socfpga0@0x100040000 {
+ 			compatible = "generic-uio,ui_pdrv";
+ 			reg = <0x00000001 0x00040000 0x00010000>;
+-			interrupt-parent = <0x2>;
+-			interrupts = <0 43 1>;
++			interrupt-parent = <&intc>;
++			interrupts = <0 43 4>;
+ 			address_width = <14>;
+ 			data_width = <32>;
+ 		};
+@@ -195,7 +191,7 @@
+ 		compatible = "adi,adxl34x";
+ 		reg = <0x53>;
+ 
+-		interrupt-parent = <&portc>;
++		interrupt-parent = <&intc>;
+ 		interrupts = <3 2>;
+ 	};
+ };
+diff --git a/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_fb_hd.dts b/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_fb_hd.dts
+index ce568a0..67bf19f 100644
+--- a/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_fb_hd.dts
++++ b/arch/arm/boot/dts/socfpga_cyclone5_de10_nano_uio_fb_hd.dts
+@@ -71,8 +71,8 @@
+ 			<0x00000001 0x00003000 0xff203000 0x00000010>,
+ 			<0x00000001 0x00004000 0xff204000 0x00000010>,
+ 			<0x00000001 0x00005000 0xff205000 0x00000010>,
+-			<0x00000001 0x00030000 0xff230000 0x00000100>,
+-			<0x00000001 0x00031000 0xff231000 0x00000080>,
++            <0x00000000 0x00010000 0xc0010000 0x00010000>,
++            <0x00000001 0x00031000 0xff231000 0x00000080>,
+ 			<0x00000001 0x00040000 0xff240000 0x00010000>;
+ 
+ 		sysid@0x100001000 {
+@@ -85,8 +85,8 @@
+ 		serial@0x100002000 {
+ 			compatible = "altr,juart-15.1", "altr,juart-1.0";
+ 			reg = <0x00000001 0x00002000 0x00000008>;
+-			interrupt-parent = <0x3>;
+-			interrupts = <0x0 0x2a 0x4>;
++			interrupt-parent = <&intc>;
++			interrupts = <0 40 4>;
+ 			clocks = <0x2>;
+ 		};
+ 
+@@ -102,6 +102,8 @@
+ 		gpio@0x100004000 {
+ 			compatible = "altr,pio-15.1", "altr,pio-1.0";
+ 			reg = <0x00000001 0x00004000 0x00000010>;
++			interrupt-parent = <&intc>;
++			interrupts = <0 41 1>;
+ 			altr,gpio-bank-width = <0x4>;
+ 			altr,interrupt-type = <0x3>;
+ 			altr,interrupt_type = <0x3>;
+@@ -115,6 +117,8 @@
+ 		gpio@0x100005000 {
+ 			compatible = "altr,pio-15.1", "altr,pio-1.0";
+ 			reg = <0x00000001 0x00005000 0x00000010>;
++			interrupt-parent = <&intc>;
++			interrupts = <0 42 1>;
+ 			altr,gpio-bank-width = <0x2>;
+ 			altr,interrupt-type = <0x2>;
+ 			altr,interrupt_type = <0x2>;
+@@ -125,14 +129,6 @@
+ 			gpio-controller;
+ 		};
+ 
+-		ilc@0x100030000 {
+-			compatible = "altr,altera_ilc-15.1", "altr,ilc-1.0";
+-			reg = <0x00000001 0x00030000 0x00000100>;
+-			interrupt-controller;
+-			#interrupt-cells = <0x1>;
+-			altr,sw-fifo-depth = <0x20>;
+-		};
+-
+ 		vip@0x100031000 {
+ 			compatible = "altr,vip-frame-reader-1.0", "ALTR,vip-frame-reader-9.1";
+ 			reg = <0x00000001 0x00031000 0x00000080>;
+@@ -147,8 +143,8 @@
+ 		hm2-socfpga0@0x100040000 {
+ 			compatible = "generic-uio,ui_pdrv";
+ 			reg = <0x00000001 0x00040000 0x00010000>;
+-			interrupt-parent = <0x2>;
+-			interrupts = <0 43 1>;
++			interrupt-parent = <&intc>;
++			interrupts = <0 43 4>;
+ 			address_width = <14>;
+ 			data_width = <32>;
+ 		};
+@@ -195,7 +191,7 @@
+ 		compatible = "adi,adxl34x";
+ 		reg = <0x53>;
+ 
+-		interrupt-parent = <&portc>;
++		interrupt-parent = <&intc>;
+ 		interrupts = <3 2>;
+ 	};
+ };
+diff --git a/arch/arm/boot/dts/socfpga_cyclone5_de1_soc.dts b/arch/arm/boot/dts/socfpga_cyclone5_de1_soc.dts
+index 4925f44..11f0a9c 100644
+--- a/arch/arm/boot/dts/socfpga_cyclone5_de1_soc.dts
++++ b/arch/arm/boot/dts/socfpga_cyclone5_de1_soc.dts
+@@ -137,56 +137,56 @@
+ 		serial@0x100002000 {
+ 			compatible = "altr,juart-17.1", "altr,juart-1.0";
+ 			reg = <0x00000001 0x00002000 0x00000008>;
+-			interrupt-parent = <0x2>;
++			interrupt-parent = <&intc>;
+ 			interrupts = <0 40 4>;
+ 			clocks = <0x2>;
+ 		}; //end serial@0x100020000 (jtag_uart)
+ 
+ 		gpio@0x100003000 {
+-			compatible = "altr,pio-17.1", "altr,pio-1.0";
++			compatible = "altr,pio-15.1", "altr,pio-1.0";
+ 			reg = <0x00000001 0x00003000 0x00000010>;
+-			interrupt-parent = <0x2>;
+-			interrupts = <0 41 1>;
+-			clocks = <0x2>;
+-			altr,gpio-bank-width = <2>;	/* embeddedsw.dts.params.altr,gpio-bank-width type NUMBER */
+-			altr,interrupt-type = <2>;	/* embeddedsw.dts.params.altr,interrupt-type type NUMBER */
+-			altr,interrupt_type = <2>;	/* embeddedsw.dts.params.altr,interrupt_type type NUMBER */
+-			edge_type = <1>;	/* embeddedsw.dts.params.edge_type type NUMBER */
+-			level_trigger = <0>;	/* embeddedsw.dts.params.level_trigger type NUMBER */
+-			resetvalue = <0>;	/* embeddedsw.dts.params.resetvalue type NUMBER */
+-			#gpio-cells = <2>;
++			altr,gpio-bank-width = <0x8>;
++			resetvalue = <0xff>;
++			#gpio-cells = <0x2>;
+ 			gpio-controller;
+-		}; //end gpio@0x1000100c0 (button_pio)
++		};// (led_pio)
+ 
+ 		gpio@0x100004000 {
+-			compatible = "altr,pio-17.1", "altr,pio-1.0";
++			compatible = "altr,pio-15.1", "altr,pio-1.0";
+ 			reg = <0x00000001 0x00004000 0x00000010>;
+-			interrupt-parent = <0x2>;
+-			interrupts = <0 42 1>;
+-			clocks = <0x2>;
+-			altr,gpio-bank-width = <10>;	/* embeddedsw.dts.params.altr,gpio-bank-width type NUMBER */
+-			altr,interrupt-type = <3>;	/* embeddedsw.dts.params.altr,interrupt-type type NUMBER */
+-			altr,interrupt_type = <3>;	/* embeddedsw.dts.params.altr,interrupt_type type NUMBER */
+-			edge_type = <2>;	/* embeddedsw.dts.params.edge_type type NUMBER */
+-			level_trigger = <0>;	/* embeddedsw.dts.params.level_trigger type NUMBER */
+-			resetvalue = <0>;	/* embeddedsw.dts.params.resetvalue type NUMBER */
+-			#gpio-cells = <2>;
++			interrupt-parent = <&intc>;
++			interrupts = <0 41 1>;
++			altr,gpio-bank-width = <0x4>;
++			altr,interrupt-type = <0x3>;
++			altr,interrupt_type = <0x3>;
++			edge_type = <0x2>;
++			level_trigger = <0x0>;
++			resetvalue = <0x0>;
++			#gpio-cells = <0x2>;
+ 			gpio-controller;
+-		}; //end gpio@0x100010080 (dipsw_pio)
++		};// (dipsw_pio)
+ 
+ 		gpio@0x100005000 {
+-			compatible = "altr,pio-17.1", "altr,pio-1.0";
++			compatible = "altr,pio-15.1", "altr,pio-1.0";
+ 			reg = <0x00000001 0x00005000 0x00000010>;
+-			clocks = <0x2>;
+-			altr,gpio-bank-width = <10>;	/* embeddedsw.dts.params.altr,gpio-bank-width type NUMBER */
+-			resetvalue = <0>;	/* embeddedsw.dts.params.resetvalue type NUMBER */
+-			#gpio-cells = <2>;
++			interrupt-parent = <&intc>;
++			interrupts = <0 42 1>;
++			altr,gpio-bank-width = <0x2>;
++			altr,interrupt-type = <0x2>;
++			altr,interrupt_type = <0x2>;
++			edge_type = <0x1>;
++			level_trigger = <0x0>;
++			resetvalue = <0x0>;
++			#gpio-cells = <0x2>;
+ 			gpio-controller;
+-		}; //end gpio@0x100010040 (led_pio)
++		};// (button_pio)
+ 
+ 		ilc@0x100030000 {
+ 			compatible = "altr,altera_ilc-15.1", "altr,ilc-1.0";
+ 			reg = <0x00000001 0x00030000 0x00000100>;
++			interrupt-parent = <&intc>;
++			interrupts = <0 0 4 0 2 1 0 1 1 0 3 4 0 4 4>;
++			interrupt-names = "jtag_uart", "button_pio", "dipsw_pio", "uioreg_io_0", "socmidi_0";
+ 			interrupt-controller;
+ 			#interrupt-cells = <0x1>;
+ 			altr,sw-fifo-depth = <0x20>;
+@@ -206,7 +206,7 @@
+ 		uio-socfpg0@0x100040000 {
+ 			compatible = "generic-uio,ui_pdrv";
+ 			reg = <0x00000001 0x00040000 0x00010000>;
+-			interrupt-parent = <0x2>;
++			interrupt-parent = <&intc>;
+ 			interrupts = <0 43 4>;
+ 			address_width = <14>;
+ 			data_width = <32>;
+@@ -215,8 +215,8 @@
+ 		socmidi@0x100050000 {
+ 			compatible = "holotr,socsynth-midi";
+ 			reg = <0x00000001 0x00050000 0x00010000>;
+-			interrupt-parent = <0x2>;
+-/*			interrupts = <0 44 4>;*/
++			interrupt-parent = <&intc>;
++			interrupts = <0 44 4>;
+ 			address_width = <3>;   /* embeddedsw.dts.params.address_width type NUMBER */
+ 			data_width = <8>;      /* embeddedsw.dts.params.data_width type NUMBER */
+ 		};
+@@ -269,7 +269,7 @@
+ 		compatible = "adi,adxl345";
+ 		reg = <0x53>;
+ 
+-		interrupt-parent = <&portc>;
++		interrupt-parent = <&intc>;
+ 		interrupts = <3 2>;
+ 	};
+ };
+-- 
+2.7.4
+
+
+From 00c5c9fd98255f383e14ccf0603c9779f3179062 Mon Sep 17 00:00:00 2001
+From: Michael Brown <producer@holotronic.dk>
+Date: Sat, 2 Jun 2018 22:56:31 +0200
+Subject: [PATCH 23/23] Add builtin audio codec driver for DE1/DE10 SoC
+ (wm8731) Add Audio and framebuffer Supporting device trees xga and hd
+ versions
+
+Signed-off-by: Michael Brown <producer@holotronic.dk>
+---
+ arch/arm/boot/dts/Makefile                         |   2 +
+ .../boot/dts/socfpga_cyclone5_de1_soc_aud_fb.dts   | 194 ++++++++++++++++
+ .../dts/socfpga_cyclone5_de1_soc_aud_fb_hd.dts     | 194 ++++++++++++++++
+ arch/arm/configs/socfpga_defconfig                 |   3 +-
+ sound/soc/socsynth/Kconfig                         |   9 +-
+ sound/soc/socsynth/Makefile                        |   5 +-
+ sound/soc/socsynth/de1x-soc-wm8731.c               | 251 +++++++++++++++++++++
+ 7 files changed, 655 insertions(+), 3 deletions(-)
+ create mode 100644 arch/arm/boot/dts/socfpga_cyclone5_de1_soc_aud_fb.dts
+ create mode 100644 arch/arm/boot/dts/socfpga_cyclone5_de1_soc_aud_fb_hd.dts
+ create mode 100644 sound/soc/socsynth/de1x-soc-wm8731.c
+
+diff --git a/arch/arm/boot/dts/Makefile b/arch/arm/boot/dts/Makefile
+index 748b068..cd54d8e 100644
+--- a/arch/arm/boot/dts/Makefile
++++ b/arch/arm/boot/dts/Makefile
+@@ -705,6 +705,8 @@ dtb-$(CONFIG_ARCH_SOCFPGA) += \
+ 	socfpga_cyclone5_de10_nano_uio_aud_fbii_hd.dtb \
+ 	socfpga_cyclone5_de10_nano.dtb \
+ 	socfpga_cyclone5_de1_soc.dtb \
++	socfpga_cyclone5_de1_soc_aud_fb.dtb \
++	socfpga_cyclone5_de1_soc_aud_fb_hd.dtb \
+ 	socfpga_cyclone5_de1_soc_fbii.dtb \
+ 	socfpga_cyclone5_sockit.dtb \
+ 	socfpga_cyclone5_socrates.dtb \
+diff --git a/arch/arm/boot/dts/socfpga_cyclone5_de1_soc_aud_fb.dts b/arch/arm/boot/dts/socfpga_cyclone5_de1_soc_aud_fb.dts
+new file mode 100644
+index 0000000..4fb724a
+--- /dev/null
++++ b/arch/arm/boot/dts/socfpga_cyclone5_de1_soc_aud_fb.dts
+@@ -0,0 +1,194 @@
++/*
++ *  Copyright (C) 2013 Steffen Trumtrar <s.trumtrar@pengutronix.de>
++ *  Copyright (C) 2016 Stephen Arnold <nerdboy@gentoo.org>
++ *
++ * This program is free software; you can redistribute it and/or modify
++ * it under the terms of the GNU General Public License as published by
++ * the Free Software Foundation; either version 2 of the License, or
++ * (at your option) any later version.
++ *
++ * This program is distributed in the hope that it will be useful,
++ * but WITHOUT ANY WARRANTY; without even the implied warranty of
++ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
++ * GNU General Public License for more details.
++ *
++ * You should have received a copy of the GNU General Public License
++ * along with this program.  If not, see <http://www.gnu.org/licenses/>.
++ */
++
++#include "socfpga_cyclone5.dtsi"
++
++/ {
++	model = "Terasic DE1-SoC";
++	compatible = "altr,socfpga-cyclone5", "altr,socfpga";
++
++	chosen {
++		bootargs = "earlyprintk";
++		stdout-path = "serial0:115200n8";
++	};
++
++	memory {
++		name = "memory";
++		device_type = "memory";
++		reg = <0x0 0x40000000>; /* 1GB */
++	};
++
++	aliases {
++		ethernet0 = &gmac1;
++	};
++
++	regulator_3_3v: 3-3-v-regulator {
++		compatible = "regulator-fixed";
++		regulator-name = "3.3V";
++		regulator-min-microvolt = <3300000>;
++		regulator-max-microvolt = <3300000>;
++	};
++
++	leds {
++		compatible = "gpio-leds";
++		hps0 {
++			label = "hps_led0";
++			gpios = <&portb 24 0>;
++			linux,default-trigger = "heartbeat";
++		};
++	};
++
++	keys {
++		compatible = "gpio-keys";
++		hps0 {
++			label = "hps_key0";
++			gpios = <&portb 25 0>;
++			linux,code = <63>;
++			debounce-interval = <50>;
++		};
++	};
++
++	sound {
++		compatible = "opencores,de1soc-wm8731-audio";
++		i2s-controller = <&i2s>;
++		audio-codec = <&wm8731>;
++		i2c-mux-gpio = <&portb 19 0>;
++	};
++
++	clk48: clk48 {
++		compatible = "fixed-clock";
++		#clock-cells = <0>;
++		clock-frequency  = <24576000>;
++		clock-output-names = "clk48";
++	};
++
++	clk44: clk44 {
++		compatible = "fixed-clock";
++		#clock-cells = <0>;
++		clock-frequency  = <33868800>;
++		clock-output-names = "clk44";
++	};
++
++	i2s: i2s@0x0 {
++		#sound-dai-cells = <1>;
++		compatible = "opencores,i2s";
++		reg = <0xff200000 0x20>, <0xff200020 0x20>;
++		clocks = <&clk44>, <&clk48>;
++		clock-names = "clk44", "clk48";
++		dmas = <&pdma 0>, <&pdma 1>;
++		dma-names = "tx", "rx";
++	};
++
++	bridge@0xc0000000 {
++		compatible = "altr,bridge-15.1", "simple-bus";
++		reg = <0xc0000000 0x20000000 0xff200000 0x200000>;
++		bridge-enable = <1>;
++		#address-cells = <0x2>;
++		#size-cells = <0x1>;
++		ranges = <0x00000001 0x00001000 0xff201000 0x00000008>,
++			<0x00000001 0x00031000 0xff231000 0x00000080>;
++
++		sysid@0x100001000 {
++			compatible = "altr,sysid-15.1", "altr,sysid-1.0";
++			reg = <0x00000001 0x00001000 0x00000008>;
++			id = <2899645186>;
++			timestamp = <1524157570>;
++		};
++
++		vip@0x100031000 {
++			compatible = "altr,vip-frame-reader-1.0", "ALTR,vip-frame-reader-14.0";
++			reg = <0x00000001 0x00031000 0x00000080>;
++			max-width = <1024>;
++			max-height = <768>;
++			bits-per-color = <0x8>;
++			colors-per-beat = <0x4>;
++			beats-per-pixel = <0x1>;
++			mem-word-width = <0x80>;
++		};
++	};
++};
++
++&gmac1 {
++	status = "okay";
++	phy-mode = "rgmii";
++
++	txd0-skew-ps = <0>; /* -420ps */
++	txd1-skew-ps = <0>; /* -420ps */
++	txd2-skew-ps = <0>; /* -420ps */
++	txd3-skew-ps = <0>; /* -420ps */
++	rxd0-skew-ps = <420>; /* 0ps */
++	rxd1-skew-ps = <420>; /* 0ps */
++	rxd2-skew-ps = <420>; /* 0ps */
++	rxd3-skew-ps = <420>; /* 0ps */
++	txen-skew-ps = <0>; /* -420ps */
++	txc-skew-ps = <1860>; /* 960ps */
++	rxdv-skew-ps = <420>; /* 0ps */
++	rxc-skew-ps = <1680>; /* 780ps */
++
++	max-frame-size = <3800>;
++};
++
++&gpio0 {
++	status = "okay";
++};
++
++&gpio1 {
++	status = "okay";
++};
++
++&gpio2 {
++	status = "okay";
++};
++
++&i2c0 {
++	status = "okay";
++	speed-mode = <0>;
++
++	wm8731: wm8731@34 {
++		#sound-dai-cells = <0>;
++		compatible = "wlf,wm8731";
++		reg = <0x1a>;
++	};
++
++	adxl345: adxl345@0 {
++		compatible = "adi,adxl345";
++		reg = <0x53>;
++
++		interrupt-parent = <&portc>;
++		interrupts = <3 2>;
++	};
++};
++
++&i2c1 {
++	status = "okay";
++	speed-mode = <0>;
++};
++
++&mmc0 {
++	vmmc-supply = <&regulator_3_3v>;
++	vqmmc-supply = <&regulator_3_3v>;
++	status = "okay";
++};
++
++&uart0 {
++	status = "okay";
++};
++
++&usb1 {
++	status = "okay";
++};
+diff --git a/arch/arm/boot/dts/socfpga_cyclone5_de1_soc_aud_fb_hd.dts b/arch/arm/boot/dts/socfpga_cyclone5_de1_soc_aud_fb_hd.dts
+new file mode 100644
+index 0000000..ecebb6e
+--- /dev/null
++++ b/arch/arm/boot/dts/socfpga_cyclone5_de1_soc_aud_fb_hd.dts
+@@ -0,0 +1,194 @@
++/*
++ *  Copyright (C) 2013 Steffen Trumtrar <s.trumtrar@pengutronix.de>
++ *  Copyright (C) 2016 Stephen Arnold <nerdboy@gentoo.org>
++ *
++ * This program is free software; you can redistribute it and/or modify
++ * it under the terms of the GNU General Public License as published by
++ * the Free Software Foundation; either version 2 of the License, or
++ * (at your option) any later version.
++ *
++ * This program is distributed in the hope that it will be useful,
++ * but WITHOUT ANY WARRANTY; without even the implied warranty of
++ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
++ * GNU General Public License for more details.
++ *
++ * You should have received a copy of the GNU General Public License
++ * along with this program.  If not, see <http://www.gnu.org/licenses/>.
++ */
++
++#include "socfpga_cyclone5.dtsi"
++
++/ {
++	model = "Terasic DE1-SoC";
++	compatible = "altr,socfpga-cyclone5", "altr,socfpga";
++
++	chosen {
++		bootargs = "earlyprintk";
++		stdout-path = "serial0:115200n8";
++	};
++
++	memory {
++		name = "memory";
++		device_type = "memory";
++		reg = <0x0 0x40000000>; /* 1GB */
++	};
++
++	aliases {
++		ethernet0 = &gmac1;
++	};
++
++	regulator_3_3v: 3-3-v-regulator {
++		compatible = "regulator-fixed";
++		regulator-name = "3.3V";
++		regulator-min-microvolt = <3300000>;
++		regulator-max-microvolt = <3300000>;
++	};
++
++	leds {
++		compatible = "gpio-leds";
++		hps0 {
++			label = "hps_led0";
++			gpios = <&portb 24 0>;
++			linux,default-trigger = "heartbeat";
++		};
++	};
++
++	keys {
++		compatible = "gpio-keys";
++		hps0 {
++			label = "hps_key0";
++			gpios = <&portb 25 0>;
++			linux,code = <63>;
++			debounce-interval = <50>;
++		};
++	};
++
++	sound {
++		compatible = "opencores,de1soc-wm8731-audio";
++		i2s-controller = <&i2s>;
++		audio-codec = <&wm8731>;
++		i2c-mux-gpio = <&portb 19 0>;
++	};
++
++	clk48: clk48 {
++		compatible = "fixed-clock";
++		#clock-cells = <0>;
++		clock-frequency  = <24576000>;
++		clock-output-names = "clk48";
++	};
++
++	clk44: clk44 {
++		compatible = "fixed-clock";
++		#clock-cells = <0>;
++		clock-frequency  = <33868800>;
++		clock-output-names = "clk44";
++	};
++
++	i2s: i2s@0x0 {
++		#sound-dai-cells = <1>;
++		compatible = "opencores,i2s";
++		reg = <0xff200000 0x20>, <0xff200020 0x20>;
++		clocks = <&clk44>, <&clk48>;
++		clock-names = "clk44", "clk48";
++		dmas = <&pdma 0>, <&pdma 1>;
++		dma-names = "tx", "rx";
++	};
++
++	bridge@0xc0000000 {
++		compatible = "altr,bridge-15.1", "simple-bus";
++		reg = <0xc0000000 0x20000000 0xff200000 0x200000>;
++		bridge-enable = <1>;
++		#address-cells = <0x2>;
++		#size-cells = <0x1>;
++		ranges = <0x00000001 0x00001000 0xff201000 0x00000008>,
++			<0x00000001 0x00031000 0xff231000 0x00000080>;
++
++		sysid@0x100001000 {
++			compatible = "altr,sysid-15.1", "altr,sysid-1.0";
++			reg = <0x00000001 0x00001000 0x00000008>;
++			id = <2899645186>;
++			timestamp = <1524157570>;
++		};
++
++		vip@0x100031000 {
++			compatible = "altr,vip-frame-reader-1.0", "ALTR,vip-frame-reader-14.0";
++			reg = <0x00000001 0x00031000 0x00000080>;
++			max-width = <1920>;
++			max-height = <1080>;
++			bits-per-color = <0x8>;
++			colors-per-beat = <0x4>;
++			beats-per-pixel = <0x1>;
++			mem-word-width = <0x80>;
++		};
++	};
++};
++
++&gmac1 {
++	status = "okay";
++	phy-mode = "rgmii";
++
++	txd0-skew-ps = <0>; /* -420ps */
++	txd1-skew-ps = <0>; /* -420ps */
++	txd2-skew-ps = <0>; /* -420ps */
++	txd3-skew-ps = <0>; /* -420ps */
++	rxd0-skew-ps = <420>; /* 0ps */
++	rxd1-skew-ps = <420>; /* 0ps */
++	rxd2-skew-ps = <420>; /* 0ps */
++	rxd3-skew-ps = <420>; /* 0ps */
++	txen-skew-ps = <0>; /* -420ps */
++	txc-skew-ps = <1860>; /* 960ps */
++	rxdv-skew-ps = <420>; /* 0ps */
++	rxc-skew-ps = <1680>; /* 780ps */
++
++	max-frame-size = <3800>;
++};
++
++&gpio0 {
++	status = "okay";
++};
++
++&gpio1 {
++	status = "okay";
++};
++
++&gpio2 {
++	status = "okay";
++};
++
++&i2c0 {
++	status = "okay";
++	speed-mode = <0>;
++
++	wm8731: wm8731@34 {
++		#sound-dai-cells = <0>;
++		compatible = "wlf,wm8731";
++		reg = <0x1a>;
++	};
++
++	adxl345: adxl345@0 {
++		compatible = "adi,adxl345";
++		reg = <0x53>;
++
++		interrupt-parent = <&portc>;
++		interrupts = <3 2>;
++	};
++};
++
++&i2c1 {
++	status = "okay";
++	speed-mode = <0>;
++};
++
++&mmc0 {
++	vmmc-supply = <&regulator_3_3v>;
++	vqmmc-supply = <&regulator_3_3v>;
++	status = "okay";
++};
++
++&uart0 {
++	status = "okay";
++};
++
++&usb1 {
++	status = "okay";
++};
+diff --git a/arch/arm/configs/socfpga_defconfig b/arch/arm/configs/socfpga_defconfig
+index 25f92bd..4917baf 100644
+--- a/arch/arm/configs/socfpga_defconfig
++++ b/arch/arm/configs/socfpga_defconfig
+@@ -308,7 +308,8 @@ CONFIG_SND_SOC_SSM2602=m
+ CONFIG_SND_SOC_SSM2602_I2C=m
+ CONFIG_SND_ALOOP=m
+ CONFIG_SND_VIRMIDI=m
+-CONFIG_SND_SOC_DE1_WM8731_HSYNTH=m
++CONFIG_SND_SOC_DE1x_WM8731=m
++CONFIG_SND_SOC_DE1x_WM8731_HSYNTH=m
+ CONFIG_SND_SOC_HSYNTH_MIDI=m
+ CONFIG_SND_SOC_PCM5102A=m
+ CONFIG_SND_SOC_PCM5102_HSYNTH=m
+diff --git a/sound/soc/socsynth/Kconfig b/sound/soc/socsynth/Kconfig
+index 5d71a4e..b6b7dec 100644
+--- a/sound/soc/socsynth/Kconfig
++++ b/sound/soc/socsynth/Kconfig
+@@ -16,7 +16,7 @@ config SND_SOC_HSYNTHDMA
+          This driver can also be built as a module.  If so, the module
+          will be called hsynthdma.
+ 
+-config SND_SOC_DE1_WM8731_HSYNTH
++config SND_SOC_DE1x_WM8731_HSYNTH
+        tristate "DE1-Audio MIDI support"
+        select SND_SOC_WM8731
+        select SND_SOC_OC_I2S
+@@ -34,3 +34,10 @@ config SND_SOC_PCM5102_HSYNTH
+        select SND_SOC_OC_I2S
+        select SND_SOC_GENERIC_DMAENGINE_PCM
+        select REGMAP_MMIO
++
++config SND_SOC_DE1x_WM8731
++       tristate "DE1x-Builtin-Audio support"
++       select SND_SOC_WM8731
++       select SND_SOC_OC_I2S
++       select SND_SOC_GENERIC_DMAENGINE_PCM
++       select REGMAP_MMIO
+diff --git a/sound/soc/socsynth/Makefile b/sound/soc/socsynth/Makefile
+index 2043f43d..69fb2aa 100644
+--- a/sound/soc/socsynth/Makefile
++++ b/sound/soc/socsynth/Makefile
+@@ -2,7 +2,7 @@ snd-soc-opencores_i2s-objs := opencores_i2s.o
+ obj-$(CONFIG_SND_SOC_OC_I2S) += snd-soc-opencores_i2s.o
+ 
+ snd-de1-soc-wm8731-hsynth-objs := de1-soc-wm8731-hsynth.o
+-obj-$(CONFIG_SND_SOC_DE1_WM8731_HSYNTH) += snd-de1-soc-wm8731-hsynth.o
++obj-$(CONFIG_SND_SOC_DE1x_WM8731_HSYNTH) += snd-de1-soc-wm8731-hsynth.o
+ 
+ snd-soc-hsynthdma-objs := hsynthdma.o
+ obj-$(CONFIG_SND_SOC_HSYNTHDMA) += snd-soc-hsynthdma.o
+@@ -12,3 +12,6 @@ obj-$(CONFIG_SND_SOC_HSYNTH_MIDI) += snd-soc-hsynth-midi.o
+ 
+ snd-pcm5102-hsynth-objs := pcm5102-hsynth.o
+ obj-$(CONFIG_SND_SOC_PCM5102_HSYNTH) += snd-pcm5102-hsynth.o
++
++snd-soc-de1x-soc-wm8731-objs := de1x-soc-wm8731.o
++obj-$(CONFIG_SND_SOC_DE1x_WM8731) += snd-soc-de1x-soc-wm8731.o
+diff --git a/sound/soc/socsynth/de1x-soc-wm8731.c b/sound/soc/socsynth/de1x-soc-wm8731.c
+new file mode 100644
+index 0000000..e297ef4
+--- /dev/null
++++ b/sound/soc/socsynth/de1x-soc-wm8731.c
+@@ -0,0 +1,251 @@
++/*
++ * de1-soc-wm8731 -- SoC audio for Terasic DE1-SoC board
++ * Author: B. Steinsbo <bsteinsbo@gmail.com>
++ *
++ * Based on sam9g20_wm8731 by
++ * Sedji Gaouaou <sedji.gaouaou@atmel.com>
++ *
++ * Licensed under the GPL-2.
++ */
++
++#include <linux/module.h>
++#include <linux/kernel.h>
++#include <linux/clk.h>
++#include <linux/platform_device.h>
++#include <linux/of.h>
++#include <linux/gpio.h>
++#include <linux/of_gpio.h>
++#include <linux/uaccess.h>
++#include <linux/ioport.h>
++#include <linux/io.h>
++
++#include <sound/core.h>
++#include <sound/pcm.h>
++#include <sound/pcm_params.h>
++#include <sound/soc.h>
++#include <sound/initval.h>
++
++#define WM8731_SYSCLK_XTAL 1
++#define WM8731_SYSCLK_MCLK 2
++#define MCLK_RATE_48K 12288000 /* fs*256 */
++#define MCLK_RATE_44K 16934400 /* fs*384 */
++
++static unsigned int i2c_mux_gpio;
++
++static int de1soc_hw_params(struct snd_pcm_substream *substream,
++	struct snd_pcm_hw_params *params)
++{
++	struct snd_soc_pcm_runtime *rtd = substream->private_data;
++	struct snd_soc_dai *codec_dai = rtd->codec_dai;
++	struct device *dev = rtd->card->dev;
++	unsigned int mclk_freq;
++	int ret;
++
++	if ((params_rate(params) % 44100) == 0) {
++		mclk_freq = MCLK_RATE_44K;
++	} else if ((params_rate(params) % 48000) == 0) {
++		mclk_freq = MCLK_RATE_48K;
++	} else
++		return -EINVAL;
++
++	/* set codec mclk configuration */
++	ret = snd_soc_dai_set_sysclk(codec_dai, WM8731_SYSCLK_MCLK,
++		mclk_freq, SND_SOC_CLOCK_OUT);
++	if (ret < 0)
++		return ret;
++
++	dev_dbg(dev, "hw_params: mclk_freq=%d\n", mclk_freq);
++	return 0;
++}
++
++static void de1soc_shutdown(struct snd_pcm_substream *substream)
++{
++	struct snd_soc_pcm_runtime *rtd = substream->private_data;
++	struct snd_soc_dai *codec_dai = rtd->codec_dai;
++	struct device *dev = rtd->card->dev;
++	int ret;
++
++	dev_dbg(dev, "shutdown\n");
++	ret = snd_soc_dai_set_sysclk(codec_dai, WM8731_SYSCLK_MCLK,
++		0, SND_SOC_CLOCK_OUT);
++	if (ret < 0) {
++		dev_err(dev, "Failed to reset WM8731 SYSCLK: %d\n", ret);
++	}
++}
++
++static struct snd_soc_ops de1soc_ops = {
++	// .startup
++	.shutdown = de1soc_shutdown,
++	.hw_params = de1soc_hw_params,
++	// .hw_free
++	// .prepare
++	// .trigger
++};
++
++static const struct snd_soc_dapm_widget de1soc_dapm_widgets[] = {
++	SND_SOC_DAPM_HP("Headphone Jack", NULL),
++	SND_SOC_DAPM_MIC("Microphone Jack", NULL),
++	SND_SOC_DAPM_LINE("Line In Jack", NULL),
++	SND_SOC_DAPM_LINE("Line Out Jack", NULL),
++};
++
++static const struct snd_soc_dapm_route intercon[] = {
++	{"MICIN", NULL, "Mic Bias"},
++	{"Mic Bias", NULL, "Microphone Jack"},
++	{"LLINEIN", NULL, "Line In Jack"},
++	{"RLINEIN", NULL, "Line In Jack"},
++	{"Line Out Jack", NULL, "LOUT"},
++	{"Line Out Jack", NULL, "ROUT"},
++	{"Headphone Jack", NULL, "LHPOUT"},
++	{"Headphone Jack", NULL, "RHPOUT"},
++};
++
++static int de1soc_wm8731_init(struct snd_soc_pcm_runtime *rtd)
++{
++	struct snd_soc_dai *codec_dai = rtd->codec_dai;
++	struct snd_soc_dai *cpu_dai = rtd->cpu_dai;
++	struct device *dev = rtd->card->dev;
++	unsigned int fmt;
++	int ret;
++
++	dev_dbg(dev, "init\n");
++
++	fmt = SND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_NB_NF |
++	      SND_SOC_DAIFMT_CBS_CFS;
++
++	/* set cpu DAI configuration */
++	ret = snd_soc_dai_set_fmt(cpu_dai, fmt);
++	if (ret < 0)
++		return ret;
++
++	/* set codec DAI configuration */
++	ret = snd_soc_dai_set_fmt(codec_dai, fmt);
++	if (ret < 0)
++		return ret;
++
++	/* Don't let codec constraints interfere */
++	ret = snd_soc_dai_set_sysclk(codec_dai, WM8731_SYSCLK_MCLK,
++		0, SND_SOC_CLOCK_OUT);
++	if (ret < 0) {
++		dev_err(dev, "Failed to set WM8731 SYSCLK: %d\n", ret);
++		return ret;
++	}
++
++	return 0;
++}
++
++static struct snd_soc_dai_link de1soc_dai = {
++	.name = "WM8731",
++	.stream_name = "WM8731 PCM",
++	.cpu_dai_name = "ff200000.i2s",
++	.codec_dai_name = "wm8731-hifi",
++	.init = de1soc_wm8731_init,
++	.platform_name = "de1soc",
++	.codec_name = "wm8731.0-001a",
++	.ops = &de1soc_ops,
++};
++
++static struct snd_soc_card snd_soc_de1soc = {
++	.name = "DE1SOC-WM8731",
++	.owner = THIS_MODULE,
++	.dai_link = &de1soc_dai,
++	.num_links = 1,
++
++	.dapm_widgets = de1soc_dapm_widgets,
++	.num_dapm_widgets = ARRAY_SIZE(de1soc_dapm_widgets),
++	.dapm_routes = intercon,
++	.num_dapm_routes = ARRAY_SIZE(intercon),
++};
++
++static int de1soc_audio_probe(struct platform_device *pdev)
++{
++	struct device_node *np = pdev->dev.of_node;
++	struct device_node *codec_np, *cpu_np;
++	struct snd_soc_card *card = &snd_soc_de1soc;
++	int ret;
++
++	if (!np) {
++		return -ENODEV;
++	}
++
++	card->dev = &pdev->dev;
++
++	/* I2C bus is muxed between HPS and FPGA. Set mux to HPS */
++	i2c_mux_gpio = of_get_named_gpio(np, "i2c-mux-gpio", 0);
++	if (gpio_is_valid(i2c_mux_gpio)) {
++		ret = devm_gpio_request_one(&pdev->dev,
++			i2c_mux_gpio, GPIOF_OUT_INIT_LOW, "I2C_MUX");
++		if (ret) {
++			dev_err(&pdev->dev,
++				"Failed to request GPIO_%d for i2c_mux: %d\n",
++				i2c_mux_gpio, ret);
++			return ret;
++		}
++		gpio_set_value(i2c_mux_gpio, 1);
++	}
++
++	/* Parse codec info */
++	de1soc_dai.codec_name = NULL;
++	codec_np = of_parse_phandle(np, "audio-codec", 0);
++	if (!codec_np) {
++		dev_err(&pdev->dev, "codec info missing\n");
++		return -EINVAL;
++	}
++	de1soc_dai.codec_of_node = codec_np;
++
++	/* Parse dai and platform info */
++	de1soc_dai.cpu_dai_name = NULL;
++	de1soc_dai.platform_name = NULL;
++	cpu_np = of_parse_phandle(np, "i2s-controller", 0);
++	if (!cpu_np) {
++		dev_err(&pdev->dev, "dai and pcm info missing\n");
++		return -EINVAL;
++	}
++	de1soc_dai.cpu_of_node = cpu_np;
++	de1soc_dai.platform_of_node = cpu_np;
++
++	of_node_put(codec_np);
++	of_node_put(cpu_np);
++
++	ret = snd_soc_register_card(card);
++	if (ret) {
++		dev_err(&pdev->dev, "snd_soc_register_card() failed\n");
++	}
++
++	return ret;
++}
++
++static int de1soc_audio_remove(struct platform_device *pdev)
++{
++	struct snd_soc_card *card = platform_get_drvdata(pdev);
++
++	if (gpio_is_valid(i2c_mux_gpio))
++		devm_gpio_free(&pdev->dev, i2c_mux_gpio);
++
++	snd_soc_unregister_card(card);
++
++	return 0;
++}
++
++static const struct of_device_id de1soc_wm8731_dt_ids[] = {
++	{ .compatible = "opencores,de1soc-wm8731-audio", },
++	{ }
++};
++MODULE_DEVICE_TABLE(of, de1soc_wm8731_dt_ids);
++
++static struct platform_driver de1soc_audio_driver = {
++	.driver = {
++		.name	= "de1soc-audio",
++		.owner	= THIS_MODULE,
++		.of_match_table = of_match_ptr(de1soc_wm8731_dt_ids),
++	},
++	.probe	= de1soc_audio_probe,
++	.remove	= de1soc_audio_remove,
++};
++
++module_platform_driver(de1soc_audio_driver);
++
++/* Module information */
++MODULE_AUTHOR("Bjarne Steinsbo <bsteinsbo@gmail.com>");
++MODULE_DESCRIPTION("ALSA SoC DE1-SoC_WM8731");
++MODULE_LICENSE("GPL");
+-- 
+2.7.4
+
-- 
2.7.4

