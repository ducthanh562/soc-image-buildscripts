From ca74aafbaf7749218bd7ebf636dab449f0397218 Mon Sep 17 00:00:00 2001
From: Michael Brown <producer@holotronic.dk>
Date: Sun, 11 Mar 2018 20:02:36 +0100
Subject: [PATCH 1/5] add support for part command

Signed-off-by: Michael Brown <producer@holotronic.dk>
---
 configs/socfpga_de0_nano_soc_defconfig | 1 +
 configs/socfpga_de10_nano_defconfig    | 1 +
 configs/socfpga_de1_soc_defconfig      | 1 +
 3 files changed, 3 insertions(+)

diff --git a/configs/socfpga_de0_nano_soc_defconfig b/configs/socfpga_de0_nano_soc_defconfig
index 2787b60..a805894 100644
--- a/configs/socfpga_de0_nano_soc_defconfig
+++ b/configs/socfpga_de0_nano_soc_defconfig
@@ -44,6 +44,7 @@ CONFIG_EFI_PARTITION=y
 CONFIG_ENV_IS_IN_MMC=y
 CONFIG_SPL_DM=y
 CONFIG_DFU_MMC=y
+CONFIG_CMD_PART=y
 CONFIG_FPGA_SOCFPGA=y
 CONFIG_DM_GPIO=y
 CONFIG_DWAPB_GPIO=y
diff --git a/configs/socfpga_de10_nano_defconfig b/configs/socfpga_de10_nano_defconfig
index ecf6de3..aa9fe7e 100644
--- a/configs/socfpga_de10_nano_defconfig
+++ b/configs/socfpga_de10_nano_defconfig
@@ -38,6 +38,7 @@ CONFIG_MTDIDS_DEFAULT="nor0=ff705000.spi.0"
 CONFIG_ENV_IS_IN_MMC=y
 CONFIG_SPL_DM=y
 CONFIG_DFU_MMC=y
+CONFIG_CMD_PART=y
 CONFIG_FPGA_SOCFPGA=y
 CONFIG_DM_GPIO=y
 CONFIG_DWAPB_GPIO=y
diff --git a/configs/socfpga_de1_soc_defconfig b/configs/socfpga_de1_soc_defconfig
index 97a6c5e..bc7af51 100644
--- a/configs/socfpga_de1_soc_defconfig
+++ b/configs/socfpga_de1_soc_defconfig
@@ -39,6 +39,7 @@ CONFIG_CMD_FS_GENERIC=y
 CONFIG_MTDIDS_DEFAULT="nor0=ff705000.spi.0"
 CONFIG_ENV_IS_IN_MMC=y
 CONFIG_SPL_DM=y
+CONFIG_CMD_PART=y
 CONFIG_FPGA_SOCFPGA=y
 CONFIG_DM_GPIO=y
 CONFIG_DWAPB_GPIO=y
-- 
2.7.4


From 3e82a272e3af3ab4e3dc2e06772983816b02bf5e Mon Sep 17 00:00:00 2001
From: Michael Brown <producer@holotronic.dk>
Date: Fri, 13 Apr 2018 14:06:40 +0200
Subject: [PATCH 2/5] Add support for fw_printenv fw_setenv

Signed-off-by: Michael Brown <producer@holotronic.dk>
---
 configs/socfpga_de0_nano_soc_defconfig | 1 +
 configs/socfpga_de10_nano_defconfig    | 1 +
 configs/socfpga_de1_soc_defconfig      | 1 +
 include/configs/socfpga_common.h       | 2 +-
 4 files changed, 4 insertions(+), 1 deletion(-)

diff --git a/configs/socfpga_de0_nano_soc_defconfig b/configs/socfpga_de0_nano_soc_defconfig
index a805894..dc6a931 100644
--- a/configs/socfpga_de0_nano_soc_defconfig
+++ b/configs/socfpga_de0_nano_soc_defconfig
@@ -69,3 +69,4 @@ CONFIG_USB_GADGET_PRODUCT_NUM=0xa4a5
 CONFIG_USB_GADGET_DWC2_OTG=y
 CONFIG_USB_GADGET_DOWNLOAD=y
 CONFIG_USE_TINY_PRINTF=y
+CONFIG_FILE=y
diff --git a/configs/socfpga_de10_nano_defconfig b/configs/socfpga_de10_nano_defconfig
index aa9fe7e..0998ba6 100644
--- a/configs/socfpga_de10_nano_defconfig
+++ b/configs/socfpga_de10_nano_defconfig
@@ -63,3 +63,4 @@ CONFIG_USB_GADGET_PRODUCT_NUM=0xa4a5
 CONFIG_USB_GADGET_DWC2_OTG=y
 CONFIG_USB_GADGET_DOWNLOAD=y
 CONFIG_USE_TINY_PRINTF=y
+CONFIG_FILE=y
diff --git a/configs/socfpga_de1_soc_defconfig b/configs/socfpga_de1_soc_defconfig
index bc7af51..19e3b7b 100644
--- a/configs/socfpga_de1_soc_defconfig
+++ b/configs/socfpga_de1_soc_defconfig
@@ -57,3 +57,4 @@ CONFIG_USB_DWC2=y
 CONFIG_USB_STORAGE=y
 CONFIG_USE_TINY_PRINTF=y
 # CONFIG_EFI_LOADER is not set
+CONFIG_FILE=y
diff --git a/include/configs/socfpga_common.h b/include/configs/socfpga_common.h
index 66e7c4f..1f5dd9e 100644
--- a/include/configs/socfpga_common.h
+++ b/include/configs/socfpga_common.h
@@ -235,7 +235,7 @@ unsigned int cm_get_qspi_controller_clk_hz(void);
 /* Environment for SDMMC boot */
 #if defined(CONFIG_ENV_IS_IN_MMC) && !defined(CONFIG_ENV_OFFSET)
 #define CONFIG_SYS_MMC_ENV_DEV		0 /* device 0 */
-#define CONFIG_ENV_OFFSET		(34 * 512) /* just after the GPT */
+#define CONFIG_ENV_OFFSET		(32 * 512) /* just after the GPT */
 #endif
 
 /* Environment for QSPI boot */
-- 
2.7.4


From 5ba3d5f6e94705904d1acbe6133fda24e87ef81f Mon Sep 17 00:00:00 2001
From: Michael Brown <producer@holotronic.dk>
Date: Fri, 13 Apr 2018 23:02:14 +0200
Subject: [PATCH 3/5] Added fpga load on boot via fpgaload_on_boot=1 variable

Signed-off-by: Michael Brown <producer@holotronic.dk>
---
 include/config_distro_bootcmd.h  | 4 +++-
 include/configs/socfpga_common.h | 6 +++++-
 2 files changed, 8 insertions(+), 2 deletions(-)

diff --git a/include/config_distro_bootcmd.h b/include/config_distro_bootcmd.h
index 5c469a2..66e1065 100644
--- a/include/config_distro_bootcmd.h
+++ b/include/config_distro_bootcmd.h
@@ -336,7 +336,9 @@
 	"boot_script_dhcp=boot.scr.uimg\0" \
 	BOOTENV_BOOT_TARGETS \
 	\
-	"boot_extlinux="                                                  \
+	"boot_extlinux="                                              \
+        "if test ${fpgaload_on_boot} = 1;"                         \
+        "then run fpgaload; bridge enable; fi;"       \
 		"sysboot ${devtype} ${devnum}:${distro_bootpart} any "    \
 			"${scriptaddr} ${prefix}extlinux/extlinux.conf\0" \
 	\
diff --git a/include/configs/socfpga_common.h b/include/configs/socfpga_common.h
index 1f5dd9e..8f76934 100644
--- a/include/configs/socfpga_common.h
+++ b/include/configs/socfpga_common.h
@@ -334,9 +334,13 @@ unsigned int cm_get_qspi_controller_clk_hz(void);
 	"scriptaddr=0x02100000\0" \
 	"pxefile_addr_r=0x02200000\0" \
 	"ramdisk_addr_r=0x02300000\0" \
+	"fpgaload_on_boot=0\0" \
+	"fpgaload=mmc rescan;" \
+		"load mmc 0:${distro_bootpart} ${loadaddr} ${bitimage};" \
+		"fpga load 0 ${loadaddr} ${filesize}\0" \
 	BOOTENV
 
-#endif
+	#endif
 #endif
 
 #endif	/* __CONFIG_SOCFPGA_COMMON_H__ */
-- 
2.7.4


From 8fa6bc08459d7803851a4d5e0b54cc497b618772 Mon Sep 17 00:00:00 2001
From: Michael Brown <producer@holotronic.dk>
Date: Tue, 1 May 2018 15:37:43 +0200
Subject: [PATCH 4/5] Enable cpu DMA(0-3), fix for audio drivers

Signed-off-by: Michael Brown <producer@holotronic.dk>
---
 include/config_distro_bootcmd.h | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/include/config_distro_bootcmd.h b/include/config_distro_bootcmd.h
index 66e1065..c1ca235 100644
--- a/include/config_distro_bootcmd.h
+++ b/include/config_distro_bootcmd.h
@@ -338,7 +338,8 @@
 	\
 	"boot_extlinux="                                              \
         "if test ${fpgaload_on_boot} = 1;"                         \
-        "then run fpgaload; bridge enable; fi;"       \
+        "then run fpgaload; bridge enable;"       \
+        "mw.b 0xffd05018 0xf0; fi;"       \
 		"sysboot ${devtype} ${devnum}:${distro_bootpart} any "    \
 			"${scriptaddr} ${prefix}extlinux/extlinux.conf\0" \
 	\
-- 
2.7.4


From 2904c7e813bbefc8a1b7fecb84c2d5cdbc3bf93b Mon Sep 17 00:00:00 2001
From: Michael Brown <producer@holotronic.dk>
Date: Wed, 23 May 2018 16:49:04 +0200
Subject: [PATCH 5/5] Take fpga2sdram port 0,1 out of reset, for framebuffer
 access

Signed-off-by: Michael Brown <producer@holotronic.dk>
---
 include/config_distro_bootcmd.h | 5 +++--
 1 file changed, 3 insertions(+), 2 deletions(-)

diff --git a/include/config_distro_bootcmd.h b/include/config_distro_bootcmd.h
index c1ca235..01aeef4 100644
--- a/include/config_distro_bootcmd.h
+++ b/include/config_distro_bootcmd.h
@@ -339,8 +339,9 @@
 	"boot_extlinux="                                              \
         "if test ${fpgaload_on_boot} = 1;"                         \
         "then run fpgaload; bridge enable;"       \
-        "mw.b 0xffd05018 0xf0; fi;"       \
-		"sysboot ${devtype} ${devnum}:${distro_bootpart} any "    \
+        "mw.b 0xffd05018 0xf0;"       \
+        "mw.w 0xffc25080 0x0303; fi;"       \
+        "sysboot ${devtype} ${devnum}:${distro_bootpart} any "    \
 			"${scriptaddr} ${prefix}extlinux/extlinux.conf\0" \
 	\
 	"scan_dev_for_extlinux="                                          \
-- 
2.7.4

